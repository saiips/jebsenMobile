define(["ojs/ojcore","knockout","jquery","appController","util/data","util/appui","pages/delivery/deliveryService","pages/common/constant","util/commonhelper","ojs/ojrouter","ojs/ojknockout","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojselectcombobox","ojs/ojlistview","ojs/ojmodel","ojs/ojpagingcontrol","ojs/ojpagingcontrol-model","ojs/ojpulltorefresh","ojs/ojvalidation","ojs/ojoffcanvas"],function(e,o,r,a,t,n,s,l,i){function c(){function t(){n.showBusy(),console.log("delivery.js init() started"),console.log("isConfirmed="+a.moduleConfig.params.rootContext.isConfirmed);var e=a.moduleConfig.params.rootContext.fromPage,o=function(e,o){try{d(e,o.status)}catch(e){console.error(e),n.hideBusy()}finally{n.hideBusy(),c(),v.ready(!0),a.moduleConfig.params.rootContext.requireRefresh=!1,a.moduleConfig.params.rootContext.isConfirmed=!1,console.log("cbSuccessFn called")}},r=function(e,o){console.log("cbFailFn failed"),d(e,o.status),n.hideBusy()},t=!1;if(a.moduleConfig.params.rootContext.isConfirmed){var l=a.moduleConfig.params.rootContext.userProfile;s.refreshDeliveryByCarPlateMessage(f(l.licenseNo)).then(o,r)}else if("springboard"===e){var l=a.moduleConfig.params.rootContext.userProfile;t?s.refreshDeliveryByCarPlateMessage(f(l.licenseNo)).then(o,r):s.getDeliveryByCarPlateMessage(f(l.licenseNo)).then(o,r)}else{var i=a.moduleConfig.params.rootContext.orderNumber;t?s.refreshDeliveryHistMessage(D(i)).then(o,r):s.getDeliveryHistMessage(D(i)).then(o,r)}}function c(){var e,o=a.moduleConfig.params.rootContext.fromPage,r=a.moduleConfig.params.rootContext.userProfile,t=a.moduleConfig.params.rootContext.orderNumber;if("springboard"===o){var s=r.username,i=r.salesRole,c="",u=r.orgUnitId,d=r.licenseNo;e=l.DELIVERY_LIST_BY_CAR_PLATE_KEY+":"+s+":"+i+":"+c+":"+u+":"+d+":"+l.DELIVERY_LIST_SYNC_DATETIME}else{var s=r.username,i=r.salesRole,c="",u=r.orgUnitId,D=t;e=l.DELIVERY_LIST_KEY+":"+s+":"+i+":"+c+":"+u+":"+D+":"+l.DELIVERY_LIST_SYNC_DATETIME}var f=n.getLocalStorage(e);f&&(v.syncDatetime(f),v.showLastSyncDate(!0))}function d(r,a){if(r=Array.isArray(r)?r[0]:r,console.log("Date retrieve from backend = "+o.toJSON(r)),null!==r){var t=r[C],n=o.observableArray([]);o.utils.arrayMap(t,function(e){try{var o=i.formatStrDate(e.DELIVERY_DATE,"YYYY-MM-DDTHH:mm:ss.sssZ","DD-MMM-YYYY").toUpperCase();o==l.BLANK_DATE?e.DELIVERY_DATE="":e.DELIVERY_DATE=i.formatStrDate(e.DELIVERY_DATE,"YYYY-MM-DDTHH:mm:ss.sssZ","DD-MMM-YYYY").toUpperCase();var r=i.formatStrDate(e.LOADED_DATE,"YYYY-MM-DDTHH:mm:ss.sssZ","DD-MMM-YYYY").toUpperCase();r==l.BLANK_DATE?e.LOADED_DATE="":e.LOADED_DATE=i.formatStrDate(e.LOADED_DATE,"YYYY-MM-DDTHH:mm:ss.sssZ","DD-MMM-YYYY HH:mm").toUpperCase();var a=i.formatStrDate(e.CONFIRMED_DATE,"YYYY-MM-DDTHH:mm:ss.sssZ","DD-MMM-YYYY").toUpperCase();a==l.BLANK_DATE?e.CONFIRMED_DATE="":e.CONFIRMED_DATE=i.formatStrDate(e.CONFIRMED_DATE,"YYYY-MM-DDTHH:mm:ss.sssZ","DD-MMM-YYYY HH:mm").toUpperCase()}catch(e){}e.DELIVERY_ADDRESS="-1"==e.DELIVERY_ADDRESS?"":e.DELIVERY_ADDRESS,e.CAR_PLATE_NUMBER="-1"==e.CAR_PLATE_NUMBER?"":e.CAR_PLATE_NUMBER,"undefined"!=typeof e.DOCUMENT_TYPE&&e.DOCUMENT_TYPE||(e.DOCUMENT_TYPE=l.DOCUMENT_TYPE_DELIVERY_NOTE),n.push(e)}),v.worklistData(new e.ArrayTableDataSource(n,{idAttribute:"DELIVERY_NUMBER"})),v.allDelivery=n}}function D(e){var o=a.moduleConfig.params.rootContext.userProfile,r=JSON.stringify({InputGetShipmentListBySalesOrder:{HeaderInfo:{UserID:o.username,UserRole:o.salesRole,CallerID:""},P_ORG_ID:o.orgUnitId,P_SO_NUMBER:e}});return console.log("Delivery list payload = "+r),r}function f(e){var o=a.moduleConfig.params.rootContext.userProfile,r=null;r=o&&"undefined"!=typeof o&&"undefined"!=typeof o.orgUnitId&&o.orgUnitId?o.orgUnitId:l.ORG_UNIT_ID_BEER;var t=JSON.stringify({InputGetShipmentListByCarPlate:{HeaderInfo:{UserID:o.username,UserRole:o.salesRole,CallerID:""},P_ORG_ID:r,P_CP_NUMBER:e}});return console.log("Delivery list by car plate payload = "+t),t}function E(){var e=function(e,o){try{d(e,o.status)}catch(e){console.error(e)}finally{c(),console.log("cbSuccessFn called")}},o=function(e,o){d(e,o.status)},r=a.moduleConfig.params.rootContext.fromPage;if("springboard"===r){var t=a.moduleConfig.params.rootContext.userProfile;s.refreshDeliveryByCarPlateMessage(f(t.licenseNo)).then(e,o)}else{var n=a.moduleConfig.params.rootContext.orderNumber;s.refreshDeliveryHistMessage(D(n)).then(e,o)}}function g(e){if("undefined"!=typeof e&&e){var o=e.substring(0,1),r=(e.substring(0,4),e.indexOf("-")),a=m(o);return a>=0||r<0?a>=0?e.substring(1):e.substring(0):e}}function m(e){var o=/^[a-zA-Z]+$/;return e.match(o)?0:-1}function p(){var o=e.Translations.getTranslatedString;v.lng_delivery=o("ssa.delivery.delivery"),v.lng_documentType=o("ssa.delivery.documentType"),v.lng_deliveryNote=o("ssa.delivery.deliveryNote"),v.lng_pickup=o("ssa.delivery.pickup"),v.lng_loading=o("ssa.springboard.pickupList"),v.lng_cantMatchBarCode=o("ssa.delivery.cantMatchBarCode"),v.lng_apptitle=o("ssa.apptitle"),v.lng_searchPlaceHolder=o("ssa.header.search"),v.lng_lastSyncDate=o("ssa.header.lastSyncDate"),v.lng_primaryText=o("ssa.pullToRefreshUtils.primaryText"),v.lng_secondaryText=o("ssa.pullToRefreshUtils.secondaryText")}var v=this;console.log("DeliveryViewModel");var C="P_SHIPMENT_TBL_ITEM";v.router=a.router,v.currOrderId=o.observable(),v.allDelivery=o.observableArray(),v.worklistData=o.observable(),v.searchText=o.observable(""),v.searchText.extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}}),v.searchValueComplete=o.observable(""),v.ready=o.observable(!1),v.syncDatetime=o.observable(),v.showLastSyncDate=o.observable(!1),v.headerTitle=o.observable(),v.enableScan=o.computed(function(){var e=a.moduleConfig.params.rootContext.isCordova;if(!e)return!1;var o=a.moduleConfig.params.rootContext.fromPage,r=a.moduleConfig.params.rootContext.userProfile.salesRole;return(r==l.SR_DRIVER_JLOG||r==l.SR_DRIVER_LINDE||r==l.SR_SALE_VAN)&&"springboard"==o}),v.handleActivated=function(o){var r=o.valueAccessor().params.ojRouter.parentRouter;console.log("delivery.js parentRouter="+r.currentState().value);var a=r.getChildRouter("delivery");return a||(a=r.createChildRouter("delivery")),v.router=a.configure(function(o){if(o){var r=new e.RouterState(o,{value:o,enter:function(){v.currOrderId(o),console.log("delivery.js stateId="+o)}});return r}}),v.isVanSales()?v.headerTitle(v.lng_delivery):v.headerTitle(v.lng_loading),e.Router.sync()},v.handleBindingsApplied=function(e){var o=r("#globalBody").find(".oj-hybrid-applayout-content"),a="oj-hybrid-applayout-scrollable";o.hasClass(a)&&(r("#searchCanvas").on("ojbeforeopen",function(){o.removeClass(a)}),r("#searchCanvas").on("ojbeforeclose",function(){o.addClass(a)})),r("#searchCanvas").on("ojclose",function(){v.clearSearch()})},v.onClearSearchText=function(){v.clearSearch()},v.clearSearch=function(){var e=r("#searchProduct");e.ojInputText("option","value",""),e.ojInputText("reset"),v.searchText("")},v.toggleSearchCanvas=function(){console.log("toggleSearchCanvas triggered"),e.OffcanvasUtils.toggle(u)},v.onSearchTextChange=function(r,a){if("rawValue"===a.option){console.log("onSearchTextChange.data.value="+a.value),v.searchText(a.value);var t=new Array;0!==v.allDelivery().length&&(0===v.searchText().length?t=v.allDelivery():o.utils.arrayFilter(v.allDelivery(),function(e){var o=v.searchText().toLowerCase();e.DELIVERY_NUMBER.toLowerCase().indexOf(o)>=0&&t.push(e)})),v.worklistData(new e.ArrayTableDataSource(t,{idAttribute:"DELIVERY_NUMBER"}))}},v.optionChange=function(e,o){function t(e){r(v.allDelivery()).each(function(o,r){if(r.DELIVERY_NUMBER==e){var t=s.createDelivery(r.DELIVERY_NUMBER,r.DELIVERY_DATE,r.OUTLET_NUMBER,r.DELIVERY_ADDRESS,r.CAR_PLATE_NUMBER,r.ORDER_NUMBER,r.PAYMENT_TERM,r.DOCUMENT_TYPE,r.LOADED_DATE,r.CONFIRMED_DATE);a.moduleConfig.params.rootContext.selDeliveryProfile=t}})}"selection"===o.option&&o.value[0]&&(console.log("delivery.js ui.value="+o.value),t(o.value),a.redirect("deliveryDetail",o.value))},v.scanBarcode=function(){console.log("Barcode scan starting......"),cordova.plugins.barcodeScanner.scan(function(e){for(var o,r=0;r<v.allDelivery().length;r++){var t=v.allDelivery()[r],l=g(e.text);if(t.DELIVERY_NUMBER==l){o=s.createDelivery(t.DELIVERY_NUMBER,t.DELIVERY_DATE,t.OUTLET_NUMBER,t.DELIVERY_ADDRESS,t.CAR_PLATE_NUMBER,t.ORDER_NUMBER,t.PAYMENT_TERM,t.DOCUMENT_TYPE,t.LOADED_DATE,t.CONFIRMED_DATE),a.moduleConfig.params.rootContext.selDeliveryProfile=o;break}}o?(console.log("barcode: "+e.text),console.log("format: "+e.format),console.log("cancelled: "+e.cancelled),a.redirect("deliveryDetail",t.DELIVERY_NUMBER)):n.showMessageBox(v.lng_apptitle,v.lng_cantMatchBarCode)},function(e){alert("Scanning failed: "+e)},{preferFrontCamera:!1,showFlipCameraButton:!1,prompt:"Place a barcode inside the scan area"})},v.goBack=function(){console.log("orderId: "+a.moduleConfig.params.rootContext.orderId);var e=a.moduleConfig.params.rootContext.userProfile,o=a.moduleConfig.params.rootContext.fromPage;"springboard"===o?e.salesRole==l.SR_ADMIN?a.router.go("inputLicense"):a.router.go("springboard"):a.redirect("orderDetail",a.moduleConfig.params.rootContext.orderId)},v.dispose=function(e){v.router.dispose()},v.isVanSales=o.computed(function(){var e=a.moduleConfig.params.rootContext.userProfile;try{var o=e.salesRole;return o===l.SR_SALE_VAN}catch(e){return!1}}),p(),t(),r(document).ready(function(){e.PullToRefreshUtils.setupPullToRefresh("#listviewContainer",function(){console.log(">>>>>>>>>>>>>> setupPullToRefresh");var e=new Promise(function(e,o){v.onClearSearchText(),E(),setTimeout(function(){e()},3e3)});return e},{primaryText:v.lng_primaryText,secondaryText:v.lng_secondaryText}),r("#listview").on({ojdestroy:function(){console.log(">>>>>>>>>>>>>> ojdestroy"),e.PullToRefreshUtils.tearDownPullToRefresh("#listviewContainer")}})})}var u;return u={selector:"#searchCanvas",edge:"top",displayMode:"push",size:"63px",modality:"modeless",autoDismiss:"none"},o.bindingHandlers.searchCanvas={init:function(r,a,t){o.utils.domNodeDisposal.addDisposeCallback(r,function(){r&&e.OffcanvasUtils.close(u)})}},c});