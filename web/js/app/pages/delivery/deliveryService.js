define(["knockout","jquery","module","amplify","util/devmode","util/appui","pages/common/constant","util/commonhelper","appController"],function(e,r,t,s,i,n,o,a,l){function u(){function t(t,l){var u=r.Deferred(),E=e.utils.parseJson(t),D=E.InputGetShipmentListBySalesOrder.HeaderInfo.UserID,I=E.InputGetShipmentListBySalesOrder.HeaderInfo.UserRole,c=E.InputGetShipmentListBySalesOrder.HeaderInfo.CallerID,d=E.InputGetShipmentListBySalesOrder.P_ORG_ID,_=E.InputGetShipmentListBySalesOrder.P_SO_NUMBER,v=o.DELIVERY_LIST_KEY+":"+D+":"+I+":"+c+":"+d+":"+_;if(i.isEnabled()&&i.isOffline())return r.getJSON("js/app/pages/delivery/deliveryMock.json",function(e){setTimeout(function(){u.resolve(e,{status:200})},500)}),r.when(u);var p=n.getLocalStorage(v);return p&&!l?(console.log("[Local Storage] Delivery List - "+v),u.resolve(p,{status:200})):(console.log("[Amplify Request] Delivery List - "+v),s.request({resourceId:o.DELIVERY_LIST_KEY,success:u.resolve,error:u.reject,data:t}),n.setLocalStorage(v+":"+o.DELIVERY_LIST_SYNC_DATETIME,a.getClientCurrentDate(o.DATETIME_FORMAT).toUpperCase()),r.when(u).done(function(e,r,t){n.setLocalStorage(v,e)})),r.when(u)}function u(t,l){var u=r.Deferred(),E=e.utils.parseJson(t),D=E.InputGetShipmentListByCarPlate.HeaderInfo.UserID,I=E.InputGetShipmentListByCarPlate.HeaderInfo.UserRole,c=E.InputGetShipmentListByCarPlate.HeaderInfo.CallerID,d=E.InputGetShipmentListByCarPlate.P_ORG_ID,_=E.InputGetShipmentListByCarPlate.P_CP_NUMBER,v=o.DELIVERY_LIST_BY_CAR_PLATE_KEY+":"+D+":"+I+":"+c+":"+d+":"+_;if(i.isEnabled()&&i.isOffline())return r.getJSON("js/app/pages/delivery/deliveryMock.json",function(e){setTimeout(function(){u.resolve(e,{status:200})},500)}),r.when(u);var p=n.getLocalStorage(v);return p&&!l?(console.log("[Local Storage] Delivery List by License No - "+v),u.resolve(p,{status:200})):(console.log("[Amplify Request] Delivery List by License No - "+v),s.request({resourceId:o.DELIVERY_LIST_BY_CAR_PLATE_KEY,success:u.resolve,error:u.reject,data:t}),n.setLocalStorage(v+":"+o.DELIVERY_LIST_SYNC_DATETIME,a.getClientCurrentDate(o.DATETIME_FORMAT).toUpperCase()),r.when(u).done(function(e,r,t){n.setLocalStorage(v,e)})),r.when(u)}function E(t){var n=r.Deferred(),a=e.utils.parseJson(t),l=a.InputGetShipmentDetails.HeaderInfo.UserID,u=a.InputGetShipmentDetails.HeaderInfo.UserRole,E=a.InputGetShipmentDetails.HeaderInfo.CallerID,D=a.InputGetShipmentDetails.P_ORG_ID,I=a.InputGetShipmentDetails.P_DELIVERY_NUM,c=o.DELIVERY_DETAIL_KEY+":"+l+":"+u+":"+E+":"+D+":"+I;return i.isEnabled()&&i.isOffline()?(r.getJSON("js/app/pages/delivery/deliveryDetailMock.json",function(e){setTimeout(function(){n.resolve(e,{status:200})},500)}),r.when(n)):(console.log("[Amplify Request] Delivery Detail - "+c),s.request({resourceId:o.DELIVERY_DETAIL_KEY,success:n.resolve,error:n.reject,data:t}),r.when(n))}function D(e){var t=r.Deferred();return i.isEnabled()&&i.isOffline()?(r.getJSON("js/app/pages/delivery/confirmDeliveryMock.json",function(e){setTimeout(function(){t.resolve(e,{status:200})},500)}),r.when(t)):(s.request({resourceId:o.CONFIRM_DELIVERY_KEY,success:t.resolve,error:t.reject,data:e}),r.when(t))}function I(r,t,s,i,n){var o=[];e.utils.arrayForEach(i,function(e){if("FULL"==n){var r=e.UNIT_SELLING_PRICE*e.MAXQTY;o.push({QTY:e.MAXQTY,DELIVERY_DETAIL_ID:e.DELIVERY_DETAIL_ID,AMOUNT:r})}else{var r=e.UNIT_SELLING_PRICE*e.QTY;o.push({QTY:e.QTY,DELIVERY_DETAIL_ID:e.DELIVERY_DETAIL_ID,AMOUNT:r})}});var a=l.moduleConfig.params.rootContext.userProfile,u=JSON.stringify({InputDNRMAConfirmation:{HeaderInfo:{UserID:a.username,UserRole:a.salesRole,CallerID:""},P_DOCUMENT_TYPE:t,P_ORG_ID:r,P_DELIVERY_NUM:s,P_SHIPMENT_DETAILS_TBL:{P_SHIPMENT_DETAILS_TBL_ITEM:o}}});return u}function c(e){var t=r.Deferred(),n=o.CONFIRM_GOODS_LOADING_KEY;return i.isEnabled()&&i.isOffline()?(r.getJSON("js/app/pages/delivery/confirmGoodsLoadingMock.json",function(e){setTimeout(function(){t.resolve(e,{status:200})},500)}),r.when(t)):(console.log("[Amplify Request] Confirm Goods Loading - "+n),s.request({resourceId:n,success:t.resolve,error:t.reject,data:e}),r.when(t))}var d=function(r,t,s,i,n,o,a,l,u,E){this.delivery_no=e.observable(r),this.deliveryDate=e.observable(t),this.outletName=e.observable(s),this.deliveryAddress=e.observable(i),this.carPlateNumber=e.observable(n),this.orderNumber=e.observable(o),this.paymentTerm=e.observable(a),this.documentType=e.observable(l),this.loadedDate=e.observable(u),this.confirmedDate=e.observable(E)};this.createDelivery=function(e,r,t,s,i,n,o,a,l,u){return new d(e,r,t,s,i,n,o,a,l,u)};var _=function(r){this.documentType=e.observable(r.DOCUMENT_TYPE),this.orgUnitId=e.observable(r.ORG_UNIT_ID),this.delivery_no=e.observable(r.DELIVERY_NUMBER),this.deliveryDate=e.observable(r.DELIVERY_DATE),this.outletName=e.observable(r.OUTLET_NUMBER),this.deliveryAddress=e.observable(r.DELIVERY_ADDRESS),this.carPlateNumber=e.observable(r.CAR_PLATE_NUMBER),this.orderNumber=e.observable(r.ORDER_NUMBER),this.paymentTerm=e.observable(r.PAYMENT_TERM),this.deliveryDetail=e.observableArray(r.P_SHIPMENT_DETAILS_TBL_ITEM),this.loadedDate=e.observable(r.LOADED_DATE),this.confirmedDate=e.observable(r.CONFIRMED_DATE)};this.createDocument=function(e){return new _(e)};var v=function(r){this.id=e.observable(r.id),this.prod_desc=e.observable(r.prod_desc),this.prod_code=e.observable(r.prod_code),this.lot=e.observable(r.lot),this.price=e.observable(r.price),this.shipping_district=e.observable(r.shipping_district)};this.createDeliveryItem=function(e){return new v(e)},this.getDeliveryHistMessage=function(e){return t(e,!1)},this.refreshDeliveryHistMessage=function(e){return t(e,!0)},this.getDeliveryByCarPlateMessage=function(e){return u(e,!1)},this.refreshDeliveryByCarPlateMessage=function(e){return u(e,!0)},this.getDeliveryItemMessage=function(e){return E(e)},this.confirmDeliveryMessage=function(e){return D(e)},this.getOfflineKey=function(){var e=l.moduleConfig.params.rootContext.userProfile,r=o.SAVED_DELIVERY_KEY+":"+e.orgUnitId+":"+e.erpSalesId+":"+e.salesRole+":"+e.username+":"+e.licenseNo;return r},this.payloadDelivery=function(r){var t=JSON.stringify({DELIVERY_NUMBER:e.utils.unwrapObservable(r.delivery_no),OUTLET_NAME:e.utils.unwrapObservable(r.outletName),ORDER_NUMBER:e.utils.unwrapObservable(r.orderNumber),DELIVERY_ADDRESS:e.utils.unwrapObservable(r.deliveryAddress),DELIVERY_DATE:e.utils.unwrapObservable(r.deliveryDate),CAR_PLATE_NUMBER:e.utils.unwrapObservable(r.carPlateNumber),LOADED_DATE:e.utils.unwarapObservable(r.loadedDate),CONFIRMED_DATE:e.utils.unwarapObservable(r.confirmedDate)});return e.utils.parseJson(t)},this.getConfirmGoodsLoadingPayload=function(e,r,t,s,i){return I(e,r,t,s,i)},this.confirmGoodsLoadingMessage=function(e){return c(e)}}return new u});