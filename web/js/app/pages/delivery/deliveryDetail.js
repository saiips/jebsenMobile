define(["ojs/ojcore","knockout","jquery","appController","util/data","pages/delivery/deliveryService","pages/common/constant","util/appui","pages/common/maintenance","ojs/ojrouter","ojs/ojknockout","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojselectcombobox","ojs/ojlistview","ojs/ojmodel","ojs/ojpagingcontrol","ojs/ojpagingcontrol-model","ojs/ojpulltorefresh","ojs/ojvalidation","ojs/ojoffcanvas"],function(e,o,r,a,l,n,t,s,i){function u(){function l(){var e=a.moduleConfig.params.rootContext.selDeliveryProfile;"undefined"!=typeof e?b.headerTitle(o.utils.unwrapObservable(e.delivery_no)):b.headerTitle(b.lng_deliveryDetail);var r=0;r=p(),b.getDataSyncCount(r)}function u(){return"dataSync"==a.moduleConfig.params.rootContext.fromPage}function d(e){console.log("deliveryDetail.js init() started"),console.log("newDeliveryNumber="+e),f();var o=function(e,o){try{g(e,o.status)}catch(e){console.error(e)}finally{s.hideBusy(),console.log("cbSuccessFn called")}},r=function(e,o){console.log("cbFailFn failed"),g(e,o.status),s.hideBusy()};n.getDeliveryItemMessage(c(e)).then(o,r)}function c(e){s.showBusy();var o=a.moduleConfig.params.rootContext.userProfile,r=o.orgUnitId;"undefined"!=typeof r&&r||(r=t.ORG_UNIT_ID_BEER);var l=e,n=b.documentType();if(e.indexOf("-")>0){var i=e.split(/-(.+)/);r=i[0],l=i[1]}var u=JSON.stringify({InputGetShipmentDetails:{HeaderInfo:{UserID:o.username,UserRole:o.salesRole,CallerID:""},P_ORG_ID:r,P_DELIVERY_NUM:l,P_DOCUMENT_TYPE:n}});return console.log("Delivery Detail payload = "+u),u}function v(e){var r=o.utils.unwrapObservable(b.currDeliveryNumber),l=a.moduleConfig.params.rootContext.userProfile,n=[];o.utils.arrayForEach(b.allDeliveryItem(),function(e){var o=e.UNIT_SELLING_PRICE*e.QTY;n.push({QTY:e.QTY,DELIVERY_DETAIL_ID:e.DELIVERY_DETAIL_ID,AMOUNT:o})});var t=JSON.stringify({InputShipConfirm:{HeaderInfo:{UserID:l.username,UserRole:l.salesRole,CallerID:""},P_ORG_ID:l.orgUnitId,P_DELIVERY_ID:r,P_PAYMENT_METHOD:e,P_SHIPMENT_DETAILS_TBL:{P_SHIPMENT_DETAILS_TBL_ITEM:n}}});return t}function f(){var e=a.moduleConfig.params.rootContext.selDeliveryProfile;console.log("selDelivery="+o.toJSON(e)),b.documentType(o.utils.unwrapObservable(e.documentType)),b.documentTypeDesc("DN"==b.documentType()?b.lng_deliveryNote:b.lng_pickup);var r=o.utils.unwrapObservable(e.delivery_no);if(b.documentType()==t.DOCUMENT_TYPE_PICKUP){if(r){var l=r.split(/-(.+)/);b.orgUnitId(l[0]),b.delivery_no(l[1])}}else{var n=a.moduleConfig.params.rootContext.userProfile;b.orgUnitId(o.utils.unwrapObservable(n.orgUnitId)),b.delivery_no(r)}b.deliveryDate(o.utils.unwrapObservable(e.deliveryDate)),b.outletName(o.utils.unwrapObservable(e.outletName)),b.deliveryAddress(o.utils.unwrapObservable(e.deliveryAddress)),b.orderNumber(o.utils.unwrapObservable(e.orderNumber)),b.carPlateNumber(o.utils.unwrapObservable(e.carPlateNumber)),b.loadedDate(o.utils.unwrapObservable(e.loadedDate)),b.confirmedDate(o.utils.unwrapObservable(e.confirmedDate))}function g(e,r){if(e=Array.isArray(e)?e[0]:e,null!==e&&200==r){var l=e[D];console.log("Retrieve data = "+o.toJSON(l));var n=o.utils.parseJson(JSON.stringify(l));o.utils.arrayMap(n,function(e){e.MAXQTY=e.QTY,e.LOT_NUMBER="-1"==e.LOT_NUMBER?"":e.LOT_NUMBER,b.isDriverRole()&&(e.QTY=null),b.allDeliveryItem.push(e)});var s=a.moduleConfig.params.rootContext.userProfile.salesRole,i=a.moduleConfig.params.rootContext.fromPage;s!=t.SR_SALE_VAN&&s!=t.SR_DRIVER_JLOG&&s!=t.SR_DRIVER_LINDE||"springboard"!=i&&"dataSync"!=i?(b.buttonEnabled(!1),b.qtyModifyEnabled(!1)):(b.buttonEnabled(!0),b.qtyModifyEnabled(!0)),console.log("Delivery Items = "+o.toJSON(b.allDeliveryItem))}}function m(e){console.log("confirmLoadingDocument clicked"),console.log("paymentType = "+e);var r=i.isMaintenance();if(r)return void s.showMessageBox(b.lng_maintenance);var l=a.moduleConfig.params.rootContext.isOnline;if(!l)return void s.showMessageBox(b.lng_error_00005);if("FULL"==e){if(!confirm(b.lng_confirmProceed))return}else if(!confirm(b.lng_partialDelivery))return;s.showBusy();var t=n.getConfirmGoodsLoadingPayload(o.utils.unwrapObservable(b.orgUnitId()),b.documentType(),b.delivery_no(),b.allDeliveryItem(),e);console.log("confirm goods loading payload = "+o.toJS(t));var u=function(e,r){var l,n,t;console.log("raw data = "+o.toJSON(e));try{if(200==r.status&&null!=e)if(t=e.OutputDNRMAConfirm,l=t.ReturnStatus,n=t.ReturnMessage,"S"==l||"W"==l){s.showMessageBox(b.lng_proceedDelivery);var i=o.utils.unwrapObservable(b.orderNumber);a.moduleConfig.params.rootContext.isConfirmed=!0,a.redirect("delivery",i)}else n?s.showMessageBox(b.lng_error_00013+" "+n):s.showMessageBox(b.lng_error_00013)}catch(e){console.error(e),s.showMessageBox(b.lng_error_00014),s.hideBusy()}finally{s.hideBusy(),console.log("cbSuccessFn called")}},d=function(e,o){console.log("cbFailFn failed"),s.showMessageBox(b.lng_error_00014),s.hideBusy()};n.confirmGoodsLoadingMessage(t).then(u,d)}function y(e){console.log("confirmDelivery clicked"),console.log("paymentType = "+e);var r=i.isMaintenance();if(r)return void s.showMessageBox(b.lng_maintenance);var l=a.moduleConfig.params.rootContext.isOnline;if(!l)return void s.showMessageBox(b.lng_error_00005);if(confirm(b.lng_confirmProceed)){s.showBusy();var t=v(e);console.log("confirm delivery payload = "+o.toJS(t));var d=function(e,r){var l,n,t;try{if(200==r.status&&null!=e)if(t=e.OutputShipConfirm,l=t.ReturnStatus,n=t.ReturnMessage,"S"==l||"W"==l)if(s.showMessageBox(b.lng_proceedDelivery),u()){var i=a.moduleConfig.params.rootContext.fromPage,d=a.moduleConfig.params.rootContext.savedOrder,c=o.toJS({status:"S",data:d.data});a.moduleConfig.params.rootContext.savedOrder=c,a.go(i)}else{var v=o.utils.unwrapObservable(b.orderNumber);a.moduleConfig.params.rootContext.isConfirmed=!0,a.redirect("delivery",v)}else s.showMessageBox(b.lng_error_00013+" "+n)}catch(e){console.error(e),s.showMessageBox(b.lng_error_00014),s.hideBusy()}finally{s.hideBusy(),console.log("cbSuccessFn called")}},c=function(e,o){console.log("cbFailFn failed"),s.showMessageBox(b.lng_error_00014),s.hideBusy()};n.confirmDeliveryMessage(t).then(d,c)}}function p(){var e=n.getOfflineKey(),r=s.getLocalStorage(e);return"undefined"!=typeof r?(Array.isArray(r)||(r=o.utils.unwrapObservable(r)),0==r.length?0:r.data.length):0}function _(){var o=e.Translations.getTranslatedString;b.lng_documentType=o("ssa.delivery.documentType"),b.lng_deliveryNote=o("ssa.delivery.deliveryNote"),b.lng_pickup=o("ssa.delivery.pickup"),b.lng_deliveryDetail=o("ssa.deliveryDetail.deliveryDetail"),b.lng_shipmentDetail=o("ssa.deliveryDetail.shipmentDetail"),b.lng_overview=o("ssa.deliveryDetail.overview"),b.lng_itemDetail=o("ssa.deliveryDetail.itemDetail"),b.lng_lot=o("ssa.deliveryDetail.lot"),b.lng_qty=o("ssa.deliveryDetail.qty"),b.lng_confirm=o("ssa.deliveryDetail.confirm"),b.lng_partialConfirm=o("ssa.deliveryDetail.partialConfirm"),b.lng_confirmByCash=o("ssa.deliveryDetail.confirmByCash"),b.lng_confirmByCheque=o("ssa.deliveryDetail.confirmByCheque"),b.lng_confirmByOthers=o("ssa.deliveryDetail.confirmByOthers"),b.lng_confirmProceed=o("ssa.deliveryDetail.confirmProceed"),b.lng_proceedDelivery=o("ssa.msg.info.proceedDelivery"),b.lng_error_00005=o("ssa.msg.error.ERROR_00005"),b.lng_error_00013=o("ssa.msg.error.ERROR_00013"),b.lng_error_00014=o("ssa.msg.error.ERROR_00014"),b.lng_error_00017=o("ssa.msg.error.ERROR_00017"),b.lng_delInfoSaved=o("ssa.msg.info.delInfoSaved"),b.lng_maintenance=o("ssa.msg.info.maintenance"),b.lng_partialDelivery=o("ssa.msg.info.partialDelivery"),b.lng_originalQty=o("ssa.deliveryDetail.originalQty")}var b=this;console.log("DeliveryDetailViewModel");var D="P_SHIPMENT_DETAILS_TBL_ITEM";b.router=a.router,b.headerTitle=o.observable(),b.allDeliveryItem=o.observableArray([]),b.currDeliveryNumber=o.observable(),b.delivery_no=o.observable(),b.orgUnitId=o.observable(),b.documentType=o.observable(),b.documentTypeDesc=o.observable(),b.deliveryDate=o.observable(),b.outletName=o.observable(),b.deliveryAddress=o.observable(),b.orderNumber=o.observable(),b.carPlateNumber=o.observable(),b.loadedDate=o.observable(),b.confirmedDate=o.observable(),b.getDataSyncCount=o.observable(0),b.isCODPayment=o.computed(function(){var e=a.moduleConfig.params.rootContext.userProfile;if(e.salesRole==t.SR_DRIVER_JLOG||e.salesRole==t.SR_DRIVER_LINDE)return!1;var r=a.moduleConfig.params.rootContext.selDeliveryProfile;return o.utils.unwrapObservable(r.paymentTerm)==t.PAYMENT_TERM}),b.isDriverRole=o.computed(function(){var e=a.moduleConfig.params.rootContext.userProfile;return e.salesRole==t.SR_DRIVER_JLOG||e.salesRole==t.SR_DRIVER_LINDE}),b.buttonEnabled=o.observable(),b.qtyModifyEnabled=o.observable(),b.showEraseButton=o.computed(function(){return u()}),b.handleActivated=function(o){var r=o.valueAccessor().params.ojRouter.parentRouter;console.log("deliveryDetail.js parentRouter="+r.currentState().value);var a=r.getChildRouter("deliveryItem");return a||(a=r.createChildRouter("deliveryItem")),b.router=a.configure(function(o){if(o){var r=new e.RouterState(o,{value:o,enter:function(){b.currDeliveryNumber(o),console.log("deliveryItem.js stateId="+o)}});return r}}),_(),l(),e.Router.sync()},b.handleBindingsApplied=function(e){var o=r("#globalBody").find(".oj-hybrid-applayout-content"),a="oj-hybrid-applayout-scrollable";o.hasClass(a)&&(r("#searchCanvas").on("ojbeforeopen",function(){o.removeClass(a)}),r("#searchCanvas").on("ojbeforeclose",function(){o.addClass(a)})),r("#searchCanvas").on("ojclose",function(){b.clearSearch()})},b.currDeliveryNumber.subscribe(function(e){d(e)}),b.goBack=function(){if(u()){var e=a.moduleConfig.params.rootContext.fromPage;a.go(e)}else{var r=o.utils.unwrapObservable(b.orderNumber);console.log("orderId: "+r),a.redirect("delivery",r)}},b.dispose=function(e){b.router.dispose()},b.confirmShipment=function(){b.isDriverRole()?m("FULL"):y(null)},b.partialConfirmShipment=function(){b.isDriverRole()?m(null):y(null)},b.confirmCash=function(){b.isDriverRole()?m(null):y(t.PAY_BY_CASH)},b.confirmCheque=function(){b.isDriverRole()?m(null):y(t.PAY_BY_CHEQUE)},b.confirmOthers=function(){b.isDriverRole()?m(null):y(t.PAY_BY_OTHERS)},b.clearData=function(e,r){if(console.log("clear the offline data of delivery"),u()){var l=a.moduleConfig.params.rootContext.fromPage,n=a.moduleConfig.params.rootContext.savedOrder,t=o.toJS({status:"D",data:n.data});a.moduleConfig.params.rootContext.savedOrder=t,a.go(l)}},b.save=function(e,r){console.log("save the delivery");try{var l=a.moduleConfig.params.rootContext.selDeliveryProfile,t=!1,i=n.getOfflineKey(),u=s.getLocalStorage(i);if(console.log("storedPayload = "+o.toJSON(u)),o.isObservable(u)&&(u=o.utils.unwrapObservable(u)),u)try{t=!0;var d=u.data,c=o.utils.arrayFirst(d,function(e){return e.order.DELIVERY_NUMBER==o.utils.unwrapObservable(l.delivery_no)});c&&u.data.pop(c)}catch(e){t=!1}var v=n.payloadDelivery(l),f=[];o.utils.arrayMap(b.allDeliveryItem(),function(e){f.push(e)});var g=o.toJS({data:[{delivery:"Y",order:v,orderdetail:f}]});t?(u.data.push(o.toJS({delivery:"Y",order:v,orderdetail:f})),s.setLocalStorage(i,u)):s.setLocalStorage(i,g),s.showMessageBox(b.lng_delInfoSaved);var m=0;m=p(),b.getDataSyncCount(m)}catch(e){console.error(e),s.showMessageBox(b.lng_error_00017)}}}var d;return d={selector:"#searchCanvas",edge:"top",displayMode:"push",size:"63px",modality:"modeless",autoDismiss:"none"},u});