define(["ojs/ojcore","knockout","jquery","appController","pages/checkOut/checkOutService","pages/common/cartService","util/appui","pages/common/constant","pages/common/maintenance","pages/common/receiptService","ojs/ojrouter","ojs/ojknockout","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojselectcombobox","ojs/ojnavigationlist","promise"],function(e,r,o,t,a,n,s,i,l,u){function c(){function c(){console.log("isDataSync = "+d()),v(),m(),p(),g(),t.moduleConfig.params.rootContext.isContinuePayment||b()}function d(){return t.moduleConfig.params.rootContext.isDataSync}function m(){var e=t.moduleConfig.params.rootContext.selCustomerProfile;if("undefined"!=typeof e){var o=r.utils.unwrapObservable(e.outletName);r.utils.unwrapObservable(f.large())||o&&o.length>i.TITLE_LENGTH&&(o=o.substring(0,i.TITLE_LENGTH)+"..."),f.headerTitle(o)}else f.headerTitle("");var a=t.moduleConfig.params.rootContext.paymentParameter,n=a.PAYMENT_TYPE;n==i.PAY_BY_CASH?f.subTitle(f.lng_payByCash):n==i.PAY_BY_CHEQUE?f.subTitle(f.lng_payByCheque):n==i.PAY_BY_OTHERS?f.subTitle(f.lng_payByOthers):"-1"!=n&&"undefined"!=typeof n||f.subTitle(f.lng_payByOthers)}function p(){var e=t.moduleConfig.params.rootContext.selCustomerProfile,o=n.getOrder();f.cust_name(r.utils.unwrapObservable(o.cust_name)),f.remarks(r.utils.unwrapObservable(o.remarks)),f.delivery_cost(r.utils.unwrapObservable(o.delivery_cost)),f.shipping_address(r.utils.unwrapObservable(o.shipping_address)),f.billing_address(r.utils.unwrapObservable(o.billing_address)),f.ship_to_district(r.utils.unwrapObservable(e.shipToDistrict)),f.purchase_order(r.utils.unwrapObservable(o.purchase_order)),f.order_date(r.utils.unwrapObservable(o.order_date)),f.real_customer(r.utils.unwrapObservable(o.real_customer)),f.cust_no(r.utils.unwrapObservable(e.accountNumber)),f.outletName(r.utils.unwrapObservable(e.outletName));var a=t.moduleConfig.params.rootContext.paymentParameter;console.log("fillOrder  param = "+r.toJSON(a)),f.order_no(a.ORDER_NUMBER),f.status(a.FLOW_STATUS_CODE),f.paymentType(a.PAYMENT_TYPE)}function g(){f.cart=n.getCart(),f.subtotal=r.computed(function(){var e=0;return o(f.cart()).each(function(r,o){e+=o.cost()}),e}),f.totalItems=r.computed(function(){var e=0;return o(f.cart()).each(function(r,o){e++}),e}),f.total=r.computed(function(){var e=0;return e=new Number(f.delivery_cost())+new Number(f.subtotal())})}function _(e){s.showBusy();var o,n=r.utils.unwrapObservable(f.currHeaderId),i=function(e,a){if(console.log("cbSuccessFn"),console.log("proceedOrder raw data = "+r.toJSON(e)),null!==e&&200==a.status){s.hideBusy();var n=e[o].ReturnStatus,i=e[o].ReturnMessage;if("S"==n||"W"==n)if(s.showMessageBox(f.lng_youOrder+r.utils.unwrapObservable(f.order_no())+f.lng_received),d()){var l=t.moduleConfig.params.rootContext.savedOrder,u=r.toJS({status:"S",data:l.data});t.moduleConfig.params.rootContext.savedOrder=u,t.go("dataSync")}else{t.moduleConfig.params.rootContext.requireRefresh=!0;var c=t.moduleConfig.params.rootContext.custId;t.redirect("orderHist",c)}else s.showMessageBox(i)}},l=function(e,o){console.log("cbFailFn"),s.hideBusy(),s.showMessageBox(f.lng_youOrder+r.utils.unwrapObservable(f.order_no())+f.lng_notReceived)};if("complete"==e){o="OutputBookSalesOrder";var u=t.moduleConfig.params.rootContext.paymentParameter;a.bookSalesOrderMessage(n,u.PAYMENT_TYPE).then(i,l)}else"cancel"==e&&(o="OutputCancelSalesOrder",a.cancelSalesOrderMessage(n).then(i,l))}function b(){console.log("proceed Print");var e=(new moment).format("HH:mm"),o=t.moduleConfig.params.rootContext.userProfile.licenseNo,a=f.order_no()?f.order_no():"",n=f.paymentType(),i=r.toJS({DATE:f.order_date(),ORDER_NUMBER:a,ACCOUNT_NUMBER:f.cust_no(),TIME:e,DELIVERY_NUMBER:"N/A",CAR_PLATE_NUMBER:o,OUTLET_NAME:f.outletName(),ORDER_TOT_AMT:f.total(),PAYMENT_METHOD:n,SHIP_TO_ADDRESS:f.shipping_address(),REMARKS:f.remarks()}),l=u.getTemplate(i,f.cart());console.log("receipt = "+l);var c=u.isPrinterPaired();if(console.log("macAddress = "+c),!c)return void s.showMessageBox(f.lng_error_00038);var d=t.moduleConfig.params.rootContext.isCordova;if(!d)return void s.showMessageBox(f.lng_error_00039);var m=t.moduleConfig.params.rootContext.platform,p="iOS"==m.match(/ios/i)||"iOS"==m;console.log("Printing on iOS = "+p),p?window.plugins.CordovaPrinter.print(function(e){console.log("Receipt printed")},function(e){console.log("receipt print failed:"+e)},c,l):cordova.plugins.zbtprinter.print(c,l,function(e){console.log("Receipt printed")},function(e){console.log("receipt print failed:"+e)})}function v(){var r=e.Translations.getTranslatedString;f.lng_lastSyncDate=r("ssa.header.lastSyncDate"),f.lng_overview=r("ssa.orderDetail.overview"),f.lng_orderNo=r("ssa.orderDetail.orderNo"),f.lng_purchaseOrder=r("ssa.orderDetail.purchaseOrder"),f.lng_orderDate=r("ssa.orderDetail.orderDate"),f.lng_totalItems=r("ssa.orderDetail.totalItems"),f.lng_total=r("ssa.orderDetail.total"),f.lng_remarks=r("ssa.orderDetail.remarks"),f.lng_itemDetail=r("ssa.orderDetail.itemDetail"),f.lng_deliveryStatus=r("ssa.orderDetail.deliveryStatus"),f.lng_lot=r("ssa.orderDetail.lot"),f.lng_qty=r("ssa.orderDetail.qty"),f.lng_deliveryCost=r("ssa.orderDetail.deliveryCost"),f.lng_orderSummary=r("ssa.orderDetail.orderSummary"),f.lng_shippingAddress=r("ssa.orderDetail.shippingAddress"),f.lng_billingAddress=r("ssa.orderDetail.billingAddress"),f.lng_confirmPlaceOrder=r("ssa.checkOut.confirmProceed"),f.lng_completeOrder=r("ssa.checkOut.payment.completeOrder"),f.lng_cancelOrder=r("ssa.checkOut.payment.cancelOrder"),f.lng_payByCash=r("ssa.checkOut.payByCash"),f.lng_payByCheque=r("ssa.checkOut.payByCheque"),f.lng_payByOthers=r("ssa.checkOut.payByOthers"),f.lng_realCustomer=r("ssa.checkOut.realCustomer"),f.lng_youOrder=r("ssa.checkOut.payment.youOrder"),f.lng_received=r("ssa.checkOut.payment.received"),f.lng_notReceived=r("ssa.checkOut.payment.notReceived"),f.lng_maintenance=r("ssa.msg.info.maintenance"),f.lng_confirmPrint=r("ssa.checkOut.payment.confirmPrint"),f.lng_error_00038=r("ssa.msg.error.ERROR_00038"),f.lng_error_00039=r("ssa.msg.error.ERROR_00039")}var f=this;console.log("PaymentViewModel"),f.router=t.router,f.cust_no=r.observable(),f.outletName=r.observable(),f.paymentType=r.observable(),f.cust_name=r.observable(),f.order_no=r.observable(),f.purchase_order=r.observable(),f.order_date=r.observable(),f.remarks=r.observable(),f.delivery_cost=r.observable(),f.shipping_address=r.observable(),f.billing_address=r.observable(),f.ship_to_district=r.observable(),f.status=r.observable(),f.currHeaderId=r.observable(),f.headerTitle=r.observable(),f.subTitle=r.observable(),f.real_customer=r.observable(),f.showRealCustomer=r.computed(function(){var e=t.moduleConfig.params.rootContext.selCustomerProfile;return"Y"==r.utils.unwrapObservable(e.walkInCust)}),f.large=r.computed(function(){var r=e.ResponsiveUtils.getFrameworkQuery(e.ResponsiveUtils.FRAMEWORK_QUERY_KEY.LG_UP);return e.ResponsiveKnockoutUtils.createMediaQueryObservable(r)}),f.cart=r.observableArray([]),f.order=r.observableArray([]),f.handleActivated=function(r){var o=r.valueAccessor().params.ojRouter.parentRouter;console.log("Payment.js parentRouter="+o.currentState().value);var t=o.getChildRouter("payment");return t||(t=o.createChildRouter("payment")),f.router=t.configure(function(r){if(r){var o=new e.RouterState(r,{value:r,enter:function(){f.currHeaderId(r),console.log("payment.js stateId="+r)}});return o}}),c(),e.Router.sync()},f.completeOrder=function(){var e=l.isMaintenance();return e?void s.showMessageBox(f.lng_maintenance):void(confirm(f.lng_confirmPlaceOrder)&&_("complete"))},f.cancelOrder=function(){var e=l.isMaintenance();return e?void s.showMessageBox(f.lng_maintenance):void(confirm(f.lng_confirmPlaceOrder)&&_("cancel"))},f.printReceipt=function(){confirm(f.lng_confirmPrint)&&b()},f.goBack=function(){if(t.moduleConfig.params.rootContext.isContinuePayment?t.moduleConfig.params.rootContext.requireRefresh=!1:t.moduleConfig.params.rootContext.requireRefresh=!0,t.moduleConfig.params.rootContext.isDailyOrderSummary)t.go("dailyOrders");else{var e=t.moduleConfig.params.rootContext.custId;t.redirect("orderHist",e)}},f.dispose=function(e){f.router.dispose()}}return r.bindingHandlers.winsize={init:function(e,r,t,a,n){o(window).resize(function(){a.screenWidth(o(window).width()),a.screenHeight(o(window).height())})}},r.bindingHandlers.currency={symbol:r.observable("$"),update:function(e,o,t){return r.bindingHandlers.text.update(e,function(){var e=+(r.utils.unwrapObservable(o())||0),a=r.utils.unwrapObservable(void 0===t().symbol?t().sybmol:"$");return a+e.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")})}},r.bindingHandlers.readOnly={update:function(e,o){var t=r.utils.unwrapObservable(o());t?e.setAttribute("readOnly",!0):e.removeAttribute("readOnly")}},c});