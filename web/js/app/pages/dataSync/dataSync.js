define(["knockout","jquery","util/devmode","util/appui","appController","pages/common/constant","pages/common/cartService","pages/checkOut/checkOutService","util/commonhelper","pages/customer/customerService","pages/delivery/deliveryService","promise","ojs/ojlistview","ojs/ojjsontreedatasource","ojs/ojpagingcontrol","ojs/ojnavigationlist","ojs/ojrouter","ojs/ojtoolbar","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojarraytabledatasource","ojs/ojpulltorefresh","ojs/ojvalidation"],function(e,r,a,o,t,n,s,l,i,d,u){function c(){function c(e){var r=d.createCustomerProfile(e);return r}function f(){var t=u.getOfflineKey();a.isEnabled()&&a.isOffline()&&r.getJSON("js/app/pages/dataSync/dataSyncDeliveryMock.json",function(e){o.setLocalStorage(t,e)});var n=o.getLocalStorage(t);console.log("dataJSON = "+e.toJSON(n));var s=0;if("undefined"==typeof n)return 0;if("undefined"!=typeof n){if(Array.isArray(n)||(n=e.utils.unwrapObservable(n)),0==n.length)return 0;if(s=n.data.length,n&&s>0)for(var l=n.data.pop();l;)S(n.data,l),l=n.data.pop()}return s}function g(){var t=s.getOfflineKey();a.isEnabled()&&a.isOffline()&&r.getJSON("js/app/pages/dataSync/dataSyncSalesOrderMock.json",function(e){o.setLocalStorage(t,e)});var n=o.getLocalStorage(t);console.log("dataJSON = "+e.toJSON(n));var l=0;if("undefined"==typeof n)return 0;if("undefined"!=typeof n){if(Array.isArray(n)||(n=e.utils.unwrapObservable(n)),0==n.length)return 0;if(l=n.data.length,n&&l>0)for(var i=n.data.pop();i;)E(n.data,i),i=n.data.pop()}return l}function E(r,a){o.showBusy();var i,d,u=t.moduleConfig.params.rootContext.userProfile,c=a.order.ORDER_NUMBER,f=a.orderdetail,g=a.order,E=a.draughtBeerFlag;u.orgUnitId==n.ORG_UNIT_ID_WINE?(i="createWineOrderService",d="OutputCreateWineOrder"):(i="createBeerOrderService",d="OutputCreateBeerOrder"),N.targetCart.removeAll(),e.utils.arrayMap(f,function(e){var r=s.createCartItem(e,e.ORDERED_QUANTITY,!0,e.SCHEDULE_SHIP_DATE,e.ORIGINAL_LINE,new Array,e.SUBINVENTORY,e.SHIPPING_METHOD);N.targetCart.push(r)});var R={};e.utils.arrayMap(E,function(e){R[e.subInventoryCode]=e.dBeerFlag}),t.moduleConfig.params.rootContext.subInventoryMap=R;var S=y(g);console.log("payload = "+e.toJS(S));var O=function(a,t){try{console.log("raw data returned = "+e.toJSON(a));var n=!0,l=a[d];if("S"!=l.ReturnStatus&&"W"!=l.ReturnStatus&&(N.failedOrders.push({ORDER_NUMBER:c,RETURN_STATUS:l.ReturnStatus,RETURN_MESSAGE:l.ReturnMessage}),n=!1),n){var i=e.utils.arrayFirst(N.allOrders(),function(r){if(e.utils.unwrapObservable(r.data.order.ORDER_NUMBER)==c)return r});console.log("foundItem="+e.toJSON(i)),N.allOrders.remove(i),v(r,s.getOfflineKey())}}catch(e){console.error(e),o.hideBusy(),N.failedOrders.push({ORDER_NUMBER:c,RETURN_STATUS:"E",RETURN_MESSAGE:"Cannot be processed. Please contact the System Administrator."})}finally{o.hideBusy(),N.processCases(N.processCases()+1),console.log("cbSuccessFn called")}},_=function(e,r){console.log("cbFailFn failed"),o.hideBusy(),N.processCases(N.processCases()+1),N.failedOrders.push({ORDER_NUMBER:c,RETURN_STATUS:"E",RETURN_MESSAGE:"Cannot be processed. Please contact the System Administrator."})};l.createSalesOrderMessage(S,i).then(O,_)}function R(r,a){var o=t.moduleConfig.params.rootContext.userProfile,n=[];e.utils.arrayForEach(a,function(e){n.push({QTY:e.QTY,DELIVERY_DETAIL_ID:e.DELIVERY_DETAIL_ID})});var s=JSON.stringify({InputShipConfirm:{HeaderInfo:{UserID:o.username,UserRole:o.salesRole,CallerID:""},P_ORG_ID:o.orgUnitId,P_DELIVERY_ID:r,P_SHIPMENT_DETAILS_TBL:{P_SHIPMENT_DETAILS_TBL_ITEM:n}}});return s}function S(r,a){o.showBusy();var t=(a.order.ORDER_NUMBER,a.order.DELIVERY_NUMBER),n=a.orderdetail,s=(a.order,"OutputShipConfirm"),l=R(t,n);console.log("payload = "+e.toJS(l));var i=function(a,n){try{console.log("raw data returned = "+e.toJSON(a));var l=!0,i=a[s];if("S"!=i.ReturnStatus&&"W"!=i.ReturnStatus&&(N.failedDelivery.push({DELIVERY_NUMBER:t,RETURN_STATUS:i.ReturnStatus,RETURN_MESSAGE:i.ReturnMessage}),l=!1),l){var d=e.utils.arrayFirst(N.allOrders(),function(r){if(e.utils.unwrapObservable(r.data.order.DELIVERY_NUMBER)==t)return r});N.allOrders.remove(d),v(r,u.getOfflineKey())}}catch(e){console.error(e),o.hideBusy(),N.failedDelivery.push({DELIVERY_NUMBER:t,RETURN_STATUS:i.ReturnStatus,RETURN_MESSAGE:"Cannot be processed. Please contact the System Administrator."})}finally{o.hideBusy(),N.processCases(N.processCases()+1),console.log("cbSuccessFn called")}},d=function(e,r){console.log("cbFailFn failed"),o.hideBusy(),N.processCases(N.processCases()+1),N.failedDelivery.push({DELIVERY_NUMBER:t,RETURN_STATUS:respJSON.ReturnStatus,RETURN_MESSAGE:"Cannot be processed. Please contact the System Administrator."})};u.confirmDeliveryMessage(l).then(i,d)}function v(e,r){o.setLocalStorage(r,e)}function O(){var e=t.moduleConfig.params.rootContext.isOnline;return"undefined"==typeof e&&(e=deviceReady.isOnline()),e}function y(e){var r=_(e),a=e.OVERRIDE_SHIPMENT_DATE,o=e.OVERRIDE_SUB_INVENTORY,s=e.OVERRIDE_SHIPMENT_METHOD,i=e.OVERRIDE_BILL_TO,d=e.OVERRIDE_SALES_PERSON;i&&r.invoice_to_org_id(i),d&&r.sales_rep_id(d);var u=t.moduleConfig.params.rootContext.userProfile.orgUnitId;return u==n.ORG_UNIT_ID_WINE?l.getCreateWineOrderPayload(r,N.targetCart,a,o,s):l.getCreateBeerOrderPayload(r,N.targetCart,a,o,s)}function _(e){var r=t.moduleConfig.params.rootContext.userProfile,a=s.createOrder(e);return a.sold_from_org_id(r.orgUnitId),a.ship_from_org_id(p(r.orgUnitId)),a.sales_rep_id(r.erpSalesId),a}function p(e){return e==n.ORG_UNIT_ID_WINE?n.SHIP_FROM_ORG_ID_2922:e==n.ORG_UNIT_ID_BEER?n.SHIP_FROM_ORG_ID_2920:void 0}function m(){console.log("init"),N.scrollPos(0),o.showBusy();var n=s.getOfflineKey();console.log("salesOrderKey="+n);var l=u.getOfflineKey();console.log("deliveryKey="+l),a.isEnabled()&&a.isOffline()&&(r.getJSON("js/app/pages/dataSync/dataSyncSalesOrderMock.json",function(e){o.setLocalStorage(n,e)}),r.getJSON("js/app/pages/dataSync/dataSyncDeliveryMock.json",function(e){o.setLocalStorage(l,e)}));var i=new Array,d=o.getLocalStorage(n);console.log("salesOrderStoredPayload ="+e.toJSON(d)),d&&(d=d.data,e.utils.arrayMap(d,function(e){i.push(e)}));var c=t.moduleConfig.params.rootContext.userProfile;if("VS"==c.salesRole){var f=o.getLocalStorage(l);console.log("deliveryStoredPayload ="+e.toJSON(f)),f&&(f=f.data,e.utils.arrayMap(f,function(e){i.push(e)}))}if(i=e.toJS({data:i}),console.log("storedPayload= "+e.toJSON(i.data)),i&&i.data){var g=i.data;console.log("dataJSON = "+e.toJSON(g));var E=g.length;if("undefined"!=typeof g){Array.isArray(g)||(g=e.utils.unwrapObservable(g)),0==g.length&&o.hideBusy();var R=t.moduleConfig.params.rootContext.savedOrder;if(console.log("order in dataSync = "+e.toJSON(R)),R&&("S"==R.status||"D"==R.status)&&g&&E>0){e.isObservable(g)||(g=e.observableArray(g));var S=e.utils.arrayFirst(g(),function(e){return"N"==e.delivery&&e.order.ORDER_NUMBER==R.data.ORDER_NUMBER?e:"Y"==e.delivery&&e.order.DELIVERY_NUMBER==R.data.DELIVERY_NUMBER?e:void 0});console.log("foundItem ="+e.toJSON(S)),g.remove(S),console.log("dataJSON ="+e.toJSON(g));var O;O="Y"==S.delivery?u.getOfflineKey():s.getOfflineKey(),e.isObservable(g)&&(g=e.utils.unwrapObservable(g),0==g.length?(v(null,O),t.moduleConfig.params.rootContext.savedOrder="undefined"):(v(e.toJS({data:g}),O),t.moduleConfig.params.rootContext.savedOrder="undefined"))}g&&E>0&&C(g)}}D(),o.hideBusy(),N.ready(!0)}function C(r){var a=r,o=[];console.log("dataSort (data)  ="+e.toJSON(r));for(var t=a.length,n=0;n<a.length;n++){var s,l,i="N";try{i=a[n].delivery}catch(e){}console.log("deliveryFlag = "+i),"Y"==i?(s=a[n].order.DELIVERY_NUMBER,l=a[n].order.DELIVERY_DATE):(s=a[n].order.ORDER_NUMBER,l=a[n].order.ORDERED_DATE),o.push({id:t,data:a[n]}),t--}console.log("formatted = "+e.toJSON(o)),N.allOrders(o)}function D(){var e=oj.Translations.getTranslatedString;N.lng_synchronization=e("ssa.dataSync.synchronization"),N.lng_order=e("ssa.dataSync.order"),N.lng_orderDate=e("ssa.dataSync.orderDate"),N.lng_totalAmount=e("ssa.dataSync.totalAmount"),N.lng_confirmClear=e("ssa.dataSync.confirmClear"),N.lng_confirmSync=e("ssa.dataSync.confirmSync"),N.lng_allDataReceived=e("ssa.msg.info.allDataReceived"),N.lng_ERROR_00005=e("ssa.msg.error.ERROR_00005"),N.lng_ERROR_00020=e("ssa.msg.error.ERROR_00020")}var N=this;N.ready=e.observable(!1),N.targetCart=e.observableArray(),N.allOrders=e.observableArray(),N.processCases=e.observable(0),N.failedOrders=e.observableArray(),N.failedDelivery=e.observableArray(),N.scrollPos=e.observable(0),N.isVanSales=e.computed(function(){var e=t.moduleConfig.params.rootContext.userProfile.salesRole;return e==n.SR_SALE_VAN}),N.handleActivated=function(e){console.log("handleActivated"),m()},N.optionChange=function(r,a){if("selection"===a.option&&a.value[0]){console.log("ui.value ="+e.toJSON(a.value[0]));var o=e.utils.arrayFirst(N.allOrders(),function(e){if(e.id==a.value[0])return e});console.log("foundItem ="+e.toJSON(o));var n=o.data.delivery;if(console.log("delivery = "+n),"N"==n){var l=o.data.order,d=o.data.orderdetail;console.log("payload ="+e.toJSON(l));var f=c(l);console.log("customerProfile="+e.toJSON(f));var g=s.createOrder(l);s.setOrder(g),t.moduleConfig.params.rootContext.originalCart=e.observableArray();for(var d=o.data.orderdetail,E=d.length,R=0;R<E;R++){var S=d[R].ORDERED_QUANTITY,v=d[R].ORIGINAL_LINE,O=d[R].SUBINVENTORY;Array.isArray(O)&&O&&(O=O[0]);var y=d[R].SHIPPING_METHOD;Array.isArray(y)&&y&&(y=y[0]);var _=d[R].SCHEDULE_SHIP_DATE;i.isValid(_)&&_||(_=i.getClientCurrentDate());var p=s.createCartItem(d[R],S,!0,_,v,new Array,O,y);t.moduleConfig.params.rootContext.originalCart.push(p)}t.moduleConfig.params.rootContext.selCustomerProfile=f,t.moduleConfig.params.rootContext.custId=e.utils.unwrapObservable(f.id),t.moduleConfig.params.rootContext.fromPage="dataSync",t.moduleConfig.params.rootContext.savedOrder=e.toJS({status:"P",data:l}),t.moduleConfig.params.rootContext.savedOrderLine=e.toJS({data:d}),t.moduleConfig.params.rootContext.outLetId=e.utils.unwrapObservable(f.shipToSiteId),t.moduleConfig.params.rootContext.isReOrder=!1,t.moduleConfig.params.rootContext.isDailyOrderSummary=!1,t.moduleConfig.params.rootContext.isDataSync=!0,t.redirect("orderDetail",e.utils.unwrapObservable(g.oe_header_id))}if("Y"==n){var l=o.data.order,m=u.createDelivery(l.DELIVERY_NUMBER,l.DELIVERY_DATE,l.OUTLET_NAME,l.DELIVERY_ADDRESS,l.CAR_PLATE_NUMBER,l.ORDER_NUMBER,l.PAYMENT_TERM,l.DOCUMENT_TYPE);t.moduleConfig.params.rootContext.selDeliveryProfile=m,t.moduleConfig.params.rootContext.fromPage="dataSync",t.moduleConfig.params.rootContext.savedOrder=e.toJS({status:"P",data:l}),t.redirect("deliveryDetail",l.DELIVERY_NUMBER)}}},N.clearData=function(){if(confirm(N.lng_confirmClear)){var e=s.getOfflineKey();o.setLocalStorage(e,null);var r=u.getOfflineKey();o.setLocalStorage(r,null);var a=[];N.allOrders(a)}},N.dataSync=function(){console.log("dataSync clicked");try{var r=O();if(r){if(confirm(N.lng_confirmSync)){N.processCases(0),N.failedOrders.removeAll(),N.failedDelivery.removeAll();var a=g();console.log("rtnSalesOrder="+a);var t=f();console.log("rtnDelivery="+t);var n=setInterval(function(){if(N.processCases()==a+t){var r="",s=!1,l="";e.utils.arrayForEach(N.failedOrders(),function(e){s=!0,l.length>0&&(l+=","),l+=e.ORDER_NUMBER}),l.length>0&&(l="Order "+l);var i=!1,d="";e.utils.arrayForEach(N.failedDelivery(),function(e){i=!0,d.length>0&&(d+=","),d+=e.DELIVERY_NUMBER}),d.length>0&&(d="Delivery "+d),(s||i)&&(r=N.lng_allDataReceived+"<br><br>"+N.lng_ERROR_00020+"<br>"+l+"<br>"+d),s||i||(r=N.lng_allDataReceived),N.processCases()>0&&o.showMessageBox("",r),clearTimeout(n)}},1500)}}else o.showMessageBox(N.lng_ERROR_00005)}catch(e){console.error(e)}},N.orders=e.computed(function(){return new oj.ArrayTableDataSource(N.allOrders(),{idAttribute:"id"})})}return c});