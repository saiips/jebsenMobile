define(["ojs/ojcore","knockout","jquery","appController","pages/quotation/quotationService","util/appui","util/commonhelper","pages/common/constant","pages/common/cartService","ojs/ojrouter","ojs/ojtoolbar","ojs/ojknockout","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojselectcombobox","ojs/ojnavigationlist","promise","ojs/ojlistview","ojs/ojjsontreedatasource","ojs/ojmodel","ojs/ojpagingcontrol","ojs/ojpagingcontrol-model","ojs/ojpulltorefresh","ojs/ojvalidation","ojs/ojoffcanvas"],function(o,e,t,a,n,r,i,s,l){function u(){function u(){console.log("getAllQuotations started"),r.showBusy();var o=function(o,e){try{f(o,e.status)}catch(o){console.error(o),r.hideBusy()}finally{console.log("cbSuccessFn called"),T.ready(!0),a.moduleConfig.params.rootContext.requireRefresh=!1,r.hideBusy()}},e=function(o,e){console.log("cbFailFn failed"),f(o,e.status),r.hideBusy()};a.moduleConfig.params.rootContext.requireRefresh?n.refreshQuotationHistMessage(m()).then(o,e):n.getQuotationHistMessage(m()).then(o,e)}function f(o,t){if(o=Array.isArray(o)?o[0]:o,null!==o&&200==t){var n=o[h].P_QUOTATION_TBL_ITEM;if(null==n&&console.log("raw data = "+e.toJSON(o)),null!=n){if(!Array.isArray(n)){var u=new Array;u.push(n),n=u}for(var c=[],d=[],f={},g=0;g<n.length;g++){var m=(n[g].QUOTATION_NUMBER,n[g].OE_HEADER_ID),p=l.createQuotation(n[g]);"undefined"==typeof f[m]&&(f[m]=p);var v=n[g].QUOTATION_DATE;i.isValid(v)&&(v=i.formatStrDateToYYYYMMDD(v),n[g].QUOTATION_DATE=v),n[g].REMARKS="-1"==n[g].REMARKS?"":n[g].REMARKS,d.indexOf(v)>-1?c[d.indexOf(v)].children.push({attr:{id:m,data:n[g]}}):(d.push(v),c.push({attr:{id:m,quotationDate:v},children:[{attr:{id:m,data:n[g]}}]}))}c.sort(function(o,e){return o.attr.quotationDate<e.attr.quotationDate?1:o.attr.quotationDate>e.attr.quotationDate?-1:0}),c.forEach(function(o){o.children.sort(function(o,e){return o.attr.QUOTATION_DATE<e.attr.QUOTATION_DATE?1:o.attr.QUOTATION_DATE>e.attr.QUOTATION_DATE?-1:o.attr.QUOTATION_NUMBER<e.attr.QUOTATION_NUMBER?1:o.attr.QUOTATION_NUMBER>e.attr.QUOTATION_NUMBER?-1:0})}),T.allQuotation(c),a.moduleConfig.params.rootContext.headerIdMap=f}var C=e.utils.unwrapObservable(a.moduleConfig.params.rootContext.selCustomerProfile.billToSiteId),b=a.moduleConfig.params.rootContext.userProfile,y=s.QUOTATION_LIST_KEY+":"+b.orgUnitId+":"+C+":"+s.QUOTATION_LIST_SYNC_DATETIME,o=r.getLocalStorage(y);o&&(T.syncDatetime(o),T.showLastSyncDate(!0))}}function g(){var o=function(o,e){try{f(o,e.status)}catch(o){console.error(o)}finally{console.log("cbSuccessFn called")}},e=function(o,e){console.log("cbFailFn failed"),f(o,e.status)};n.refreshQuotationHistMessage(m()).then(o,e)}function m(){console.log("Customer Profile = "+e.toJSON(a.moduleConfig.params.rootContext.selCustomerProfile.billToSiteId));var o=e.utils.unwrapObservable(a.moduleConfig.params.rootContext.selCustomerProfile.billToSiteId),t=a.moduleConfig.params.rootContext.userProfile,n=JSON.stringify({InputGetQuotation:{HeaderInfo:{UserID:t.username,UserRole:t.salesRole,CallerID:""},P_ORG_ID:d,P_ACCOUNT_NUMBER:"",P_SHIP_TO_ORG_ID:o}});return n}function p(){var e=o.Translations.getTranslatedString;T.lng_quotationList=e("ssa.quotation.quotationList"),T.lng_date=e("ssa.quotation.date"),T.lng_amount=e("ssa.quotation.amount"),T.lng_uom=e("ssa.quotation.uom"),T.lng_qty=e("ssa.quotation.qty"),T.lng_item=e("ssa.quotation.totalItem"),T.lng_remarks=e("ssa.quotation.remarks"),T.lng_lastSyncDate=e("ssa.header.lastSyncDate"),T.lng_customerName=e("ssa.quotation.customerName"),T.lng_primaryText=e("ssa.pullToRefreshUtils.primaryText"),T.lng_secondaryText=e("ssa.pullToRefreshUtils.secondaryText")}var T=this;console.log("QuotationViewModel");var h="P_QUOTATION_TBL";T.router=a.router,T.principleRouter=a.principleRouter,T.allQuotation=e.observableArray([]),T.ready=e.observable(!1),T.navDataSource=a.navDataSource,T.navChangeHandler=a.navChangeHandler,T.headerTitle=e.observable(""),T.navStateId=e.observable(""),T.syncDatetime=e.observable(),T.showLastSyncDate=e.observable(!1),T.large=e.computed(function(){var e=o.ResponsiveUtils.getFrameworkQuery(o.ResponsiveUtils.FRAMEWORK_QUERY_KEY.LG_UP);return o.ResponsiveKnockoutUtils.createMediaQueryObservable(e)}),T.itemOnly=function(o){return o.leaf},T.selectTemplate=function(o,e){return e.$itemContext.leaf?"item_template":"group_template"},T.searchText=e.observable(""),T.searchText.extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}}),T.lng_searchPlaceHolder=e.observable("Input something for searching"),T.currCustomerId=e.observable(),T.handleActivated=function(t){console.log("quotation handleActivated");var n=t.valueAccessor().params.ojRouter.parentRouter;console.log("quotation.js parentRouter="+n.currentState().value);var r=n.getChildRouter("quotation");r||(r=n.createChildRouter("quotation")),T.router=r.configure(function(e){if(e){var t=new o.RouterState(e,{value:e,enter:function(){console.log("quotation stateId="+e),T.currCustomerId(e)}});return t}}),p();var i=a.moduleConfig.params.rootContext.selCustomerProfile;if("undefined"!=typeof i){var l=e.utils.unwrapObservable(i.outletName);e.utils.unwrapObservable(T.large())||l.length>s.TITLE_LENGTH&&(l=l.substring(0,s.TITLE_LENGTH)+"..."),T.headerTitle(l)}else T.headerTitle(T.lng_quotationList);return T.navStateId(a.moduleConfig.params.rootContext.navStateId),o.Router.sync()},T.handleBindingsApplied=function(o){var e=t("#globalBody").find(".oj-hybrid-applayout-content"),a="oj-hybrid-applayout-scrollable";e.hasClass(a)&&(t("#searchCanvas").on("ojbeforeopen",function(){e.removeClass(a)}),t("#searchCanvas").on("ojbeforeclose",function(){e.addClass(a)})),t("#searchCanvas").on("ojclose",function(){T.clearSearch()})},T.quotations=e.computed(function(){if(T.searchText()&&T.allQuotation().length>0){var e=[],t=T.searchText().toLowerCase();return T.allQuotation().forEach(function(o){o.children.forEach(function(o){0===o.attr.data.QUOTATION_NUMBER.toLowerCase().indexOf(t)&&e.push(o)})}),new o.JsonTreeDataSource(e)}return new o.JsonTreeDataSource(T.allQuotation())}),T.onClearSearchText=function(){T.clearSearch()},T.clearSearch=function(){var o=t("#searchProduct");o.ojInputText("option","value",""),o.ojInputText("reset"),T.searchText("")},T.toggleSearchCanvas=function(){console.log("toggleSearchCanvas triggered"),o.OffcanvasUtils.toggle(c)},T.onSearchTextChange=function(o,e){"rawValue"===e.option&&T.searchText(e.value)},T.loadQuotationDetailPage=function(o){o.id?(console.log("loadQuotationDetailPage="+e.toJSON(o.id)),a.redirect("quotationDetail",o.id)):console.log("loadQuotationDetailPage= Router to Quotation Detail")},T.onEnter=function(o,e){if(13===e.keyCode){var t={};t.id=o.id,T.loadQuotationDetailPage(t)}return!0},T.changeHandler=function(o,e){if("selection"===e.option&&e.value[0]){var t={};t.id=e.value[0],T.loadQuotationDetailPage(t)}},T.optionChange=function(o,e){if("currentItem"===e.option&&e.value){console.log("quotation id = "+e.value);var t=a.moduleConfig.params.rootContext.headerIdMap,n=t[e.value];l.setQuotation(n),a.redirect("quotationDetail",e.value)}},T.add=function(o,t){var n=a.moduleConfig.params.rootContext.custId;a.moduleConfig.params.rootContext.originalQuotationCart=e.observableArray(),a.moduleConfig.params.rootContext.fromPage="quotation",a.moduleConfig.params.rootContext.newQuotationNavStateId="newQuotationItem",a.moduleConfig.params.rootContext.isExpressCopy=!1,a.moduleConfig.params.rootContext.isCopyQuotation=!1,a.moduleConfig.params.rootContext.quotationId=null,a.redirect("newQuotationItem",n)},T.dispose=function(o){T.router.dispose()},T.currCustomerId.subscribe(function(o){u(o)}),t(document).ready(function(){o.PullToRefreshUtils.setupPullToRefresh("#listviewContainer",function(){console.log(">>>>>>>>>>>>>> setupPullToRefresh");var o=new Promise(function(o,e){T.onClearSearchText(),g(),setTimeout(function(){o()},3e3)});return o},{primaryText:T.lng_primaryText,secondaryText:T.lng_secondaryText}),t("#listview").on({ojdestroy:function(){console.log(">>>>>>>>>>>>>> ojdestroy"),o.PullToRefreshUtils.tearDownPullToRefresh("#listviewContainer")}})})}var c,d=a.moduleConfig.params.rootContext.userProfile.orgUnitId;return c={selector:"#searchCanvas",edge:"top",displayMode:"push",size:"63px",modality:"modeless",autoDismiss:"none"},e.bindingHandlers.searchCanvas={init:function(t,a,n){e.utils.domNodeDisposal.addDisposeCallback(t,function(){t&&o.OffcanvasUtils.close(c)})}},e.bindingHandlers.winsize={init:function(o,e,a,n,r){t(window).resize(function(){n.screenWidth(t(window).width()),n.screenHeight(t(window).height())})}},e.bindingHandlers.currency={symbol:e.observable("$"),update:function(o,t,a){return e.bindingHandlers.text.update(o,function(){var o=+(e.utils.unwrapObservable(t())||0),n=e.utils.unwrapObservable(void 0===a().symbol?a().sybmol:"$");return n+o.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")})}},u});