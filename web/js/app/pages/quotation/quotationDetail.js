define(["ojs/ojcore","knockout","jquery","appController","pages/quotation/quotationService","pages/common/cartService","util/appui","pages/common/constant","util/commonhelper","ojs/ojrouter","ojs/ojknockout","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojselectcombobox",,"ojs/ojnavigationlist","promise"],function(t,o,e,a,r,n,i,s,l){function u(){function u(){console.log("fillQuotationHeader");var e=n.getQuotation();console.log("quotation = "+o.toJSON(e)),E.quotation_no(o.utils.unwrapObservable(e.quotation_no)),E.quotation_date(o.utils.unwrapObservable(e.quotation_date)),E.remarks(o.utils.unwrapObservable(e.remarks)),E.status(o.utils.unwrapObservable(e.status)),E.real_customer(o.utils.unwrapObservable(e.real_customer)),E.attention(o.utils.unwrapObservable(e.attention)),E.salesTerms(o.utils.unwrapObservable(e.salesTerm));var a=t.Translations.getTranslatedString;o.utils.arrayForEach(s.SALES_TERMS_LIST,function(t){E.availableSalesTerms.push(o.toJS({value:t.value,label:a(t.label)}))})}function I(t){var o=a.moduleConfig.params.rootContext.userProfile.orgUnitId,e=a.moduleConfig.params.rootContext.userProfile,r=JSON.stringify({InputGetQuotationLines:{HeaderInfo:{UserID:e.username,UserRole:e.salesRole,CallerID:""},P_ORG_ID:o,P_HEADER_ID:t}});return r}function d(){E.specialDiscountLoaded.removeAll(),E.specialAmountLoaded.removeAll(),E.promotionItemLoaded.removeAll()}function c(t,e){console.log("populate modifier data = "+o.toJSON(e)),d();var a,r=0;try{a=e.MODIFIER_TBL.MODIFIER_TBL_ITEM,a?(Array.isArray(a)||(a=new Array(a)),r=a?a.length:0):r=0}catch(t){r=0}for(var i=0;i<r;i++){var l=a[i].MODIFIER_TYPE;try{l==s.MODIFIER_TYPE_ITEM?r=E.promotionItemLoaded().length:l==s.MODIFIER_TYPE_DISCOUNT?r=E.specialDiscountLoaded().length:l==s.MODIFIER_TYPE_AMOUNT&&(r=E.specialAmountLoaded().length)}catch(t){}var u="Y"==a[i].FROM_STAGING&&a[i].MODIFIER_NUMBER?"Y":"N",I="Y"==a[i].FROM_STAGING&&a[i].MODIFIER_NUMBER?"Y":"N",c={id:r+1,MODIFIER_NUMBER:a[i].MODIFIER_NUMBER,FROM_STAGING:a[i].FROM_STAGING,MODIFIER_TYPE:a[i].MODIFIER_TYPE,MODIFIER_ITEM_ID:a[i].MODIFIER_ITEM_ID,MODIFIER_VALUE_FROM:a[i].MODIFIER_VALUE_FROM,GET_ITEM_ID:a[i].GET_ITEM_ID,GET_ITEM_NUMBER:a[i].GET_ITEM_NUMBER,GET_QUANTITY:a[i].GET_QUANTITY,GET_PRICE:a[i].GET_PRICE,GET_PROMOTION_NATURE:a[i].GET_PROMOTION_NATURE,GET_PERCENT:a[i].GET_PERCENT,MODIFIER_START_DATE:a[i].MODIFIER_START_DATE,MODIFIER_END_DATE:a[i].MODIFIER_END_DATE,MODIFIER_SHIP_TO:a[i].MODIFIER_SHIP_TO,SHOW_LINK_BTN:u,SHOW_REMOVE_BTN:I},_=n.createModifier(c,!0);l==s.MODIFIER_TYPE_ITEM?E.promotionItemLoaded.push(_):l==s.MODIFIER_TYPE_DISCOUNT?E.specialDiscountLoaded.push(_):l==s.MODIFIER_TYPE_AMOUNT&&E.specialAmountLoaded.push(_),t.product().specialDiscount=E.specialDiscountLoaded,t.product().specialAmount=E.specialAmountLoaded,t.product().promotionItem=E.promotionItemLoaded,t.product().isFetchModifier(!0)}}function _(){var o=t.Translations.getTranslatedString;E.lng_quotationDetail=o("ssa.quotationDetail.quotationDetail"),E.lng_overview=o("ssa.quotationDetail.overview"),E.lng_quotationNo=o("ssa.quotationDetail.quotationNo"),E.lng_quotationDate=o("ssa.quotationDetail.quotationDate"),E.lng_totalItems=o("ssa.quotationDetail.totalItems"),E.lng_total=o("ssa.quotationDetail.total"),E.lng_remarks=o("ssa.quotationDetail.remarks"),E.lng_itemsDetail=o("ssa.quotationDetail.itemsDetail"),E.lng_lot=o("ssa.quotationDetail.lot"),E.lng_qty=o("ssa.quotationDetail.qty"),E.lng_quotationSummary=o("ssa.quotationDetail.quotationSummary"),E.lng_shippingAddress=o("ssa.quotationDetail.shippingAddress"),E.lng_billingAddress=o("ssa.quotationDetail.billingAddress"),E.lng_realCustomer=o("ssa.quotationDetail.realCustomer"),E.lng_copyQuotation=o("ssa.quotationDetail.copyQuotation"),E.lng_expressCopy=o("ssa.quotationDetail.expressCopy"),E.lng_attention=o("ssa.quotationDetail.attention"),E.lng_salesTerms=o("ssa.quotationDetail.salesTerms")}var E=this;console.log("QuotationDetailViewModel"),E.router=a.router,E.cust_name=o.observable(),E.quotation_no=o.observable(),E.quotation_date=o.observable(),E.real_customer=o.observable(),E.remarks=o.observable(),E.attention=o.observable(),E.salesTerms=o.observable(),E.availableSalesTerms=o.observableArray(),E.shipping_address=o.observable(),E.billing_address=o.observable(),E.status=o.observable(),E.currQuotationId=o.observable(),E.totalItems=o.observable(),E.total=o.observable(),E.headerTitle=o.observable(""),E.quotationItems=o.observableArray([]),E.promotionItemLoaded=o.observableArray(),E.specialAmountLoaded=o.observableArray(),E.specialDiscountLoaded=o.observableArray(),E.large=o.computed(function(){var o=t.ResponsiveUtils.getFrameworkQuery(t.ResponsiveUtils.FRAMEWORK_QUERY_KEY.LG_UP);return t.ResponsiveKnockoutUtils.createMediaQueryObservable(o)}),E.handleActivated=function(e){var r=e.valueAccessor().params.ojRouter.parentRouter;console.log("quotationDetail.js parentRouter="+r.currentState().value),console.log(">>>>>> originalCart = "+o.toJSON(a.moduleConfig.params.rootContext.originalQuotationCart)),a.moduleConfig.params.rootContext.originalQuotationCart&&(a.moduleConfig.params.rootContext.originalQuotationCart=o.observableArray([]));var n=r.getChildRouter("quotationDetail");n||(n=r.createChildRouter("quotationDetail")),E.router=n.configure(function(o){if(o){var e=new t.RouterState(o,{value:o,enter:function(){E.currQuotationId(o),console.log("quotationDetail.js stateId="+o)}});return e}}),_();var i=a.moduleConfig.params.rootContext.selCustomerProfile;if("undefined"!=typeof i){var l=o.utils.unwrapObservable(i.outletName);o.utils.unwrapObservable(E.large())||l.length>s.TITLE_LENGTH&&(l=l.substring(0,s.TITLE_LENGTH)+"..."),E.headerTitle(l)}else E.headerTitle(E.lng_quotationDetail);return t.Router.sync()},E.currQuotationId.subscribe(function(t){function n(t,a){console.log("raw data = "+o.toJSON(t)),E.quotationItems.removeAll();try{var r=t;if("string"==typeof t&&(r=JSON.parse(t)),r.P_QUOTATION_LINES_TBL){var n=r.P_QUOTATION_LINES_TBL.P_QUOTATION_LINES_TBL_ITEM;e.isArray(n)||(n=new Array(n)),n.forEach(function(t){t.REMARK="-1"==t.REMARKS?"":t.REMARKS;try{var o=t.MODIFIER_TBL.MODIFIER_TBL_ITEM;"undefined"==typeof o?t.MODIIFER_EXISTS=!1:(Array.isArray(t.MODIFIER_TBL.MODIFIER_TBL_ITEM)||(o=new Array(t.MODIFIER_TBL.MODIFIER_TBL_ITEM)),t.MODIFIER_EXISTS=!!(o&&o.length>0))}catch(o){t.MODIIFER_EXISTS=!1}E.quotationItems.push(t)}),E.totalItems(n.length),E.total(n[0].ORDER_TOT_AMT)}}catch(t){console.error(t),i.hideBusy()}finally{console.log("cbSuccessFn called"),i.hideBusy()}}function s(t,o){console.log("cbFailFn failed"),i.hideBusy()}i.showBusy(),console.log("load quotation detail with "+t);var l=a.moduleConfig.params.rootContext.selCustomerProfile;E.cust_name(o.utils.unwrapObservable(l.name)),E.showRealCustomer=o.computed(function(){return"Y"==o.utils.unwrapObservable(l.walkInCust)}),u(),r.getQuotationItemMessage(I(t)).then(n,s)}),E.modifier=function(t,e){console.log("modifier clicked"),console.log("data = "+o.toJSON(t));var r=E.currQuotationId();a.moduleConfig.params.rootContext.quotationId=r,t.PRODUCT=t.ORDERED_ITEM;var i,u=n.createCartItem(t,1,!0,l.getClientCurrentDate(),"Y",new Array);try{i=t.MODIFIER_TBL.MODIFIER_TBL_ITEM,i&&(Array.isArray(i)||(i=new Array(i)))}catch(t){i=null}if(i){for(var I=o.observableArray(),d=o.observableArray(),c=o.observableArray(),_=0;_<i.length;_++){var m=n.createModifier(i[_]);i[_].MODIFIER_TYPE==s.MODIFIER_TYPE_ITEM?I.push(m):i[_].MODIFIER_TYPE==s.MODIFIER_TYPE_DISCOUNT?d.push(m):i[_].MODIFIER_TYPE==s.MODIFIER_TYPE_AMOUNT&&c.push(m)}u.product().specialDiscount=d,u.product().specialAmount=c,u.product().promotionItem=I,console.log("cartItem = "+o.toJSON(u))}a.moduleConfig.params.rootContext.selectedItem=u,a.moduleConfig.params.rootContext.enquiryMode=!0;var T=t.INVENTORY_ITEM_ID;a.redirect("modifier",T)},E.updateData=function(t,o){"value"===o.option&&t.target.id&&n.setCart(E.cart)},E.goBack=function(){var t=a.moduleConfig.params.rootContext.custId;a.redirect("quotation",t)},E.dispose=function(t){E.router.dispose()},E.copyQuotation=function(){a.moduleConfig.params.rootContext.originalQuotationCart=o.observableArray(),o.utils.arrayMap(E.quotationItems(),function(t){t.PRODUCT=t.ORDERED_ITEM;var o=n.createCartItem(t,1,!0,l.getClientCurrentDate(),"Y",new Array);c(o,t),a.moduleConfig.params.rootContext.originalQuotationCart.push(o)}),a.moduleConfig.params.rootContext.isCopyQuotation=!0,a.moduleConfig.params.rootContext.fromPage="quotationDetail",a.moduleConfig.params.rootContext.newQuotationNavStateId="newQuotationItem";var t=E.currQuotationId();a.moduleConfig.params.rootContext.quotationId=t,a.redirect("newQuotationItem",t)},E.expressCopy=function(){a.moduleConfig.params.rootContext.originalQuotationCart=o.observableArray(),o.utils.arrayMap(E.quotationItems(),function(t){t.PRODUCT=t.ORDERED_ITEM;var o=n.createCartItem(t,1,!0,l.getClientCurrentDate(),"Y",new Array);c(o,t),a.moduleConfig.params.rootContext.originalQuotationCart.push(o)}),a.moduleConfig.params.rootContext.isExpressCopy=!0,a.moduleConfig.params.rootContext.fromPage="quotationDetail";var t=E.currQuotationId();a.moduleConfig.params.rootContext.quotationId=t,a.redirect("checkOutQuotation",t)}}return o.bindingHandlers.winsize={init:function(t,o,a,r,n){e(window).resize(function(){r.screenWidth(e(window).width()),r.screenHeight(e(window).height())})}},o.bindingHandlers.currency={symbol:o.observable("$"),update:function(t,e,a){return o.bindingHandlers.text.update(t,function(){var t=+(o.utils.unwrapObservable(e())||0),r=o.utils.unwrapObservable(void 0===a().symbol?a().sybmol:"$");return r+t.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")})}},o.bindingHandlers.readOnly={update:function(t,e){var a=o.utils.unwrapObservable(e());a?t.setAttribute("readOnly",!0):t.removeAttribute("readOnly")}},new u});