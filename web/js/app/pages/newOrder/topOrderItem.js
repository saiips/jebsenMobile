define(["ojs/ojcore","knockout","jquery","appController","pages/newOrder/newOrderService","pages/common/cartService","util/commonhelper","amplify","util/appui","pages/common/constant","promise","ojs/ojlistview","ojs/ojjsontreedatasource","ojs/ojpagingcontrol","ojs/ojnavigationlist","ojs/ojrouter","promise","ojs/ojtoolbar","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojarraytabledatasource","ojs/ojpulltorefresh","ojs/ojvalidation","ojs/ojoffcanvas"],function(e,r,t,o,a,n,s,i,l,u){function d(){function i(){var e=o.moduleConfig.params.rootContext.userProfile,t=r.utils.unwrapObservable(e.orgUnitId),a=o.moduleConfig.params.rootContext.selCustomerProfile,n=r.utils.unwrapObservable(a.shipToSiteId),s=r.utils.unwrapObservable(a.priceListId);n=new String(r.utils.unwrapObservable(n)).toString(),s=new String(r.utils.unwrapObservable(s)).toString(),I.payloadKey(e.username+":"+t+":"+n+":"+s)}function d(){var e=o.moduleConfig.params.rootContext.userProfile,t=o.moduleConfig.params.rootContext.selCustomerProfile,a=r.utils.unwrapObservable(t.priceListId);a=new String(r.utils.unwrapObservable(a)).toString();var n=r.utils.unwrapObservable(t.shipToSiteId);n=new String(r.utils.unwrapObservable(n)).toString();var s=JSON.stringify({InputGetTop10PriceList:{HeaderInfo:{UserID:e.username,UserRole:e.salesRole,CallerID:""},P_ORG_ID:e.orgUnitId,P_SHIP_TO_ORG_ID:n,P_PRICE_LIST_ID:a}});return s}function p(){var e=o.moduleConfig.params.rootContext.originalCart;console.log("_cart = "+r.toJSON(e)),Array.isArray(e)||(e=r.utils.unwrapObservable(e)),console.log("isArray(_cart) = "+Array.isArray(e)),Array.isArray(e)&&I.totalCnt(e.length)}function g(){console.log("topOrderItem.js init() started"),I.ready(!1),l.showBusy(),p(),b()}function b(){var e=function(e,r){try{m(e,r.status)}catch(e){console.error(e),l.hideBusy()}finally{l.hideBusy(),console.log("cbSuccessFn called")}},r=function(e,r){console.log("cbFailFn failed"),m(e,r.status),l.hideBusy()};a.getTopItemListMessage(d()).then(e,r)}function C(){var e=function(e,r){try{m(e,r.status)}catch(e){console.error(e)}finally{console.log("cbSuccessFn called")}},r=function(e,r){console.log("cbFailFn failed"),m(e,r.status)};a.refreshTopItemListMessage(d()).then(e,r)}function m(e,t){if(console.log("raw data = "+r.toJSON(e)),e=Array.isArray(e)?e[0]:e,null!==e&&200==t){var o=e[w],a=[];Array.isArray(o)||(o=new Array(o));for(var i=0;i<o.length;i++){var u=JSON.stringify({INVENTORY_ITEM_ID:o[i].INVENTORY_ITEM_ID,PRODUCT_DESCRIPTION:o[i].PRODUCT_DESCRIPTION,DESCRIPTION:o[i].DESCRIPTION,PRODUCT:o[i].PRODUCT,LOT_NUMBER:"",ORDER_QUANTITY_UOM:o[i].PRODUCT_UOM_CODE,UNIT_SELLING_PRICE:o[i].UNIT_PRICE,FLOW_STATUS_CODE:"",PRODUCT_BRAND:o[i].PRODUCT_BRAND,PRINCIPAL:o[i].PRINCIPAL,CURRENCY_CODE:o[i].CURRENCY_CODE,DRAFT_BEER_FLAG:o[i].DRAFT_BEER_FLAG});cart_item=n.createCartItem(r.utils.parseJson(u),0,!0,s.getClientCurrentDate(),"Y",new Array),a[i]=cart_item}I.allProduct(a),f()}l.hideBusy(),I.ready(!0)}function f(){var e=o.moduleConfig.params.rootContext.userProfile.orgUnitId,t=o.moduleConfig.params.rootContext.selCustomerProfile,a=r.utils.unwrapObservable(t.priceListId),n=r.utils.unwrapObservable(t.shipToSiteId),s=u.TOP_ITEM_LIST_KEY+":"+e+":"+n+":"+a+":"+u.TOP_ITEM_LIST_SYNC_DATATIME,i=l.getLocalStorage(s);i&&(I.syncDatetime(i),I.showLastSyncDate(!0))}function v(e,t){if(t==u.ALL_CODE.toString().toLowerCase())return e;var o=r.utils.arrayFilter(e,function(e){return e.product().prod_desc().toLowerCase().indexOf(t)>=0||e.product().prod_code().toLowerCase().indexOf(t)>=0||e.product().prod_brand().toLowerCase().indexOf(t)>=0});return o}function O(e,r){var o,a;if("SPAN"==r.target.tagName?(a=t(r.target),o=t(r.target.parentNode)):"A"==r.target.tagName&&(a=t(r.target).find("span"),o=t(r.target)),!o.attr("clicked")||"true"!=o.attr("clicked")){o.attr("clicked")||o.attr("clicked",!1),o.attr("clicked",!0),o.css("background-color","rgb(70, 133, 191)");var n=a.text();a.text(I.lng_added),setTimeout(function(){o.css("background-color","#002d72"),a.text(n),o.attr("clicked",!1)},100)}}function T(){return o.moduleConfig.params.rootContext.isDataSync}function _(){var r=e.Translations.getTranslatedString;I.lng_topOrder=r("ssa.newOrderItem.topOrder"),I.lng_itemList=r("ssa.newOrderItem.itemList"),I.lng_topList=r("ssa.newOrderItem.topList"),I.lng_orderList=r("ssa.newOrderItem.orderList"),I.lng_searchPlaceHolderText=r("ssa.newOrderItem.searchPlaceHolder"),I.lng_addToCart=r("ssa.newOrderItem.addToCart"),I.lng_added=r("ssa.newOrderItem.added"),I.lng_principal=r("ssa.newOrderItem.principal"),I.lng_allPrincipal=r("ssa.newOrderItem.allPrincipal"),I.lng_noItemCart=r("ssa.msg.info.noItemCart"),I.lng_lastSyncDate=r("ssa.header.lastSyncDate"),I.lng_primaryText=r("ssa.pullToRefreshUtils.primaryText"),I.lng_secondaryText=r("ssa.pullToRefreshUtils.secondaryText")}var I=this;_();var w="P_PRICE_LIST_TBL_ITEM";I.handleActivated=function(t){var a=t.valueAccessor().params.ojRouter.parentRouter;console.log("topOrderItem.js parentRouter="+a.currentState().value),I.searchText(""),I.scrollPos(0);var n=a.getChildRouter("topOrderItem");n||(n=a.createChildRouter("topOrderItem")),I.router=n.configure(function(r){if(r){var t=new e.RouterState(r,{value:r,enter:function(){I.currOrderId(r),console.log("stateId ="+r)}});return t}}),_(),I.headerSubTitle(I.lng_topOrder),p(),i();var s=o.moduleConfig.params.rootContext.selCustomerProfile;if("undefined"!=typeof s){var l=r.utils.unwrapObservable(s.outletName);r.utils.unwrapObservable(I.large())||l.length>u.TITLE_LENGTH&&(l=l.substring(0,u.TITLE_LENGTH)+"..."),I.headerTitle(l)}else I.headerTitle(I.lng_topOrder);return I.isOrderDeskAdmin=r.computed(function(){var e=o.moduleConfig.params.rootContext.userProfile;return e.salesRole==u.SR_ADMIN||!o.moduleConfig.params.rootContext.isCordova}),I.newOrderNavDataSource=r.computed(function(){var r=[{name:I.lng_itemList,id:"newOrderItem",iconClass:"oj-navigationlist-item-icon demo-icon demo-dashboard-icon"},{name:I.lng_topList,id:"topOrderItem",iconClass:"oj-navigationlist-item-icon demo-icon demo-dashboard-icon"},{name:I.lng_orderList,id:"newOrder",iconClass:"oj-navigationlist-item-icon demo-icon demo-incidents-icon"}];return new e.ArrayTableDataSource(r,{idAttribute:"id"})}),I.newOrderNavChangeHandler=o.newOrderNavChangeHandler,I.newOrderNavStateId(o.moduleConfig.params.rootContext.newOrderNavStateId),e.Router.sync()},console.log("NewTopOrderItemViewModel"),I.router=o.router,I.allProduct=r.observableArray(),I.ready=r.observable(!1),I.cart=r.observableArray(),I.currOrderId=r.observable(),I.headerTitle=r.observable(""),I.headerSubTitle=r.observable(),I.newOrderNavStateId=r.observable(),I.totalCnt=r.observable(0),I.payloadKey=r.observable(),I.options=r.observableArray(),I.selectItem=r.observable(),I.syncDatetime=r.observable(),I.showLastSyncDate=r.observable(!1),I.scrollPos=r.observable(0),I.large=r.computed(function(){var r=e.ResponsiveUtils.getFrameworkQuery(e.ResponsiveUtils.FRAMEWORK_QUERY_KEY.LG_UP);return e.ResponsiveKnockoutUtils.createMediaQueryObservable(r)}),I.searchText=r.observable(""),I.lng_searchPlaceHolder=r.observable(I.lng_searchPlaceHolderText),I.searchText.extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}}),I.itemCode=r.observableArray(),I.payloadKey.subscribe(function(e){console.log("new payloadKey ="+e),g()}),I.refresh=function(){l.showBusy(),C()},I.onPageReady=function(){try{e.PullToRefreshUtils.setupPullToRefresh("#listviewContainer",function(){var e=new Promise(function(e,r){I.onClearSearchText(),C(),setTimeout(function(){e()},3e3)});return e},{primaryText:I.lng_primaryText,secondaryText:I.lng_secondaryText})}catch(e){console.error(e)}},I.products=r.computed(function(){var t=r.utils.unwrapObservable(I.allProduct());if(I.searchText()&&t.length>0){var o=I.searchText().toLowerCase(),a=v(t,o);return new e.ArrayTableDataSource(a,{idAttribute:"id"})}return new e.ArrayTableDataSource(t,{idAttribute:"id"})}),I.handleBindingsApplied=function(e){var r=t("#globalBody").find(".oj-hybrid-applayout-content"),o="oj-hybrid-applayout-scrollable";r.hasClass(o)&&(t("#searchCanvas").on("ojbeforeopen",function(){r.removeClass(o)}),t("#searchCanvas").on("ojbeforeclose",function(){r.addClass(o)})),t("#searchCanvas").on("ojclose",function(){I.clearSearch()})},I.onClearSearchText=function(){I.clearSearch()},I.clearSearch=function(){var e=t("#searchProduct");e.ojInputText("option","value",""),e.ojInputText("reset"),I.searchText("")},I.toggleSearchCanvas=function(){e.OffcanvasUtils.toggle(c)},I.onSearchTextChange=function(e,r){"rawValue"===r.option&&I.searchText(r.value)},I.addToCart=function(e,t){var a=JSON.stringify({INVENTORY_ITEM_ID:r.utils.unwrapObservable(e.product().id),PRODUCT_DESCRIPTION:r.utils.unwrapObservable(e.product().prod_desc),PRODUCT:r.utils.unwrapObservable(e.product().prod_code),LOT_NUMBER:r.utils.unwrapObservable(e.product().lot),ORDER_QUANTITY_UOM:r.utils.unwrapObservable(e.product().sku),UNIT_SELLING_PRICE:r.utils.unwrapObservable(e.product().price),FLOW_STATUS_CODE:r.utils.unwrapObservable(e.product().delivery_status),PRODUCT_BRAND:r.utils.unwrapObservable(e.product().prod_brand),CURRENCY_CODE:r.utils.unwrapObservable(e.product().currency_code),DRAFT_BEER_FLAG:r.utils.unwrapObservable(e.product().draft_beer_flag)}),i=n.createCartItem(r.utils.parseJson(a),1,!0,s.getClientCurrentDate(),"Y",new Array),l=o.moduleConfig.params.rootContext.originalCart;if(Array.isArray(l)||(l=r.utils.unwrapObservable(l)),"undefined"==typeof l||0==l.length){var u=new Array;u.push(i),o.moduleConfig.params.rootContext.originalCart=u}else o.moduleConfig.params.rootContext.originalCart.push(i);I.totalCnt(r.utils.unwrapObservable(I.totalCnt())+1),O(e,t)},I.checkOut=function(e,t){o.moduleConfig.params.rootContext.fromPage="topOrderItem";var a=o.moduleConfig.params.rootContext.custId;console.log("app.moduleConfig.params.rootContext.originalCart="+r.toJSON(o.moduleConfig.params.rootContext.originalCart));var s=n.allowCheckOut(o.moduleConfig.params.rootContext.originalCart);s?o.redirect("checkOut",a):l.showMessageBox(I.lng_noItemCart)},I.goBack=function(e,t){console.log("goBack clicked");var a=o.moduleConfig.params.rootContext.fromPage;if(T()||"orderHist"!==a&&"newOrder"!==a&&"newOrderItem"!==a&&"topOrderItem"!==a){var n=r.utils.unwrapObservable(I.currOrderId);o.redirect("orderDetail",n)}else{var s=o.moduleConfig.params.rootContext.custId;o.redirect("orderHist",s)}},I.dispose=function(e){I.router.dispose()}}var c;return c={selector:"#searchCanvas",edge:"top",displayMode:"push",size:"63px",modality:"modeless",autoDismiss:"none"},r.bindingHandlers.searchCanvas={init:function(t,o,a){r.utils.domNodeDisposal.addDisposeCallback(t,function(){t&&e.OffcanvasUtils.close(c)})}},r.bindingHandlers.winsize={init:function(e,r,o,a,n){t(window).resize(function(){a.screenWidth(t(window).width()),a.screenHeight(t(window).height())})}},r.bindingHandlers.currency={symbol:r.observable("$"),update:function(e,t,o){return r.bindingHandlers.text.update(e,function(){var e=+(r.utils.unwrapObservable(t())||0),a=r.utils.unwrapObservable(void 0===o().symbol?o().sybmol:"$");return a+e.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")})}},new d});