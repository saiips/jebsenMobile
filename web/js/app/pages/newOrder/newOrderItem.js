define(["ojs/ojcore","knockout","jquery","appController","pages/newOrder/newOrderService","pages/common/cartService","util/commonhelper","amplify","util/appui","pages/common/constant","promise","ojs/ojlistview","ojs/ojjsontreedatasource","ojs/ojpagingcontrol","ojs/ojnavigationlist","ojs/ojrouter","promise","ojs/ojtoolbar","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojarraytabledatasource","ojs/ojpulltorefresh","ojs/ojvalidation","ojs/ojoffcanvas"],function(e,r,t,o,a,n,s,i,l,u){function c(){function i(){var e=o.moduleConfig.params.rootContext.userProfile.salesRole;return e==u.SR_SALE_VAN}function c(){var e=o.moduleConfig.params.rootContext.userProfile,t=r.utils.unwrapObservable(e.orgUnitId),a=o.moduleConfig.params.rootContext.selCustomerProfile,n=r.utils.unwrapObservable(a.priceListId);y.payloadKey(e.username+":"+t+":"+n)}function p(){var e=o.moduleConfig.params.rootContext.userProfile,t=o.moduleConfig.params.rootContext.userProfile.orgUnitId,a=o.moduleConfig.params.rootContext.selCustomerProfile,n=r.utils.unwrapObservable(a.priceListId),s=[],i=[];s.push(n);for(var l=0;l<s.length;l++)i.push({PRICE_LIST_ID:s[l]});var u=JSON.stringify({InputGetPriceList:{HeaderInfo:{UserID:e.username,UserRole:e.salesRole,CallerID:""},P_ORG_ID:t,P_PRICE_LIST_ID_TBL:{P_PRICE_LIST_ID_TBL_ITEM:i}}});return u}function g(){var e=o.moduleConfig.params.rootContext.originalCart;console.log("_cart = "+r.toJSON(e)),Array.isArray(e)||(e=r.utils.unwrapObservable(e)),console.log("isArray(_cart) = "+Array.isArray(e)),Array.isArray(e)&&y.totalCnt(e.length)}function f(){console.log("newOrderItem.js init() started"),y.ready(!1),l.showBusy(),g(),C()}function C(){var e=function(e,r){try{b(e,r.status)}catch(e){console.error(e),l.hideBusy()}finally{l.hideBusy(),console.log("cbSuccessFn called")}},r=function(e,r){console.log("cbFailFn failed"),b(e,r.status),l.hideBusy()};a.getPriceListMessage(p()).then(e,r)}function m(){var e=function(e,r){try{b(e,r.status)}catch(e){console.error(e)}finally{console.log("cbSuccessFn called")}},r=function(e,r){console.log("cbFailFn failed"),b(e,r.status)};a.refreshPriceListMessage(p()).then(e,r)}function b(e,t){if(console.log("prepareUI triggered"),e=Array.isArray(e)?e[0]:e,null!==e&&200==t){var o=e[P],a=[],c=[];Array.isArray(o)||(o=new Array(o));for(var d=0;d<o.length;d++){var p=JSON.stringify({INVENTORY_ITEM_ID:o[d].INVENTORY_ITEM_ID,PRODUCT_DESCRIPTION:o[d].PRODUCT_DESCRIPTION,DESCRIPTION:o[d].DESCRIPTION,PRODUCT:o[d].PRODUCT,LOT_NUMBER:"",ORDER_QUANTITY_UOM:o[d].PRODUCT_UOM_CODE,UNIT_SELLING_PRICE:o[d].UNIT_PRICE,FLOW_STATUS_CODE:"",PRODUCT_BRAND:o[d].PRODUCT_BRAND,PRINCIPAL:o[d].PRINCIPAL,CURRENCY_CODE:o[d].CURRENCY_CODE,DRAFT_BEER_FLAG:o[d].DRAFT_BEER_FLAG});cart_item=n.createCartItem(r.utils.parseJson(p),0,!0,s.getClientCurrentDate(),"Y",new Array),a[d]=cart_item,c.indexOf(r.utils.unwrapObservable(cart_item.product().principal))<0&&c.push(r.utils.unwrapObservable(cart_item.product().principal))}y.allProduct(a),y.uniquePrincipals=r.dependentObservable(function(){if(i()){var e=[u.ALL_CODE];c=e.concat(c)}return r.utils.arrayGetDistinctValues(c)});var g=r.utils.unwrapObservable(y.uniquePrincipals()),f=new Map,C=[],m="";for(tagIndex in g)if(g[tagIndex].trim().length>0){var b=g[tagIndex];if(f.get(b)!==b){""===m&&(m=b,R=b),f.set(b,b);var O={value:b,label:b};C.push(O)}}y.selectItem(m),y.options(C),_(),v()}l.hideBusy(),y.ready(!0)}function v(){var e=o.moduleConfig.params.rootContext.userProfile.orgUnitId,t=o.moduleConfig.params.rootContext.selCustomerProfile,a=r.utils.unwrapObservable(t.priceListId),n=u.STANDARD_PRICE_LIST_KEY+":"+e+":"+a+":"+u.NEW_ORDER_LIST_SYNC_DATETIME,s=l.getLocalStorage(n);s&&(y.syncDatetime(s),y.showLastSyncDate(!0))}function O(e,t){if(t==u.ALL_CODE.toString().toLowerCase())return e;var o=r.utils.arrayFilter(e,function(e){return e.product().prod_desc().toLowerCase().indexOf(t)>=0||e.product().prod_code().toLowerCase().indexOf(t)>=0||e.product().prod_brand().toLowerCase().indexOf(t)>=0});return o}function I(e,t){if(t==u.ALL_CODE.toString().toLowerCase())return e;var o=r.utils.arrayFilter(e,function(e){return e.product().principal().toLowerCase().indexOf(t)>=0});return o}function _(){y.suggestions=function(e){return new Promise(function(t,o){var a=e.term,n=[],s=r.utils.unwrapObservable(y.uniquePrincipals());if(a){var i=new RegExp(a,"i");for(tagIndex in s)r.utils.unwrapObservable(s[tagIndex]).search(i)>=0&&n.push(s[tagIndex])}else n=s;var l=[];for(tagIndex in n){var u={itemLabel:n[tagIndex],itemCode:n[tagIndex]};l.push(u)}var c={groupId:"groupId",groupName:"Item Code Suggestions",items:l};l.length>0&&t(c)})}}function w(e,r){var o,a;if("SPAN"==r.target.tagName?(a=t(r.target),o=t(r.target.parentNode)):"A"==r.target.tagName&&(a=t(r.target).find("span"),o=t(r.target)),!o.attr("clicked")||"true"!=o.attr("clicked")){o.attr("clicked")||o.attr("clicked",!1),o.attr("clicked",!0),o.css("background-color","rgb(70, 133, 191)");var n=a.text();a.text(y.lng_added),setTimeout(function(){o.css("background-color","#002d72"),a.text(n),o.attr("clicked",!1)},100)}}function h(){return o.moduleConfig.params.rootContext.isDataSync}function T(){var r=e.Translations.getTranslatedString;y.lng_newOrder=r("ssa.newOrderItem.newOrder"),y.lng_itemList=r("ssa.newOrderItem.itemList"),y.lng_topList=r("ssa.newOrderItem.topList"),y.lng_orderList=r("ssa.newOrderItem.orderList"),y.lng_searchPlaceHolderText=r("ssa.newOrderItem.searchPlaceHolder"),y.lng_addToCart=r("ssa.newOrderItem.addToCart"),y.lng_added=r("ssa.newOrderItem.added"),y.lng_principal=r("ssa.newOrderItem.principal"),y.lng_allPrincipal=r("ssa.newOrderItem.allPrincipal"),y.lng_noItemCart=r("ssa.msg.info.noItemCart"),y.lng_lastSyncDate=r("ssa.header.lastSyncDate"),y.lng_primaryText=r("ssa.pullToRefreshUtils.primaryText"),y.lng_secondaryText=r("ssa.pullToRefreshUtils.secondaryText")}var y=this;T();var R,P="P_PRICE_LIST_TBL_ITEM";y.handleActivated=function(t){var a=t.valueAccessor().params.ojRouter.parentRouter;console.log("newOrderItem.js parentRouter="+a.currentState().value),y.searchByPrincipal(!1),y.searchText(""),y.scrollPos(0),y.selectItem(R);var n=a.getChildRouter("newOrderItem");n||(n=a.createChildRouter("newOrderItem")),y.router=n.configure(function(r){if(r){var t=new e.RouterState(r,{value:r,enter:function(){y.currOrderId(r),console.log("stateId ="+r)}});return t}}),T(),y.headerSubTitle(y.lng_newOrder),g(),c();var s=o.moduleConfig.params.rootContext.selCustomerProfile;if("undefined"!=typeof s){var i=r.utils.unwrapObservable(s.outletName);r.utils.unwrapObservable(y.large())||i.length>u.TITLE_LENGTH&&(i=i.substring(0,u.TITLE_LENGTH)+"..."),y.headerTitle(i)}else y.headerTitle(y.lng_newOrder);return y.isOrderDeskAdmin=r.computed(function(){var e=o.moduleConfig.params.rootContext.userProfile;return e.salesRole==u.SR_ADMIN||!o.moduleConfig.params.rootContext.isCordova}),y.newOrderNavDataSource=r.computed(function(){var r=[{name:y.lng_itemList,id:"newOrderItem",iconClass:"oj-navigationlist-item-icon demo-icon demo-dashboard-icon"},{name:y.lng_topList,id:"topOrderItem",iconClass:"oj-navigationlist-item-icon demo-icon demo-dashboard-icon"},{name:y.lng_orderList,id:"newOrder",iconClass:"oj-navigationlist-item-icon demo-icon demo-incidents-icon"}];return new e.ArrayTableDataSource(r,{idAttribute:"id"})}),y.newOrderNavChangeHandler=o.newOrderNavChangeHandler,y.newOrderNavStateId(o.moduleConfig.params.rootContext.newOrderNavStateId),e.Router.sync()},console.log("NewOrderItemViewModoel"),y.router=o.router,y.allProduct=r.observableArray(),y.ready=r.observable(!1),y.cart=r.observableArray(),y.currOrderId=r.observable(),y.headerTitle=r.observable(""),y.headerSubTitle=r.observable(),y.newOrderNavStateId=r.observable(),y.totalCnt=r.observable(0),y.payloadKey=r.observable(),y.options=r.observableArray(),y.selectItem=r.observable(),y.syncDatetime=r.observable(),y.showLastSyncDate=r.observable(!1),y.scrollPos=r.observable(0),y.large=r.computed(function(){var r=e.ResponsiveUtils.getFrameworkQuery(e.ResponsiveUtils.FRAMEWORK_QUERY_KEY.LG_UP);return e.ResponsiveKnockoutUtils.createMediaQueryObservable(r)}),y.suggestions=r.observableArray(),y.searchText=r.observable(""),y.lng_searchPlaceHolder=r.observable(y.lng_searchPlaceHolderText),y.searchText.extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}}),y.itemCode=r.observableArray(),y.searchByPrincipal=r.observable(!1),y.payloadKey.subscribe(function(e){console.log("new payloadKey ="+e),f()}),y.refresh=function(){l.showBusy(),m()},y.onPageReady=function(){try{e.PullToRefreshUtils.setupPullToRefresh("#listviewContainer",function(){var e=new Promise(function(e,r){y.onClearSearchText(),m(),setTimeout(function(){e()},3e3)});return e},{primaryText:y.lng_primaryText,secondaryText:y.lng_secondaryText})}catch(e){console.error(e)}},y.products=r.computed(function(){var t=r.utils.unwrapObservable(y.allProduct());if(y.searchText()&&t.length>0&&!y.searchByPrincipal()){var o=y.searchText().toLowerCase(),a=O(t,o);return new e.ArrayTableDataSource(a,{idAttribute:"id"})}var n=r.utils.unwrapObservable(y.selectItem),o=new String(n).toLowerCase(),a=I(t,o);return new e.ArrayTableDataSource(a,{idAttribute:"id"})}),y.handleBindingsApplied=function(e){var r=t("#globalBody").find(".oj-hybrid-applayout-content"),o="oj-hybrid-applayout-scrollable";r.hasClass(o)&&(t("#searchCanvas").on("ojbeforeopen",function(){r.removeClass(o)}),t("#searchCanvas").on("ojbeforeclose",function(){r.addClass(o)})),t("#searchCanvas").on("ojclose",function(){y.clearSearch()})},y.onClearSearchText=function(){y.clearSearch()},y.clearSearch=function(){var e=t("#searchProduct");e.ojInputText("option","value",""),e.ojInputText("reset"),y.searchText("")},y.toggleSearchCanvas=function(){e.OffcanvasUtils.toggle(d)},y.onSearchTextChange=function(e,r){"rawValue"===r.option&&(y.searchByPrincipal(!1),y.searchText(r.value))},y.searchPrincipal=function(e,r){"value"===r.option&&(y.searchByPrincipal(!0),y.searchText(r.value[0]),y.scrollPos(0))},y.addToCart=function(e,t){var a=JSON.stringify({INVENTORY_ITEM_ID:r.utils.unwrapObservable(e.product().id),PRODUCT_DESCRIPTION:r.utils.unwrapObservable(e.product().prod_desc),PRODUCT:r.utils.unwrapObservable(e.product().prod_code),LOT_NUMBER:r.utils.unwrapObservable(e.product().lot),ORDER_QUANTITY_UOM:r.utils.unwrapObservable(e.product().sku),UNIT_SELLING_PRICE:r.utils.unwrapObservable(e.product().price),FLOW_STATUS_CODE:r.utils.unwrapObservable(e.product().delivery_status),PRODUCT_BRAND:r.utils.unwrapObservable(e.product().prod_brand),CURRENCY_CODE:r.utils.unwrapObservable(e.product().currency_code),DRAFT_BEER_FLAG:r.utils.unwrapObservable(e.product().draft_beer_flag)}),i=n.createCartItem(r.utils.parseJson(a),1,!0,s.getClientCurrentDate(),"Y",new Array),l=o.moduleConfig.params.rootContext.originalCart;if(Array.isArray(l)||(l=r.utils.unwrapObservable(l)),"undefined"==typeof l||0==l.length){var u=new Array;u.push(i),o.moduleConfig.params.rootContext.originalCart=u}else o.moduleConfig.params.rootContext.originalCart.push(i);y.totalCnt(r.utils.unwrapObservable(y.totalCnt())+1),w(e,t)},y.checkOut=function(e,t){o.moduleConfig.params.rootContext.fromPage="newOrderItem";var a=o.moduleConfig.params.rootContext.custId;console.log("app.moduleConfig.params.rootContext.originalCart="+r.toJSON(o.moduleConfig.params.rootContext.originalCart));var s=n.allowCheckOut(o.moduleConfig.params.rootContext.originalCart);s?o.redirect("checkOut",a):l.showMessageBox(y.lng_noItemCart)},y.goBack=function(e,t){console.log("goBack clicked");var a=o.moduleConfig.params.rootContext.fromPage;if(h()||"orderHist"!==a&&"newOrder"!==a&&"newOrderItem"!==a){var n=r.utils.unwrapObservable(y.currOrderId);o.redirect("orderDetail",n)}else{var s=o.moduleConfig.params.rootContext.custId;o.redirect("orderHist",s)}},y.dispose=function(e){y.router.dispose()}}var d;return d={selector:"#searchCanvas",edge:"top",displayMode:"push",size:"63px",modality:"modeless",autoDismiss:"none"},r.bindingHandlers.searchCanvas={init:function(t,o,a){r.utils.domNodeDisposal.addDisposeCallback(t,function(){t&&e.OffcanvasUtils.close(d)})}},r.bindingHandlers.winsize={init:function(e,r,o,a,n){t(window).resize(function(){a.screenWidth(t(window).width()),a.screenHeight(t(window).height())})}},r.bindingHandlers.currency={symbol:r.observable("$"),update:function(e,t,o){return r.bindingHandlers.text.update(e,function(){var e=+(r.utils.unwrapObservable(t())||0),a=r.utils.unwrapObservable(void 0===o().symbol?o().sybmol:"$");return a+e.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")})}},new c});