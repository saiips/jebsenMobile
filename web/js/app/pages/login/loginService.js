define(["knockout","jquery","amplify","config/appconfig","util/devmode","util/appui","appController","pages/common/constant","pages/common/maintenance"],function(e,t,o,r,n,i,s,a,c){function u(){function u(){var e=s.moduleConfig.params.rootContext.userProfile.orgUnitId,t=s.moduleConfig.params.rootContext.userProfile.erpSalesId,o=s.moduleConfig.params.rootContext.userProfile,r=JSON.stringify({InputGetInitCount:{HeaderInfo:{UserID:o.username,UserRole:o.salesRole,CallerID:""},P_ORG_ID:e,P_SALESREP_ID:t,P_APP_ROLE:o.salesRole,P_CP_NUMBER:o.licenseNo}});return r}function f(){var e,t,o=s.moduleConfig.params.rootContext.userProfile;o.orgUnitId&&""!=o.orgUnitId?(e=o.username,t=o.salesRole,orgUnitId=o.orgUnitId):(e=a.SR_DUMMY,t=a.SR_DUMMY,orgUnitId=null);var r=JSON.stringify({InputGetAppVersion:{HeaderInfo:{UserID:e,UserRole:t,CallerID:""},P_ORG_ID:orgUnitId}});return r}this.getOAuthToken=function(){var e=r.get("clientID"),t=r.get("clientSecret"),o=l.encode(e+":"+t);return o},this.getToken=function(e,t){var o=l.encode(e+":"+t);return o},this.login=function(e,c){var u=l.encode(e+":"+c),f={Authorization:"Basic "+u,"Oracle-Mobile-Backend-ID":r.get("mobileBackendId"),"Content-Type":"application/json; charset=utf-8",Mock:r.get("useMockDataFromMCS")};this.init(f);var d=t.Deferred();if(n.isEnabled()&&n.isOffline())t.getJSON("js/app/pages/login/loginMock.json",function(e){setTimeout(function(){d.resolve(e,{status:200})},500)});else{var g=s.moduleConfig.params.rootContext.isOnline;if(g)o.request({resourceId:"login",success:d.resolve,error:d.reject,data:{id:e}}),t.when(d).done(function(e,t,o){200==t.status&&(i.setLocalStorage(a.BASE64_LOGON_TOKEN,u),i.setLocalStorage(a.USER_PROFILE,e))});else{var h=i.getLocalStorage(a.BASE64_LOGON_TOKEN);if(u==h){var C=i.getLocalStorage(a.USER_PROFILE);d.resolve(C,{status:200})}else d.reject(null,{status:401})}}return t.when(d)},this.init=function(e){var o=e||{};t.ajaxSetup({headers:o}),n.preserveAuthHeaders(o)},this.getInitiaLoadRequest=function(r){var i=t.Deferred(),s=u();console.log("payload ="+e.toJS(s)),console.log("requireInitLoad = "+r);var c=e.utils.parseJson(s),l=c.InputGetInitCount.P_ORG_ID,f=c.InputGetInitCount.P_SALESREP_ID,d=c.InputGetInitCount.P_APP_ROLE,g=c.InputGetInitCount.P_CP_NUMBER,h=a.INITIAL_LOAD_REQUEST_KEY+":"+l+":"+f+":"+d+":"+g;return"Y"!=r||n.isEnabled()&&n.isOffline()?(t.getJSON("js/app/pages/login/getInitRequestMock.json",function(e){setTimeout(function(){i.resolve(e,{status:200})},500)}),t.when(i)):(console.log("[Amplify Request] Initial Load Request - "+h),o.request({resourceId:a.INITIAL_LOAD_REQUEST_KEY,success:i.resolve,error:i.reject,data:s}),t.when(i))},this.getAppVersion=function(){var e=t.Deferred(),r=f(),i=s.moduleConfig.params.rootContext.isOnline,u=c.isMaintenance(),l=s.moduleConfig.params.rootContext.isCordova,d=a.APP_VERSION_KEY;if(!i||u||!l||n.isEnabled()&&n.isOffline()){var g=JSON.stringify({P_FRONTEND_VER:"1.0.0.1",P_BACKEND_VER:"1.0.0.1"});return setTimeout(function(){e.resolve(g,{status:200})},500),t.when(e)}return console.log("[Amplify Request] Get App Version - "+d),o.request({resourceId:a.APP_VERSION_KEY,success:e.resolve,error:e.reject,data:r}),t.when(e)},this.registerDeviceForMCSPush=function(){var i=t.Deferred();if(n.isEnabled()&&n.isOffline())i.resolve();else if("undefined"!=typeof PushNotification){console.log("Push Notification exists!!!");try{var s=r.get("androidProjectID"),a=PushNotification.init({android:{senderID:s,icon:"ic_logo",iconColor:"blue",forceShow:"true"},ios:{alert:"true",badge:"true",sound:"true"},windows:{}});a.on("registration",function(e){var t="ios"===cordova.platformId?"IOS":"ANDROID",n=JSON.stringify({notificationToken:e.registrationId,mobileClient:{id:"IOS"===t?r.get("bundleId"):r.get("applicationId"),version:"1.0",platform:t},notificationProvider:"IOS"===t?"APNS":"FCM"});console.log("Reg Device PL: "+n),o.request({resourceId:"registerDevice",data:n,success:i.resolve,error:i.reject})}),a.on("notification",function(t){console.log("Push Notification from Oracle MCS= "+e.toJSON(t))}),a.on("error",function(e){console.log("Push Notification Error="+e.message),i.reject()})}catch(e){console.log("Error registering device with MCS for Push Notifications: "+e),i.reject()}}else console.log("PushNotification NOT Defined!"),i.reject();return t.when(i)}}var l={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,o,r,n,i,s,a,c="",u=0;for(e=l._utf8_encode(e);u<e.length;)t=e.charCodeAt(u++),o=e.charCodeAt(u++),r=e.charCodeAt(u++),n=t>>2,i=(3&t)<<4|o>>4,s=(15&o)<<2|r>>6,a=63&r,isNaN(o)?s=a=64:isNaN(r)&&(a=64),c=c+this._keyStr.charAt(n)+this._keyStr.charAt(i)+this._keyStr.charAt(s)+this._keyStr.charAt(a);return c},decode:function(e){var t,o,r,n,i,s,a,c="",u=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");u<e.length;)n=this._keyStr.indexOf(e.charAt(u++)),i=this._keyStr.indexOf(e.charAt(u++)),s=this._keyStr.indexOf(e.charAt(u++)),a=this._keyStr.indexOf(e.charAt(u++)),t=n<<2|i>>4,o=(15&i)<<4|s>>2,r=(3&s)<<6|a,c+=String.fromCharCode(t),64!=s&&(c+=String.fromCharCode(o)),64!=a&&(c+=String.fromCharCode(r));return c=l._utf8_decode(c)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",o=0;o<e.length;o++){var r=e.charCodeAt(o);r<128?t+=String.fromCharCode(r):r>127&&r<2048?(t+=String.fromCharCode(r>>6|192),t+=String.fromCharCode(63&r|128)):(t+=String.fromCharCode(r>>12|224),t+=String.fromCharCode(r>>6&63|128),t+=String.fromCharCode(63&r|128))}return t},_utf8_decode:function(e){for(var t="",o=0,r=c1=c2=0;o<e.length;)r=e.charCodeAt(o),r<128?(t+=String.fromCharCode(r),o++):r>191&&r<224?(c2=e.charCodeAt(o+1),t+=String.fromCharCode((31&r)<<6|63&c2),o+=2):(c2=e.charCodeAt(o+1),c3=e.charCodeAt(o+2),t+=String.fromCharCode((15&r)<<12|(63&c2)<<6|63&c3),o+=3);return t}};return new u});