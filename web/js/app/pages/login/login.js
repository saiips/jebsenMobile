define(["ojs/ojcore","knockout","jquery","appController","util/appui","pages/login/loginService","util/devmode","config/appconfig","pages/common/constant","pages/common/maintenance","ojs/ojswitch","ojs/ojbutton","ojs/ojinputtext","ojs/ojcheckboxset"],function(e,o,n,a,t,s,r,i,l,g){function c(){function c(){N(),S(),_(),m.userChanged(!1),m.registerMCS(!0),r.isEnabled()&&R(),navigator.app&&(navigator.app.backAction=function(e){e.preventDefault(),navigator.app.exitApp()})}function d(){return f()?C:O}function f(){var e=t.getLocalStorage(l.REQUIRE_INIT_LOAD);return"Y"==e||"undefined"==typeof e}function _(){E(null),s.init()}function E(e){var o={};if(e){e.displayName=e.firstName+" "+e.lastName,o.displayName=e.displayName,o.username=e.username,o.email=e.email,o.firstName=e.firstName,o.lastName=e.lastName;var n=e.attributes[l.EXTENTED_ATTRIBUTE];o.salesRole=n.salesRole,o.erpSalesId=n.erpSalesId,o.orgUnitId=n.orgUnitId,o.licenseNo=n.licenseNo}else o=e;a.moduleConfig.params.rootContext.userProfile=o}function R(){m.useMCSMock=o.observable(r.useMCSMock()),m.isOffline=o.observable(r.isOffline()),v.push(m.useMCSMock.subscribe(function(e){r.useMCSMock(e)})),v.push(m.isOffline.subscribe(function(e){r.isOffline(e)}))}function S(){var e=!0;if(e===!0){m.rememberMe(!0);var o=t.getLocalStorage(u);null!==o&&m.username(o)}else m.rememberMe(!1)}function p(){m.rememberMe()?(t.setLocalStorage(u,m.username()),t.setLocalStorage(I,!0)):(t.setLocalStorage(u,null),t.setLocalStorage(I,!1))}function N(){var o=e.Translations.getTranslatedString;m.lng_selfServiceApp=o("ssa.login.selfServiceApp"),m.lng_apptitle=o("ssa.apptitle"),m.lng_signIn=o("ssa.login.signIn"),m.lng_username=o("ssa.login.username"),m.lng_password=o("ssa.login.password"),m.lng_copyright=o("ssa.login.copyright"),m.lng_accountAccess=o("ssa.login.accountAccess"),m.lng_rememberMe=o("ssa.login.rememberMe"),m.lng_cancel=o("ssa.menu.cancel"),m.lng_invalidLogin=o("ssa.login.invalidLogin"),m.lng_cantSignInMsg=o("ssa.login.cantSignInMsg"),m.lng_requireInitalLoad=o("ssa.msg.info.requireInitalLoad"),m.lng_newVersion=o("ssa.msg.info.newVersion")}var m=this;m.router=a.router;var v=[];m.username=o.observable(),m.password=o.observable(),m.isDevMode=o.observable(r.isEnabled()),m.rememberMe=o.observable(!0),m.forgotPasswordURL=o.observable(i.get("forgotPasswordURL")),m.buildVersion=o.observable(a.moduleConfig.params.rootContext.buildVersion+" ("+a.moduleConfig.params.rootContext.environment+")"),m.userChanged=o.observable(!1),m.registerMCS=o.observable(!0);var L=e.ResponsiveUtils.getFrameworkQuery(e.ResponsiveUtils.FRAMEWORK_QUERY_KEY.LG_UP);m.large=e.ResponsiveKnockoutUtils.createMediaQueryObservable(L);var O="springboard",C="initLoad";m.onPageReady=function(){},m.signIn=function(r,i){t.showBusy(),console.log(":::::::::: Sign In ::::::::::"),s.login(m.username(),m.password()).done(function(e){var o=t.getLocalStorage(u);"undefined"==typeof o||o!=m.username()?(m.userChanged(!0),a.moduleConfig.params.rootContext.isUserChanged=!0,n.each(amplify.store(),function(e){e!=l.DEV_OPTS_KEY&&e!=l.DEV_AUTH_HEADERS_KEY&&amplify.store(e,null)})):a.moduleConfig.params.rootContext.isUserChanged=!1,E(e),p(),console.log("********* initial maintenance window *******"),g.init()}).then(function(){var e=s.getToken(m.username(),m.password());t.setLocalStorage(l.BASE64_LOGON_TOKEN,e),t.setLocalStorage(l.USER_PROFILE,a.moduleConfig.params.rootContext.userProfile)}).fail(function(e){console.log(":::::::::: Logon Failed  ::::::::::"),t.hideBusy(),t.showMessageBox(m.lng_invalidLogin)}).then(function(){console.log(":::::::::: Get the App Version  ::::::::::"),s.getAppVersion().then(function(e){var n=a.moduleConfig.params.rootContext.isOnline,s=g.isMaintenance(),r=a.moduleConfig.params.rootContext.isCordova;console.log("getAppVersion = "+o.toJSON(e)),Array.isArray(e)&&(e=e[0]);var i=e,c=i.P_FRONTEND_VER,u=i.P_BACKEND_VER,I=new String(a.moduleConfig.params.rootContext.buildVersion),d=new String(t.getLocalStorage(l.CLIENT_FRONTEND_VERSION)),f=new String(t.getLocalStorage(l.CLIENT_BACKEND_VERSION));console.log("Server [frontend version] ="+c),console.log("Config [build version] ="+I),console.log("Cached [build version] ="+d),console.log("Server [backend version] ="+u),console.log("Client [backend version] ="+f),n&&!s&&!m.isDevMode()&&r&&("undefined"==typeof d||"undefined"==typeof f?(t.setLocalStorage(l.REQUIRE_INIT_LOAD,"Y"),t.setLocalStorage(l.CONFIRMATION_REQUIRE_INIT_LOAD,!1),t.setLocalStorage(l.CLIENT_BACKEND_VERSION,u),t.setLocalStorage(l.CLIENT_FRONTEND_VERSION,I)):new String(d).valueOf()!=new String(I).valueOf()||new String(f).valueOf()!=new String(u).valueOf()?(t.setLocalStorage(l.REQUIRE_INIT_LOAD,"Y"),t.setLocalStorage(l.CONFIRMATION_REQUIRE_INIT_LOAD,!0),t.setLocalStorage(l.CLIENT_BACKEND_VERSION,u),t.setLocalStorage(l.CLIENT_FRONTEND_VERSION,I)):(t.setLocalStorage(l.REQUIRE_INIT_LOAD,"N"),t.setLocalStorage(l.CONFIRMATION_REQUIRE_INIT_LOAD,!1))),m.userChanged()&&(t.setLocalStorage(l.REQUIRE_INIT_LOAD,"Y"),t.setLocalStorage(l.CONFIRMATION_REQUIRE_INIT_LOAD,!1)),n&&!s&&!m.isDevMode()&&r||(t.setLocalStorage(l.REQUIRE_INIT_LOAD,"N"),t.setLocalStorage(l.CONFIRMATION_REQUIRE_INIT_LOAD,!1));var _=a.moduleConfig.params.rootContext.userProfile;if(_.salesRole!=l.SR_DRIVER_JLOG&&_.salesRole!=l.SR_DRIVER_LINDE||(t.setLocalStorage(l.REQUIRE_INIT_LOAD,"N"),t.setLocalStorage(l.CONFIRMATION_REQUIRE_INIT_LOAD,!1)),_.salesRole==l.SR_ADMIN){var E=t.getLocalStorage(l.ORDER_DESK_VERSION);"undefined"==typeof E?(t.setLocalStorage(l.REQUIRE_INIT_LOAD,"Y"),t.setLocalStorage(l.ORDER_DESK_VERSION,"Y")):t.setLocalStorage(l.REQUIRE_INIT_LOAD,"N");var E=t.getLocalStorage(l.ORDER_DESK_VERSION);console.log("cachedOrderDeskVersion="+E)}n&&!m.isDevMode()&&!s&&r&&new String(I).valueOf()!=new String(c).valueOf()&&(m.registerMCS(!1),t.hideBusy(),t.showMessageBox(m.lng_newVersion))}).then(function(){var n=d();if(console.log("initLandingPage = "+n),m.registerMCS())s.registerDeviceForMCSPush().then(function(e){console.log(":::::::::: Device registered for MCS Push Notifications ::::::::::"),console.log(o.toJSON(e))},function(e,o,n){console.log("ERROR DEV REG: "+e)}).then(function(){t.hideBusy();var o=t.getLocalStorage(l.CONFIRMATION_REQUIRE_INIT_LOAD);console.log("confirmDownload ="+o),o?confirm(m.lng_requireInitalLoad)?e.Router.rootInstance.go(n):e.Router.rootInstance.go("login"):e.Router.rootInstance.go(n)});else{var r=a.moduleConfig.params.rootContext.userProfile;r.salesRole==l.SR_ADMIN&&(t.hideBusy(),e.Router.rootInstance.go(n))}})})},m.onCannotSignIn=function(){t.showMessageBox(m.lng_selfServiceApp,m.lng_cantSignInMsg)},m.handleDetached=function(){navigator.app&&navigator.app.backAction&&delete navigator.app.backAction},m.dispose=function(){for(var e=0;e<v.length;e++)v[e].dispose()},m.showPassword=function(){var e=document.getElementById("text-password");"password"==e.type?e.type="text":e.type="password"},c(),n(document).ready(function(){"undefined"==typeof m.username()||m.username().length<=0?document.getElementById("text-username").focus():document.getElementById("text-password").focus()})}var u=l.LOGIN_USER_KEY,I=l.LOGIN_REMEMBER_KEY;return o.bindingHandlers.executeOnEnter={init:function(e,o,a,t){var s=o();n(e).keypress(function(e){var o=e.which?e.which:e.keyCode;return 13!==o||(s.call(t),!1)})}},c});