define(["ojs/ojcore","knockout","jquery","amplify","util/appui","util/devmode","appController","config/appconfig","pages/common/constant","pages/initLoad/initLoadService","pages/login/loginService","ojs/ojdialog","ojs/ojrouter","ojs/ojnavigationlist"],function(e,o,t,n,r,a,i,s,l,d,g){function u(){function a(){var e=i.moduleConfig.params.rootContext.totalRequest,t=i.moduleConfig.params.rootContext.completedRequest,n=i.moduleConfig.params.rootContext.trackedRequest;if(100==C.percentage().toFixed(0))return 100;if(C.percentage().toFixed(0)>0&&C.percentage().toFixed(0)<100){if(console.log("trackedRequest="+o.toJSON(n)),isNaN(n[t])){for(var r in i.moduleConfig.params.rootContext.trackedRequest)delete i.moduleConfig.params.rootContext.trackedRequest[r];n[t]=1}else if(n[t]=new Number(n[t])+1,new Number(n[t])>=l.INIT_LOAD_WAIT_COUNT)return 100;i.moduleConfig.params.rootContext.trackedRequest=n}return t>=e?100:"undefined"!=typeof e?t/e*100:0}function u(){var e=i.moduleConfig.params.rootContext.isOnline;return"undefined"==typeof e&&(e=deviceReady.isOnline()),e}function c(){console.log("init"),console.log("Initialize initLoadMap and completedRequest");var e=i.moduleConfig.params.rootContext.isOnline,a=!1;i.moduleConfig.params.rootContext.initLoadMap={},i.moduleConfig.params.rootContext.completedRequest=0,i.moduleConfig.params.rootContext.trackedRequest={},t.each(n.store(),function(e){e!=l.LOGIN_USER_KEY&&e!=l.LOGIN_REMEMBER_KEY&&e!=l.BASE64_LOGON_TOKEN&&e!=l.USER_PROFILE&&e!=l.CLIENT_FRONTEND_VERSION&&e!=l.CLIENT_BACKEND_VERSION&&e!=l.LOCALE_KEY&&e!=l.DEV_OPTS_KEY&&e!=l.DEV_AUTH_HEADERS_KEY&&e!=l.ORDER_DESK_VERSION&&e!=l.PRINTER_MAC_ADDRESS&&e!=l.PRINTER_SERIAL_NO&&n.store(e,null)}),console.log(":::::::::: Get the Initial Request Count ::::::::::");var s=r.getLocalStorage(l.REQUIRE_INIT_LOAD);"undefined"!=typeof s||e?"undefined"==typeof s&&e&&(s="Y"):s="N",console.log("requireInitLoad = "+s);var d=i.moduleConfig.params.rootContext.userProfile;if(d.salesRole==l.SR_ADMIN&&(a=!0),a){var u=1,c=1,p=2,m=2,_=2,R=m+u+c+p+_;i.moduleConfig.params.rootContext.totalRequest=R,i.moduleConfig.params.rootContext.completedRequest=0,console.log("getInitialLoadRequest totalRequest = "+R),"Y"==s||"undefined"==typeof s?(C.ready(!0),C.percentage(0),f()):(C.ready(!1),C.percentage(100),i.go("springboard"))}else g.getInitiaLoadRequest(s).then(function(e){console.log("getInitialLoadRequest = "+o.toJSON(e));var t=i.moduleConfig.params.rootContext.userProfile;Array.isArray(e)&&(e=e[0]);var n=e,r=1,a=1,s=1,d=1,g=n.P_CUST_CNT,u=(n.P_PLIST_CNT,n.P_ORDER_CNT,n.P_QUOTE_CNT),c=n.P_DN_CNT,p=1,m=new Number(g),f=t.salesRole==l.SR_SALE_VAN?0:new Number(g),_=0;t.salesRole==l.SR_MOBILE_SALE&&t.orgUnitId==l.ORG_UNIT_ID_WINE&&(_=new Number(g)+new Number(u));var C=0;t.salesRole==l.SR_SALE_VAN&&(C=d+new Number(c));var R=p+r+a+s+m+f+_+C;i.moduleConfig.params.rootContext.totalRequest=R,i.moduleConfig.params.rootContext.completedRequest=0,console.log("getInitialLoadRequest totalRequest = "+R)}).then(function(){"Y"==s||"undefined"==typeof s?(C.ready(!0),C.percentage(0),f()):(C.ready(!1),C.percentage(100),i.go("springboard"))})}function p(){console.log("completeInitLoad started");var e=i.moduleConfig.params.rootContext.userProfile,o=!1;e.salesRole==l.SR_ADMIN&&(o=!0);var t=r.getLocalStorage(l.REQUIRE_INIT_LOAD);"Y"!=t&&"undefined"!=typeof t||(r.setLocalStorage(l.REQUIRE_INIT_LOAD,"N"),i.moduleConfig.params.rootContext.initDataSync="N",i.moduleConfig.params.rootContext.requireRefresh=!0,o||(i.moduleConfig.params.rootContext.refreshCustomerList=!0),100==C.percentage()&&(r.showMessageBox(C.lng_jebsenMobile,C.lng_downloadComplete),m(),i.go("springboard")))}function m(){console.log("Total Request Count :"+o.toJSON(i.moduleConfig.params.rootContext.initLoadMap))}function f(){console.log("runDataOffline started");var e=(s.get("environment"),i.moduleConfig.params.rootContext.userProfile),t=!1;e.salesRole==l.SR_ADMIN&&(t=!0),o.tasks.schedule(function(){d.registerSubInventoryList(),d.registerShipmentMethodList(),t?(d.registerWineSalesPersonList(),d.registerBeerSalesPersonList(),d.registerWinePriceList(),d.registerBeerPriceList(),d.registerWineCustomerList(),d.registerBeerCustomerList()):(d.registerPriceList(),d.registerCustomerList()),e.salesRole==l.SR_SALE_VAN&&d.registerDeliveryList()})}function _(){var o=e.Translations.getTranslatedString;C.lng_initialLoading=o("ssa.initLoad.initialLoading"),C.lng_jebsenMobile=o("ssa.initLoad.jebsenMobile"),C.lng_error_00015=o("ssa.msg.error.ERROR_00015"),C.lng_downloadComplete=o("ssa.msg.info.downloadComplete"),C.lng_loadingModule=o("ssa.initLoad.PRE_LOAD_MSG")}var C=this;C.percentage=o.observable(0),C.ready=o.observable(!1),_();var R=setInterval(function(){C.percentage(a())},s.get("refreshProgress"));C.percentage.subscribe(function(){100==C.percentage()&&(clearTimeout(R),p())}),C.handleActivated=function(e){console.log("handleActivated");var o=u();o?c():(r.showMessageBox(C.lng_jebsenMobile,C.lng_error_00015),i.go("login"))}}return o.bindingHandlers.progressBar={init:function(e){return{controlsDescendantBindings:!0}},update:function(e,n,r){var a=o.unwrap(n()),i=a.value().toFixed(0),s=i+"%";t(e).addClass("progressBar"),o.applyBindingsToNode(e,{html:"<div data-bind=\"style: { width: '"+s+'\' }"></div><div class="progressText" data-bind="text: \''+i+" %'\"></div>"}),o.applyBindingsToDescendants(r,e)}},u});