define(["ojs/ojcore","knockout","jquery","appController","pages/newOrder/newOrderService","pages/common/cartService","util/commonhelper","util/appui","pages/common/constant","promise","ojs/ojlistview","ojs/ojjsontreedatasource","ojs/ojpagingcontrol","ojs/ojnavigationlist","ojs/ojrouter","ojs/ojtoolbar","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojarraytabledatasource","ojs/ojpulltorefresh","ojs/ojvalidation","ojs/ojoffcanvas"],function(e,t,o,a,r,n,i,s,l){function u(){function u(){var e=a.moduleConfig.params.rootContext.userProfile,o=t.utils.unwrapObservable(e.orgUnitId),r=a.moduleConfig.params.rootContext.selCustomerProfile,n=t.utils.unwrapObservable(r.id),i=l.PRICE_ID_WINE;I.payloadKey(e.username+":"+o+":"+n+":"+i)}function d(){var e=a.moduleConfig.params.rootContext.userProfile,o=a.moduleConfig.params.rootContext.userProfile.orgUnitId,r=l.PRICE_ID_WINE,n=[],i=[];n.push(r);for(var s=0;s<n.length;s++)i.push({PRICE_LIST_ID:n[s]});var u=JSON.stringify({InputGetPriceList:{HeaderInfo:{UserID:e.username,UserRole:e.salesRole,CallerID:""},P_ORG_ID:o,P_PRICE_LIST_ID_TBL:{P_PRICE_LIST_ID_TBL_ITEM:i}}});return console.log("payload = "+t.toJS(u)),u}function p(){var e=a.moduleConfig.params.rootContext.originalQuotationCart;console.log("_cart = "+t.toJSON(e)),Array.isArray(e)||(e=t.utils.unwrapObservable(e)),console.log("isArray(_cart) = "+Array.isArray(e)),Array.isArray(e)&&I.totalCnt(e.length)}function g(){console.log("newQuotationItem.js init() started"),I.ready(!1),s.showBusy(),p(),b()}function b(){var e=function(e,t){try{C(e,t.status)}catch(e){console.error(e),s.hideBusy()}finally{console.log("cbSuccessFn called"),s.hideBusy()}},t=function(e,t){console.log("cbFailFn failed"),C(e,t.status),s.hideBusy()};r.getPriceListMessage(d()).then(e,t)}function C(o,a){if(console.log("prepareUI triggered"),o=Array.isArray(o)?o[0]:o,null!==o&&200==a){var r=o[w],l=[],u=[];Array.isArray(r)||(r=new Array(r));for(var c=0;c<r.length;c++){var d=JSON.stringify({INVENTORY_ITEM_ID:r[c].INVENTORY_ITEM_ID,PRODUCT_DESCRIPTION:r[c].PRODUCT_DESCRIPTION,DESCRIPTION:r[c].DESCRIPTION,PRODUCT:r[c].PRODUCT,LOT_NUMBER:"",ORDER_QUANTITY_UOM:r[c].PRODUCT_UOM_CODE,UNIT_SELLING_PRICE:r[c].UNIT_PRICE,FLOW_STATUS_CODE:"",PRODUCT_BRAND:r[c].PRODUCT_BRAND,PRINCIPAL:r[c].PRINCIPAL,CURRENCY_CODE:r[c].CURRENCY_CODE,DRAFT_BEER_FLAG:r[c].DRAFT_BEER_FLAG});cart_item=n.createCartItem(t.utils.parseJson(d),0,!0,i.getClientCurrentDate(),"Y",new Array),l[c]=cart_item,u.indexOf(t.utils.unwrapObservable(cart_item.product().principal))<0&&u.push(t.utils.unwrapObservable(cart_item.product().principal))}I.allProduct(l),I.uniquePrincipals=t.dependentObservable(function(){return t.utils.arrayGetDistinctValues(u)});var p=t.utils.unwrapObservable(I.uniquePrincipals()),g=new Map,b=[],C="";for(tagIndex in p)if(p[tagIndex].trim().length>0){var m=p[tagIndex];if(g.get(m)!==m){""===C&&(C=m,_=m),g.set(m,m);var f={value:m,label:m};b.push(f)}}I.selectItem=C,I.options=t.observableArray(b),v(),I.products=t.computed(function(){var o=t.utils.unwrapObservable(I.allProduct());if(I.searchText()&&o.length>0&&!I.searchByPrincipal()){var a=I.searchText().toLowerCase(),r=t.utils.arrayFilter(o,function(e){return e.product().prod_desc().toLowerCase().indexOf(a)>=0||e.product().prod_code().toLowerCase().indexOf(a)>=0||e.product().prod_brand().toLowerCase().indexOf(a)>=0});return new e.ArrayTableDataSource(r,{idAttribute:"id"})}var a=I.selectItem.toString().toLowerCase(),r=t.utils.arrayFilter(o,function(e){return e.product().principal().toLowerCase().indexOf(a)>=0});return new e.ArrayTableDataSource(r,{idAttribute:"id"})}),s.hideBusy(),I.ready(!0)}}function v(){I.suggestions=function(e){return new Promise(function(o,a){var r=e.term,n=[],i=t.utils.unwrapObservable(I.uniquePrincipals());if(r){var s=new RegExp(r,"i");for(tagIndex in i)t.utils.unwrapObservable(i[tagIndex]).search(s)>=0&&n.push(i[tagIndex])}else n=i;var l=[];for(tagIndex in n){var u={itemLabel:n[tagIndex],itemCode:n[tagIndex]};l.push(u)}var c={groupId:"groupId",groupName:"Item Code Suggestions",items:l};l.length>0&&o(c)})}}function m(e,t){var a,r;if("SPAN"==t.target.tagName?(r=o(t.target),a=o(t.target.parentNode)):"A"==t.target.tagName&&(r=o(t.target).find("span"),a=o(t.target)),!a.attr("clicked")||"true"!=a.attr("clicked")){a.attr("clicked")||a.attr("clicked",!1),a.attr("clicked",!0),a.css("background-color","rgb(70, 133, 191)");var n=r.text();r.text(I.lng_added),setTimeout(function(){a.css("background-color","#002d72"),r.text(n),a.attr("clicked",!1)},100)}}function f(){var t=e.Translations.getTranslatedString;I.lng_newQuotation=t("ssa.newQuotationItem.newQuotation"),I.lng_itemList=t("ssa.newQuotationItem.itemList"),I.lng_topList=t("ssa.newQuotationItem.topList"),I.lng_quotationList=t("ssa.newQuotationItem.quotationList"),I.lng_searchPlaceHolderText=t("ssa.newQuotationItem.searchPlaceHolder"),I.lng_addToCart=t("ssa.newQuotationItem.addToCart"),I.lng_added=t("ssa.newQuotationItem.added"),I.lng_principal=t("ssa.newQuotationItem.principal"),I.lng_noItemCart=t("ssa.msg.info.noItemCart")}var I=this;f();var _,w="P_PRICE_LIST_TBL_ITEM";I.handleActivated=function(o){var r=o.valueAccessor().params.ojRouter.parentRouter;console.log("newQuotationItem.js parentRouter="+r.currentState().value),I.searchByPrincipal(!1),I.searchText(""),I.scrollPos(0),I.selectItem=_;var n=r.getChildRouter("newQuotationItem");n||(n=r.createChildRouter("newQuotationItem")),I.router=n.configure(function(t){if(t){var o=new e.RouterState(t,{value:t,enter:function(){I.currQuotationId(t),console.log("stateId ="+t)}});return o}}),f(),I.headerSubTitle(I.lng_newQuotation);var i=a.moduleConfig.params.rootContext.selCustomerProfile;if("undefined"!=typeof i){var s=t.utils.unwrapObservable(i.outletName);t.utils.unwrapObservable(I.large())||s.length>l.TITLE_LENGTH&&(s=s.substring(0,l.TITLE_LENGTH)+"..."),I.headerTitle(s)}else I.headerTitle("");return p(),u(),I.newQuotationNavDataSource=t.computed(function(){var t=[{name:I.lng_itemList,id:"newQuotationItem",iconClass:"oj-navigationlist-item-icon demo-icon demo-dashboard-icon"},{name:I.lng_topList,id:"topQuotationItem",iconClass:"oj-navigationlist-item-icon demo-icon demo-dashboard-icon"},{name:I.lng_quotationList,id:"newQuotation",iconClass:"oj-navigationlist-item-icon demo-icon demo-incidents-icon"}];return new e.ArrayTableDataSource(t,{idAttribute:"id"})}),I.newQuotationNavChangeHandler=a.newQuotationNavChangeHandler,I.newQuotationNavStateId(a.moduleConfig.params.rootContext.newQuotationNavStateId),e.Router.sync()},console.log("NewQuotationItemViewModoel"),I.router=a.router,I.allProduct=t.observableArray(),I.ready=t.observable(!1),I.cart=t.observableArray(),I.currQuotationId=t.observable(),I.headerTitle=t.observable(""),I.headerSubTitle=t.observable(""),I.newQuotationNavStateId=t.observable(),I.totalCnt=t.observable(0),I.payloadKey=t.observable(),I.scrollPos=t.observable(0),I.selectItem=t.observable(),I.large=t.computed(function(){var t=e.ResponsiveUtils.getFrameworkQuery(e.ResponsiveUtils.FRAMEWORK_QUERY_KEY.LG_UP);return e.ResponsiveKnockoutUtils.createMediaQueryObservable(t)}),I.suggestions=t.observableArray(),I.searchText=t.observable(""),I.searchByPrincipal=t.observable(!1),I.payloadKey.subscribe(function(e){console.log("new payloadKey ="+e),g()}),I.lng_searchPlaceHolder=t.observable(I.lng_searchPlaceHolderText),I.searchText.extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}}),I.itemCode=t.observableArray(),I.handleBindingsApplied=function(e){var t=o("#globalBody").find(".oj-hybrid-applayout-content"),a="oj-hybrid-applayout-scrollable";t.hasClass(a)&&(o("#searchCanvas").on("ojbeforeopen",function(){t.removeClass(a)}),o("#searchCanvas").on("ojbeforeclose",function(){t.addClass(a)})),o("#searchCanvas").on("ojclose",function(){I.clearSearch()})},I.onClearSearchText=function(){I.clearSearch()},I.clearSearch=function(){var e=o("#searchProduct");e.ojInputText("option","value",""),e.ojInputText("reset"),I.searchText("")},I.toggleSearchCanvas=function(){e.OffcanvasUtils.toggle(c)},I.onSearchTextChange=function(e,t){"rawValue"===t.option&&(I.searchByPrincipal(!1),I.searchText(t.value))},I.searchPrincipal=function(e,t){"value"===t.option&&(I.searchByPrincipal(!0),I.searchText(t.value[0]),I.scrollPos(0))},I.addToCart=function(e,o){var r=!1,s=JSON.stringify({INVENTORY_ITEM_ID:t.utils.unwrapObservable(e.product().id),PRODUCT_DESCRIPTION:t.utils.unwrapObservable(e.product().prod_desc),PRODUCT:t.utils.unwrapObservable(e.product().prod_code),LOT_NUMBER:t.utils.unwrapObservable(e.product().lot),ORDER_QUANTITY_UOM:t.utils.unwrapObservable(e.product().sku),UNIT_SELLING_PRICE:t.utils.unwrapObservable(e.product().price),FLOW_STATUS_CODE:t.utils.unwrapObservable(e.product().delivery_status),PRODUCT_BRAND:t.utils.unwrapObservable(e.product().prod_brand),CURRENCY_CODE:t.utils.unwrapObservable(e.product().currency_code),DRAFT_BEER_FLAG:t.utils.unwrapObservable(e.product().draft_beer_flag)}),l=n.createCartItem(t.utils.parseJson(s),1,!0,i.getClientCurrentDate(),"Y",new Array),u=a.moduleConfig.params.rootContext.originalQuotationCart;if(Array.isArray(u)||(u=t.utils.unwrapObservable(u)),"undefined"==typeof u||0==u.length){var c=new Array;c.push(l),a.moduleConfig.params.rootContext.originalQuotationCart=c,r=!0}else{var d=t.utils.arrayFirst(u,function(o){if(t.utils.unwrapObservable(e.product().id)==t.utils.unwrapObservable(o.product().id))return o});null!=d&&"undefined"!=typeof d||(r=!0,a.moduleConfig.params.rootContext.originalQuotationCart.push(l))}r&&(I.totalCnt(t.utils.unwrapObservable(I.totalCnt())+1),m(e,o))},I.checkOut=function(e,o){console.log("app.moduleConfig.params.rootContext.originalQuotationCart="+t.toJSON(a.moduleConfig.params.rootContext.originalQuotationCart));var r=n.allowCheckOut(a.moduleConfig.params.rootContext.originalQuotationCart);r?(a.moduleConfig.params.rootContext.fromPage="newQuotationItem",a.redirect("checkOutQuotation",null)):s.showMessageBox(I.lng_noItemCart)},I.goBack=function(e,t){console.log("goBack clicked");var o=a.moduleConfig.params.rootContext.fromPage;if("quotation"===o||"newQuotation"===o||"newQuotationItem"===o){var r=a.moduleConfig.params.rootContext.custId;a.redirect("quotation",r)}else{var n=a.moduleConfig.params.rootContext.quotationId;a.redirect("quotationDetail",n)}},I.dispose=function(e){I.router.dispose()}}var c;return c={selector:"#searchCanvas",edge:"top",displayMode:"push",size:"63px",modality:"modeless",autoDismiss:"none"},t.bindingHandlers.searchCanvas={init:function(o,a,r){t.utils.domNodeDisposal.addDisposeCallback(o,function(){o&&e.OffcanvasUtils.close(c)})}},t.bindingHandlers.winsize={init:function(e,t,a,r,n){o(window).resize(function(){r.screenWidth(o(window).width()),r.screenHeight(o(window).height())})}},t.bindingHandlers.currency={symbol:t.observable("$"),update:function(e,o,a){return t.bindingHandlers.text.update(e,function(){var e=+(t.utils.unwrapObservable(o())||0),r=t.utils.unwrapObservable(void 0===a().symbol?a().sybmol:"$");return r+e.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")})}},new u});