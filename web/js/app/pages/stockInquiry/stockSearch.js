define(["ojs/ojcore","knockout","jquery","appController","util/appui","pages/stockInquiry/stockInquiryService","pages/common/constant","ojs/ojinputtext","ojs/ojjsontreedatasource"],function(e,t,o,r,s,n,a){function i(){function i(e,t){if(s.hideBusy(),e&&200==t.status){console.log("cbGetItemLotSuccessFn success");var r=e;if("string"==typeof e&&(r=JSON.parse(e)),r.P_ITEM_LOT_TBL&&r.P_ITEM_LOT_TBL.P_ITEM_LOT_TBL_ITEM){var n=r.P_ITEM_LOT_TBL;suggestionList={},suggestionList.groupName="Lot Suggestions",suggestionList.items=n.P_ITEM_LOT_TBL_ITEM,d.lotSuggestions.splice(0,1,suggestionList),d.disableLot(!1),o("#lots").ojInputSearch("refresh")}}}function u(e,t){console.log("cbGetItemLotFailFn called"),s.hideBusy()}function l(){var e=_,t=d.itemCode()[0],o=r.moduleConfig.params.rootContext.userProfile,s={InputGetItemOnhandByItem:{HeaderInfo:{UserID:o.username,UserRole:o.salesRole,CallerID:""},P_ORG_ID:e,P_ITEM_ID:t}};return console.log("getItemOnhand payload = "+JSON.stringify(s)),JSON.stringify(s)}function c(){var e=r.moduleConfig.params.rootContext.userProfile,o=r.moduleConfig.params.rootContext.userProfile.orgUnitId;console.log("user ="+t.toJSON(e));var s,s,n=[],i=[],e=r.moduleConfig.params.rootContext.userProfile;e.salesRole===a.SR_SALE_VAN?s=a.PRICE_ID_BEER:e.salesRole!==a.SR_MOBILE_SALE&&e.salesRole!==a.SR_ADMIN||(e.orgUnitId===a.ORG_UNIT_ID_WINE?s=a.PRICE_ID_WINE:e.orgUnitId===a.ORG_UNIT_ID_BEER&&(s=a.PRICE_ID_BEER)),n.push(s);for(var u=0;u<n.length;u++)i.push({PRICE_LIST_ID:n[u]});var l=JSON.stringify({InputGetPriceList:{HeaderInfo:{UserID:e.username,UserRole:e.salesRole,CallerID:""},P_ORG_ID:o,P_PRICE_LIST_ID_TBL:{P_PRICE_LIST_ID_TBL_ITEM:i}}});return console.log(l),l}function I(e){var t=/^\d+$/;return t.test(e)}function g(){var t=e.Translations.getTranslatedString;d.lng_stockInquiry=t("ssa.stockSearch.stockInquiry"),d.lng_search=t("ssa.stockSearch.search"),d.lng_clearRecent=t("ssa.stockSearch.clearRecent"),d.lng_placeholderInputItemCode=t("ssa.stockSearch.inputItemCode"),d.lng_noItemCodeSelected=t("ssa.stockSearch.noItemCodeSelected"),d.lng_billingAddress=t("ssa.profile.billingAddress"),d.lng_overdueAging=t("ssa.profile.overdueAging"),d.lng_salesPerformance=t("ssa.profile.salesPerformance"),d.lng_target=t("ssa.profile.target"),d.lng_lastYearAndYTDPerformance=t("ssa.profile.lastYearAndYTDPerformance")}var d=this;d.handleActivated=function(e){d.parentRouter=e.valueAccessor().params.ojRouter.parentRouter,g()};var _;d.recentItemCodes=o.map(s.getLocalStorage("recentItemCodes")||{},function(e,t){return[e]}),d.itemCode=t.observableArray(),d.ready=t.observable(!1),d.lot=t.observableArray(),d.disableLot=t.observable(!0),d.clearRecentItemCodes=function(e,t){s.setLocalStorage("recentItemCodes",null),d.recentItemCodes=[],d.itemCodeSuggestions()[0].items=d.recentItemCodes,o("#itemCodes").ojInputSearch("refresh")},d.lotSuggestions=t.observableArray([{groupName:"Lot Suggestions",items:[]}]),d.itemCodeSuggestions=t.observableArray([{groupName:"Recent Item Codes",items:d.recentItemCodes}]),d.onClearSearchText=function(){d.clearSearch()},d.clearSearch=function(){o("#itemCodes");d.itemCode(""),o("#oj-inputsearch-input-itemCodes").val("")},d.onSearchTextChange=function(e,t){"rawValue"===t.option},s.showBusy(),n.getPriceListMessage(c()).then(function(e){try{var t=e;"string"==typeof e&&(t=JSON.parse(e));var o=t.P_PRICE_LIST_TBL_ITEM;console.log("Prilce List length = "+o.length),o.forEach(function(e){e.ITEM_CODE_DESCRIPTION=e.PRODUCT+"   "+e.PRODUCT_DESCRIPTION,_||(_=e.ORGANIZATION_ID)}),suggestionList={},suggestionList.groupName="Item Code Suggestions",suggestionList.items=o,d.itemCodeSuggestions.push(suggestionList),d.ready(!0)}catch(e){console.log(e)}finally{s.hideBusy()}}),d.updateEventHandler=function(e,t){if(0!=t.value.length){var o=r.moduleConfig.params.rootContext.userProfile;console.log("ITEM_CODE Value Changed: "+t.value);var a={ITEM_ID:t.value[0]},l={InputGetItemLot:{HeaderInfo:{UserID:o.username,UserRole:o.salesRole,CallerID:""},P_ORG_ID:_,P_ITEM_ID_TBL:{P_ITEM_ID_TBL_ITEM:new Array(a)}}};l=JSON.stringify(l),console.log(l),s.showBusy(),n.getItemLotMessage(l).then(i,u)}},d.buttonSearchClick=function(){function t(t,r){s.hideBusy();var n=t;if("string"==typeof t&&(n=JSON.parse(t)),!n.P_ONHAND_TBL)return s.showMessageBox("No Stock Items Found"),-1;var a=n.P_ONHAND_TBL.P_ONHAND_TBL_ITEM;if(o.isArray(a)||(a=new Array(a)),a.length<=0)return s.showMessageBox("No Stock Items Found"),-1;var i=[],u=[];a.forEach(function(e){var t=e.ORGANIZATION_NAME;e.LOT<=0&&(e.LOT=""),u.indexOf(t)>-1?i[u.indexOf(t)].children.push({attr:{id:e,data:e}}):(u.push(t),i.push({attr:{id:e,warehouse:t},children:[{attr:{id:e,data:e}}]}))}),i.sort(function(e,t){return e.attr.warehouse<t.attr.warehouse?1:e.attr.warehouse>t.attr.warehouse?-1:0}),i.forEach(function(e){e.children.sort(function(e,t){return e.attr.ORGANIZATION_NAME<t.attr.ORGANIZATION_NAME?1:e.attr.ORGANIZATION_NAME>t.attr.ORGANIZATION_NAME?-1:e.attr.DESCRIPTION<t.attr.DESCRIPTION?1:e.attr.DESCRIPTION>t.attr.DESCRIPTION?-1:0})});var l=new e.JsonTreeDataSource(i);d.parentRouter.moduleConfig.params.stockSearchResult=l,console.log("parentRouter="+d.parentRouter.currentState().value)}if(!(d.itemCode()&&d.itemCode().length>=1))return void s.showMessageBox("Please input search Criteria");var r=d.itemCode()[0];if(!I(r))return void s.showMessageBox(d.lng_noItemCodeSelected);var a,i=o.grep(d.itemCodeSuggestions()[1].items,function(e){return e.INVENTORY_ITEM_ID==r});i.length>0&&(a=i[0]);var u=s.getLocalStorage("recentItemCodes")||{};u.hasOwnProperty(r)||(u[r]=a,d.recentItemCodes=o.map(u,function(e,t){return[e]}),console.log("before compression length: "+JSON.stringify(u).length),s.setLocalStorage("recentItemCodes",u)),s.showBusy(),n.getItemOnhandMessageByItem(l()).then(function(e,o){var r=t(e,o);r!=-1&&d.parentRouter.go("stockList")},function(e,t){s.hideBusy()})},d.dispose=function(e){},d.onPageReady=function(){o("#oj-inputsearch-input-itemCodes").focus(function(){setTimeout(function(e){e.value.length;return function(){void 0!==e.setSelectionRange?e.setSelectionRange(0,0):o(e).val(e.value)}}(this),0)})}}return i});