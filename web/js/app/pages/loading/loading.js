define(["ojs/ojcore","knockout","jquery","appController","util/data","util/appui","pages/delivery/deliveryService","pages/loading/loadingService","pages/common/constant","util/commonhelper","pages/common/vanService","ojs/ojrouter","ojs/ojknockout","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojselectcombobox","ojs/ojlistview","ojs/ojmodel","ojs/ojpagingcontrol","ojs/ojpagingcontrol-model","ojs/ojpulltorefresh","ojs/ojvalidation","ojs/ojoffcanvas"],function(e,o,r,n,t,a,s,l,i,c,u){function d(){function t(){S.scrollPos(0),S.licenseNo(null),S.barcode(null),S.worklistData(null),S.allLoaded=[]}function d(){var e=function(e,r){try{if(e&&200==r.status){var n=e.OutputGetVans.TblJsVans;o.utils.arrayMap(n,function(e){S.availableVans.push(o.toJS({value:"VAN-"+e.LicenseNo,label:e.LicenseNo}))})}}catch(e){console.error(e)}finally{console.log("cbSuccessFn called")}},r=function(e,o){console.log("cbFailFn failed")};u.getAllVans().then(e,r)}function f(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var o="[\\?&]"+e+"=([^&#]*)",r=new RegExp(o),n=r.exec(window.location.href);return null!==n&&n[1]}function p(){console.log("loading init(): started"),N();var e=n.moduleConfig.params.rootContext.userProfile;if("undefined"==typeof e||"DUMMY"==e.salesRole){var r=v();console.log("checkPasscode payload="+o.toJS(r)),a.showBusy(),l.setupOAuthToken().done(function(){console.log("Setup oAuth HTTP Header"),l.checkPasscode(r).done(function(e){console.log("check OTP result : "+o.toJSON(e)),e&&"true"==e.result?m():(a.hideBusy(),console.log("Invalid One-Time-Password"),a.showMessageBox(S.lng_error_00028))}).fail(function(e){a.hideBusy(),console.log("checkPasscode Failed"),a.showMessageBox(S.lng_error_00028)})}).fail(function(e){a.hideBusy(),console.log("setupOAuthToken Failed"),a.showMessageBox(S.lng_error_00028)})}else d()}function v(){var e=E(),o=e._jebsenOTP,r=JSON.stringify({encryptedPasscode:o});return r}function m(){console.log("requestFrom3rdParty started");var e=n.moduleConfig.params.rootContext.userProfile;if(console.log("user = "+o.toJSON(e)),"undefined"==typeof e){var r={username:i.SR_DUMMY,email:"",firstName:i.SR_DUMMY,lastName:i.SR_DUMMY,displayName:i.SR_DUMMY,salesRole:i.SR_DUMMY,salesRespId:"",orgUnitId:"",licenseNo:""};n.moduleConfig.params.rootContext.userProfile=r,console.log("Dummy Profile="+o.toJSON(r));var t=f("documentNumber");t&&S.qrcode(t);var a=f("licenseNumber");a&&(console.log(a),S.licenseNo(a));var s=b();S.s1ErrorList.removeAll(),S.s2ErrorList.removeAll(),S.s3ErrorList.removeAll(),S.totalDocumentInput(1),S.proceedDocumentInput(0),R(s,S.qrcode())}}function E(){var e={};if(document.cookie&&""!=document.cookie)for(var o=document.cookie.split(";"),r=0;r<o.length;r++){var n=o[r].split(/=(.+)/);n[0]=n[0].replace(/^ /,""),e[decodeURIComponent(n[0])]=decodeURIComponent(n[1])}return e}function h(e,o,r){return e.replace(new RegExp(o.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),r)}function b(){var e="";if(S.isJLogAdmin()||S.isLindeAdmin())e=new String(o.utils.unwrapObservable(S.licenseNo)).toString(),e=h(e," ","").toUpperCase(),S.licenseNo(e);else{var r=n.moduleConfig.params.rootContext.userProfile;try{e=r.salesRole==i.SR_DUMMY?S.licenseNo():r.licenseNo,e&&(e=h(e," ","").toUpperCase())}catch(e){console.log(e)}}if(e){var t=e.indexOf("VAN-");t<0&&(e="VAN-"+e)}return e}function _(r,n,t,a,s){if(r=Array.isArray(r)?r[0]:r,console.log("Date retrieve from backend = "+o.toJSON(r)),null!==r&&200==n){var l=r[L],u=r.P_RETURN_STATUS,d=r.P_MSG_DATA;if("S"!=u&&"S2"!=u)return"S1"==u&&S.s1ErrorList.push(s),void("S3"==u&&S.s3ErrorList.push(s));if("S2"==u){S.s2ErrorList.push(o.toJS({documentNo:s,carLicenseNo:d}));var g=o.utils.unwrapObservable(S.allLoaded),f=o.utils.arrayFirst(g,function(e){if(e.DELIVERY_NUMBER==s)return e});if(f&&"undefined"!=typeof f)return void console.log("document="+o.toJSON(f))}var p=o.utils.unwrapObservable(S.allLoaded),v=0;try{v=o.utils.unwrapObservable(S.allLoaded).length,console.log("recordCnt="+v)}catch(e){}o.utils.arrayMap(l,function(e){try{var o=c.formatStrDate(e.DELIVERY_DATE,"YYYY-MM-DDTHH:mm:ss.sssZ","DD-MMM-YYYY").toUpperCase();o==i.BLANK_DATE?e.DELIVERY_DATE="":e.DELIVERY_DATE=c.formatStrDate(e.DELIVERY_DATE,"YYYY-MM-DDTHH:mm:ss.sssZ","DD-MMM-YYYY").toUpperCase()}catch(e){}e.DELIVERY_ADDRESS="-1"==e.DELIVERY_ADDRESS?"":e.DELIVERY_ADDRESS,e.CAR_PLATE_NUMBER="-1"==e.CAR_PLATE_NUMBER?"":e.CAR_PLATE_NUMBER,e.DOCUMENT_TYPE=t,e.ORG_UNIT_ID=a,e.P_SHIPMENT_DETAILS_TBL_ITEM=r.P_SHIPMENT_DETAILS_TBL_ITEM,v>0?p.splice(0,0,e):p.push(e)}),S.worklistData(new e.ArrayTableDataSource(p,{idAttribute:"DELIVERY_NUMBER"})),S.allLoaded=p}}function R(e,r){var n=y(r);if(n){a.showBusy();var t=n.DOCUMENT_TYPE,s=n.NUMBER,i=n.ORG_UNIT_ID,c=D(i,t,e,s);console.log("goods loading payload ="+o.toJS(c));var u=function(e,o){try{_(e,o.status,t,i,r)}catch(e){console.error(e)}finally{S.barcode(null),a.hideBusy(),console.log("cbSuccessFn called")}},d=function(e,o){console.log("cbFailFn failed"),_(e,o.status,t,i,r),a.hideBusy()};l.getLoadingMessage(c).then(u,d).then(function(){S.proceedDocumentInput(S.proceedDocumentInput()+1),S.proceedDocumentInput()==S.totalDocumentInput()?(console.log("All document(s) completed"),S.showError(!0),S.showError(!1)):S.showError(!1)})}}function D(e,o,r,n){return l.getPayload(e,o,r,n)}function y(e){if("undefined"!=typeof e&&e){var o=e.substring(0,1),r=e.substring(0,4),n=e.indexOf("-"),t=T(o);return t>=0||n<0?t>=0?{ORG_UNIT_ID:i.ORG_UNIT_ID_BEER,DOCUMENT_TYPE:i.DOCUMENT_TYPE_DELIVERY_NOTE,NUMBER:e.substring(1)}:{ORG_UNIT_ID:i.ORG_UNIT_ID_BEER,DOCUMENT_TYPE:i.DOCUMENT_TYPE_DELIVERY_NOTE,NUMBER:e.substring(0)}:{ORG_UNIT_ID:r,DOCUMENT_TYPE:i.DOCUMENT_TYPE_PICKUP,NUMBER:e.substring(5)}}}function T(e){var o=/^[a-zA-Z]+$/;return e.match(o)?0:-1}function N(){var o=e.Translations.getTranslatedString;S.lng_title=o("ssa.loading.title"),S.lng_license=o("ssa.loading.license"),S.lng_barcode=o("ssa.loading.barcode"),S.lng_continue=o("ssa.loading.continue"),S.lng_error_00021=o("ssa.msg.error.ERROR_00021"),S.lng_searchPlaceHolder=o("ssa.header.search"),S.lng_primaryText=o("ssa.pullToRefreshUtils.primaryText"),S.lng_secondaryText=o("ssa.pullToRefreshUtils.secondaryText"),S.lng_error_00024=o("ssa.msg.error.ERROR_00024"),S.lng_error_00025=o("ssa.msg.error.ERROR_00025"),S.lng_error_00026=o("ssa.msg.error.ERROR_00026"),S.lng_error_00028=o("ssa.msg.error.ERROR_00028")}var S=this;console.log("LoadingViewModel");var L="P_SHIPMENT_TBL_ITEM";S.router=n.router,S.qrcode=o.observable(),S.licenseNo=o.observableArray([]),S.barcode=o.observable(),S.showError=o.observable(),S.s1ErrorList=o.observableArray(),S.s2ErrorList=o.observableArray(),S.s3ErrorList=o.observableArray(),S.proceedDocumentInput=o.observable(),S.totalDocumentInput=o.observable(),S.isFocused=o.observable(!1),S.onLicense=o.observable(!1),S.worklistData=o.observable(),S.allLoaded=o.observableArray(),S.scrollPos=o.observable(0),S.searchText=o.observable(""),S.searchText.extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}}),S.isDummyRole=o.computed(function(){var e=n.moduleConfig.params.rootContext.userProfile;return"undefined"==typeof e||e.salesRole==i.SR_DUMMY}),S.availableVans=o.observableArray(),S.handleActivated=function(r){var a=r.valueAccessor().params.ojRouter.parentRouter;console.log("loading.js parentRouter="+a.currentState().value);var s=a.getChildRouter("loading");s||(s=a.createChildRouter("loading")),S.router=s.configure(function(o){if(o){var r=new e.RouterState(o,{value:o,enter:function(){console.log("loading.js stateId="+o)}});return r}});try{var l=n.moduleConfig.params.rootContext.selDeliveryProfile,i=n.moduleConfig.params.rootContext.selDeliveryProfile.removed;if(l&&"undefined"!=typeof l&&i){var c=o.utils.unwrapObservable(S.allLoaded),u=o.utils.arrayFirst(c,function(e){if(e.DELIVERY_NUMBER==o.utils.unwrapObservable(l.delivery_no))return e});u&&"undefined"!=typeof u&&(console.log("document="+o.toJSON(u)),o.utils.arrayRemoveItem(c,u),S.worklistData(new e.ArrayTableDataSource(c,{idAttribute:"DELIVERY_NUMBER"})),S.allLoaded=c,n.moduleConfig.params.rootContext.selDeliveryProfile.removed=!1)}else t()}catch(e){console.log("Exception of removing action:"+e),t()}return e.Router.sync()},S.handleBindingsApplied=function(e){var o=r("#globalBody").find(".oj-hybrid-applayout-content"),n="oj-hybrid-applayout-scrollable";o.hasClass(n)&&(r("#searchCanvas").on("ojbeforeopen",function(){o.removeClass(n)}),r("#searchCanvas").on("ojbeforeclose",function(){o.addClass(n)})),r("#searchCanvas").on("ojclose",function(){S.clearSearch()})},S.qrcode.subscribe(function(e){console.log("New QR Code:"+e)}),S.showError.subscribe(function(r){if(console.log("Show Error: "+r),r){var n="",t="",s="",l="",i="",c="",u="";if(o.utils.arrayForEach(S.s1ErrorList(),function(e){i=i+e+"<BR>",S.barcode((S.barcode()?S.barcode():"")+e+";")}),i&&i.length>0){var d={detail:i};t=e.Translations.getTranslatedString("ssa.msg.error.ERROR_00024",d)}if(o.utils.arrayForEach(S.s2ErrorList(),function(e){c=c+e.documentNo+" => "+e.carLicenseNo+"<BR>",S.barcode((S.barcode()?S.barcode():"")+e.documentNo+";")}),c&&c.length>0){var d={detail:c};s=e.Translations.getTranslatedString("ssa.msg.error.ERROR_00025",d)}if(o.utils.arrayForEach(S.s3ErrorList(),function(e){u=u+e+"<BR>",S.barcode((S.barcode()?S.barcode():"")+e+";")}),u&&u.length>0){var d={detail:u};l=e.Translations.getTranslatedString("ssa.msg.error.ERROR_00026",d)}t&&t.length>0&&(n+=t),s&&s.length>0&&(n&&n.length>0?n=n+"<BR>"+s:n+=s),l&&l.length>0&&(n&&n.length>0?n=n+"<BR>"+l:n+=l),n&&n.length>0&&a.showMessageBox(n)}}),S.valueChangeHandler=function(e,o){"value"==o.option&&S.nextStep()},S.nextStep=function(e){try{var o=new String(S.licenseNo()).toString();if("undefined"!=typeof o&&o.length>0){var o=h(o," ","").toUpperCase();S.licenseNo(o),S.isFocused(!0)}}catch(e){S.isFocused(!1)}},S.load=function(){try{if("undefined"==typeof S.licenseNo()||S.licenseNo().length<=0)return a.showMessageBox(S.lng_error_00021),void S.onLicense(!0)}catch(e){return a.showMessageBox(S.lng_error_00021),void S.onLicense(!0)}if(!("undefined"==typeof S.barcode()||S.barcode().length<=0)){var e=b();S.barcode(S.barcode().toUpperCase()),console.log("licenseNo="+e),console.log("barcode="+S.barcode());var o=S.barcode().split(";");console.log("barcodeList="+o),S.s1ErrorList.removeAll(),S.s2ErrorList.removeAll(),S.s3ErrorList.removeAll();for(var r=0,n=[],t=0;t<o.length;t++){var s=o[t].trim();o[t]&&s&&(r+=1,n.push(s))}S.totalDocumentInput(r),S.proceedDocumentInput(0);for(var t=0;t<n.length;t++)n[t]&&R(e,n[t])}},S.enableScan=o.computed(function(){var e=n.moduleConfig.params.rootContext.userProfile;try{return e.salesRole==i.SR_DRIVER_JLOG||e.salesRole==i.SR_DRIVER_LINDE}catch(e){return!1}}),S.scanBarcode=function(){if("undefined"==typeof cordova)return void console.log("Barcode scan failed - cordova is not defined");console.log("Barcode scan starting......");var e=b();cordova.plugins.barcodeScanner.scan(function(o){console.log("barcode: "+o.text),console.log("format: "+o.format),console.log("cancelled: "+o.cancelled),S.s1ErrorList.removeAll(),S.s2ErrorList.removeAll(),S.s3ErrorList.removeAll(),S.totalDocumentInput(1),S.proceedDocumentInput(0),R(e,o.text)},function(e){alert("Scanning failed: "+e)},{preferFrontCamera:!1,showFlipCameraButton:!1,prompt:"Place a barcode inside the scan area"})},S.goBack=function(){n.router.go("springboard")},S.dispose=function(e){S.router.dispose()},S.optionChange=function(e,r){function t(e){var r=o.utils.unwrapObservable(S.allLoaded),t=o.utils.arrayFirst(r,function(o){if(o.DELIVERY_NUMBER==e)return o});if(t){console.log("delivery header="+o.toJSON(t));var a=s.createDocument(t);return console.log("document="+o.toJSON(a)),n.moduleConfig.params.rootContext.selDeliveryProfile=a,!0}return!1}if("selection"===r.option&&r.value[0]){console.log("loading.js ui.value="+r.value);var a=t(r.value);a&&(n.moduleConfig.params.rootContext.fromPage="loading",n.redirect("loadingDetail",r.value))}},S.onClearSearchText=function(){S.clearSearch()},S.clearSearch=function(){var e=r("#searchProduct");e.ojInputText("option","value",""),e.ojInputText("reset"),S.searchText("")},S.toggleSearchCanvas=function(){console.log("toggleSearchCanvas triggered"),e.OffcanvasUtils.toggle(g)},S.onSearchTextChange=function(r,n){if("rawValue"===n.option){console.log("onSearchTextChange.data.value="+n.value),S.searchText(n.value);var t=new Array,a=0;try{a=o.utils.unwrapObservable(S.allLoaded).length}catch(e){}if(a>0)if(0===S.searchText().length)t=o.utils.unwrapObservable(S.allLoaded);else{var s=o.utils.unwrapObservable(S.allLoaded);o.utils.arrayFilter(s,function(e){var o=S.searchText().toLowerCase();e.DELIVERY_NUMBER.toLowerCase().indexOf(o)>=0&&t.push(e)})}S.worklistData(new e.ArrayTableDataSource(t,{idAttribute:"DELIVERY_NUMBER"}))}},S.isJLogAdmin=o.computed(function(){var e=n.moduleConfig.params.rootContext.userProfile;try{return e.salesRole===i.SR_ADMIN_JLOG}catch(e){return!1}}),S.isLindeAdmin=o.computed(function(){var e=n.moduleConfig.params.rootContext.userProfile;try{return e.salesRole===i.SR_ADMIN_LINDE}catch(e){return!1}}),p(),r(document).ready(function(){try{document.getElementById("oj-combobox-input-text-licenseNo").focus()}catch(e){}})}var g;return g={selector:"#searchCanvas",edge:"top",displayMode:"push",size:"63px",modality:"modeless",autoDismiss:"none"},o.bindingHandlers.executeOnEnter={init:function(e,o,n,t){var a=o();r(e).keypress(function(e){var o=e.which?e.which:e.keyCode;return 13!==o||(a.call(t),!1)})}},new d});