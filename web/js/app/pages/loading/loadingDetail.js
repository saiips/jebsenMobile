define(["ojs/ojcore","knockout","jquery","appController","util/data","pages/loading/loadingService","pages/common/constant","util/appui","pages/common/maintenance","pages/delivery/deliveryService","ojs/ojrouter","ojs/ojknockout","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojselectcombobox","ojs/ojlistview","ojs/ojmodel","ojs/ojpagingcontrol","ojs/ojpagingcontrol-model","ojs/ojpulltorefresh","ojs/ojvalidation","ojs/ojoffcanvas"],function(e,o,r,n,l,a,i,s,t,u){function d(){function l(){var e=n.moduleConfig.params.rootContext.selDeliveryProfile;"undefined"!=typeof e?y.headerTitle(o.utils.unwrapObservable(e.delivery_no)):y.headerTitle(y.lng_loadingDetail)}function d(e){var r=n.moduleConfig.params.rootContext.selDeliveryProfile.deliveryDetail;o.isObservable(r)&&(r=o.utils.unwrapObservable(r)),console.log("deliveryDetail = "+o.toJSON(r)),r&&o.utils.arrayMap(r,function(e){e.MAXQTY=e.QTY,e.QTY=null,e.LOT_NUMBER="-1"==e.LOT_NUMBER?"":e.LOT_NUMBER,y.allDeliveryItem.push(e)})}function c(){console.log("loadingDetail.js init() started");var e=n.moduleConfig.params.rootContext.selDeliveryProfile;e&&(console.log("selDelivery="+o.toJSON(e)),y.documentType(o.utils.unwrapObservable(e.documentType)),y.orgUnitId(o.utils.unwrapObservable(e.orgUnitId)),y.delivery_no(o.utils.unwrapObservable(e.delivery_no)),y.deliveryDate(o.utils.unwrapObservable(e.deliveryDate)),y.outletName(o.utils.unwrapObservable(e.outletName)),y.deliveryAddress(o.utils.unwrapObservable(e.deliveryAddress)),y.orderNumber(o.utils.unwrapObservable(e.orderNumber)),y.carPlateNumber(o.utils.unwrapObservable(e.carPlateNumber)));var r=n.moduleConfig.params.rootContext.userProfile.salesRole;r==i.SR_DRIVER_JLOG||r==i.SR_DRIVER_LINDE||r==i.SR_DUMMY?(y.buttonEnabled(!0),y.qtyModifyEnabled(!0)):r==i.SR_ADMIN_JLOG&&(y.buttonEnabled(!1),y.qtyModifyEnabled(!1))}function g(){var e=y.orgUnitId();e&&"undefined"!=typeof e||(e=i.ORG_UNIT_ID_BEER);var o=y.documentType(),r=y.carPlateNumber(),n=y.delivery_no(),l=a.getUnLoadingPayload(e,o,r,n);return l}function f(e){console.log("confirmGoodsLoading clicked"),console.log("paymentType = "+e);var o=t.isMaintenance();if(o)return void s.showMessageBox(y.lng_maintenance);var r=n.moduleConfig.params.rootContext.isOnline;if(!r)return void s.showMessageBox(y.lng_error_00005);if("FULL"==e){if(!confirm(y.lng_confirmProceed))return}else if(!confirm(y.lng_partialDelivery))return;v(e)}function v(e){s.showBusy();var r=u.getConfirmGoodsLoadingPayload(y.orgUnitId(),y.documentType(),y.delivery_no(),y.allDeliveryItem(),e);console.log("confirm goods loading payload = "+o.toJS(r));var n=function(e,o){var r,n,l;try{200==o.status&&null!=e&&(l=e.OutputDNRMAConfirm,r=l.ReturnStatus,n=l.ReturnMessage,"S"==r||"W"==r?(s.showMessageBox(y.lng_proceedDelivery),y.buttonEnabled(!1)):s.showMessageBox(y.lng_error_00013+" "+n))}catch(e){console.error(e),s.showMessageBox(y.lng_error_00014),s.hideBusy()}finally{s.hideBusy(),console.log("cbSuccessFn called")}},l=function(e,o){console.log("cbFailFn failed"),s.showMessageBox(y.lng_error_00014),s.hideBusy()};u.confirmGoodsLoadingMessage(r).then(n,l)}function m(){var o=e.Translations.getTranslatedString;y.lng_loadingDetail=o("ssa.loading.detail"),y.lng_overview=o("ssa.deliveryDetail.overview"),y.lng_itemDetail=o("ssa.deliveryDetail.itemDetail"),y.lng_lot=o("ssa.deliveryDetail.lot"),y.lng_qty=o("ssa.deliveryDetail.qty"),y.lng_confirm=o("ssa.deliveryDetail.confirm"),y.lng_partialConfirm=o("ssa.deliveryDetail.partialConfirm"),y.lng_confirmByCash=o("ssa.deliveryDetail.confirmByCash"),y.lng_confirmByCheque=o("ssa.deliveryDetail.confirmByCheque"),y.lng_confirmByOthers=o("ssa.deliveryDetail.confirmByOthers"),y.lng_confirmProceed=o("ssa.deliveryDetail.confirmProceed"),y.lng_partialDelivery=o("ssa.msg.info.partialDelivery"),y.lng_proceedDelivery=o("ssa.msg.info.proceedDelivery"),y.lng_error_00005=o("ssa.msg.error.ERROR_00005"),y.lng_error_00013=o("ssa.msg.error.ERROR_00013"),y.lng_error_00014=o("ssa.msg.error.ERROR_00014"),y.lng_error_00017=o("ssa.msg.error.ERROR_00017"),y.lng_delInfoSaved=o("ssa.msg.info.delInfoSaved"),y.lng_maintenance=o("ssa.msg.info.maintenance"),y.lng_error_00027=o("ssa.msg.error.ERROR_00027"),y.lng_delInfoSaved=o("ssa.msg.info.delInfoSaved"),y.lng_confirmExit=o("ssa.msg.info.confirmExit"),y.lng_originalQty=o("ssa.deliveryDetail.originalQty")}var y=this;console.log("LoadingDetailViewModel");y.router=n.router,y.headerTitle=o.observable(),y.allDeliveryItem=o.observableArray([]),y.currDeliveryNumber=o.observable(),y.documentType=o.observable(),y.orgUnitId=o.observable(),y.delivery_no=o.observable(),y.deliveryDate=o.observable(),y.outletName=o.observable(),y.deliveryAddress=o.observable(),y.orderNumber=o.observable(),y.carPlateNumber=o.observable(),y.isDummyRole=o.computed(function(){var e=n.moduleConfig.params.rootContext.userProfile;return"undefined"==typeof e||e.salesRole==i.SR_DUMMY}),y.isDriverRole=o.computed(function(){var e=n.moduleConfig.params.rootContext.userProfile;return e.salesRole==i.SR_DRIVER_JLOG||e.salesRole==i.SR_DRIVER_LINDE}),y.isCODPayment=o.computed(function(){var e=n.moduleConfig.params.rootContext.userProfile;if("undefined"==typeof e)return!1;if(e.salesRole==i.SR_DRIVER_JLOG||e.salesRole==i.SR_DRIVER_LINDE||e.salesRole==i.SR_DUMMY)return!1;var r=n.moduleConfig.params.rootContext.selDeliveryProfile;return o.utils.unwrapObservable(r.paymentTerm)==i.PAYMENT_TERM}),y.buttonEnabled=o.observable(),y.qtyModifyEnabled=o.observable(),y.handleActivated=function(o){var r=o.valueAccessor().params.ojRouter.parentRouter;console.log("loadingDetail.js parentRouter="+r.currentState().value);var n=r.getChildRouter("loadingDetail");return n||(n=r.createChildRouter("loadingDetail")),y.router=n.configure(function(o){if(o){var r=new e.RouterState(o,{value:o,enter:function(){y.currDeliveryNumber(o),console.log("loadingDetail.js stateId="+o)}});return r}}),m(),l(),e.Router.sync()},y.handleBindingsApplied=function(e){var o=r("#globalBody").find(".oj-hybrid-applayout-content"),n="oj-hybrid-applayout-scrollable";o.hasClass(n)&&(r("#searchCanvas").on("ojbeforeopen",function(){o.removeClass(n)}),r("#searchCanvas").on("ojbeforeclose",function(){o.addClass(n)})),r("#searchCanvas").on("ojclose",function(){y.clearSearch()})},y.currDeliveryNumber.subscribe(function(e){c(),d(e)}),y.goBack=function(){var e=n.moduleConfig.params.rootContext.fromPage;n.go(e)},y.dispose=function(e){y.router.dispose()},y.confirmShipment=function(){f("FULL")},y.partialConfirmShipment=function(){f(null)},y.confirmCash=function(){f(i.PAY_BY_CASH)},y.confirmCheque=function(){f(i.PAY_BY_CHEQUE)},y.confirmOthers=function(){f(i.PAY_BY_OTHERS)},y.close=function(){},y.remove=function(){if(confirm(y.lng_confirmProceed)){s.showBusy(),console.log("Remove "+y.carPlateNumber()+" form the document "+y.delivery_no());var e=g();console.log("Remove Payload = "+o.toJS(e)),a.getUnLoadingMessage(e).done(function(e){s.hideBusy(),console.log("raw data="+o.toJSON(e));var r=e.P_RETURN_STATUS;if("S"!=r)return void s.showMessageBox(y.lng_error_00027);n.moduleConfig.params.rootContext.selDeliveryProfile.removed=!0;var l=n.moduleConfig.params.rootContext.fromPage;n.go(l)}).fail(function(e){s.hideBusy(),s.showMessageBox(y.lng_error_00027)})}}}var c;return c={selector:"#searchCanvas",edge:"top",displayMode:"push",size:"63px",modality:"modeless",autoDismiss:"none"},d});