define(["ojs/ojcore","knockout","jquery","appController","pages/checkOut/checkOutService","pages/common/cartService","pages/newOrder/newOrderService","util/appui","util/commonhelper","pages/common/constant","pages/common/maintenance","util/devmode","pages/common/logService","ojs/ojrouter","ojs/ojknockout","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojselectcombobox","ojs/ojdatetimepicker","ojs/ojdialog","ojs/ojrouter","ojs/ojnavigationlist"],function(e,r,o,t,a,s,n,l,i,u,d,c,v){function g(){function g(){j.subInventories.removeAll(),j.overrideSubInventories.removeAll(),j.shipmentMethods.removeAll(),j.cart.removeAll(),j.overrideShipmentDate(null),j.overrideSubInventory(null),j.overrideShipmentMethod(null),j.purchase_order(""),j.real_customer(""),j.remarks(""),j.order_date(""),j.ship_to_district(""),j.shipping_address(""),j.billing_address(""),j.validateOrderFailed(!1),j.availableBillToList.removeAll(),j.availableSalesRepList.removeAll(),j.overrideSalesRep(null),j.overrideBillTo(null)}function p(){return t.moduleConfig.params.rootContext.isDataSync}function m(){if(console.log("init called"),"Y"!=t.moduleConfig.params.rootContext.fromShipment){var e=r.observableArray();r.isObservable(t.moduleConfig.params.rootContext.originalCart)||(t.moduleConfig.params.rootContext.originalCart=r.observableArray(t.moduleConfig.params.rootContext.originalCart)),r.utils.arrayForEach(t.moduleConfig.params.rootContext.originalCart(),function(r){e.push(r)}),j.isOrderDeskAdmin=r.computed(function(){var e=t.moduleConfig.params.rootContext.userProfile;try{return e.salesRole===u.SR_ADMIN}catch(e){return!1}}),g(),N(),t.moduleConfig.params.rootContext.originalCart=r.observableArray(),r.utils.arrayForEach(e(),function(e){t.moduleConfig.params.rootContext.originalCart.push(e)}),j.skipValidateOrder=r.computed(function(){return!1}),j.showEraseButton=r.computed(function(){return!1}),j.isDisabledShipmentMethod=r.computed(function(){var e=t.moduleConfig.params.rootContext.isOnline;if(!e)return!1;var o=r.utils.unwrapObservable(j.overrideSubInventory);return Array.isArray(o)&&(o=o[0]),o!=u.MS_WAREHSE&&o!=u.JL_WAREHSE}),j.isShowQtyChangeShipment=r.computed(function(){return!B()&&T()&&!M()}),j.isShowQty=r.computed(function(){return B()}),j.showRealCustomer=r.computed(function(){var e=t.moduleConfig.params.rootContext.selCustomerProfile;return"Y"==r.utils.unwrapObservable(e.walkInCust)}),j.getDataSyncCount=r.computed(function(){var e=0;return e=h()}),j.isOnline=r.computed(function(){return!!t.moduleConfig.params.rootContext.isOnline}),j.isCreditCustomer=r.computed(function(){var e=t.moduleConfig.params.rootContext.userProfile,o=t.moduleConfig.params.rootContext.selCustomerProfile,a=r.utils.unwrapObservable(o.paymentTermId);return e.salesRole==u.SR_SALE_VAN&&a!=u.PAYMENT_TERM_ID_COD})}w(),R(),E(),console.log("isMaintenance = "+d.isMaintenance());var o=t.moduleConfig.params.rootContext.isOnline;console.log("isOnline = "+o);var i="Y"==t.moduleConfig.params.rootContext.fromShipment;if(console.log("isReturnFromShipment = "+i),console.log("isDataSync = "+p()),console.log("isReOrder = "+t.moduleConfig.params.rootContext.isReOrder),console.log("isQuickCheckOut = "+t.moduleConfig.params.rootContext.isQuickCheckOut),console.log("isDevMode = "+(c.isEnabled()&&c.isOffline())),console.log("skipValidateOrder = "+j.skipValidateOrder()),p()||(t.moduleConfig.params.rootContext.savedOrder="undefined"),f(),!o||i||c.isEnabled()&&c.isOffline()||j.skipValidateOrder())if(i){t.moduleConfig.params.rootContext.fromShipment="N";var v=s.cloneCart(t.moduleConfig.params.rootContext.originalCart);j.cart.removeAll(),r.utils.arrayForEach(v(),function(e){console.log("item = "+r.toJSON(e)),j.cart.push(e)})}else{j.targetCart=t.moduleConfig.params.rootContext.originalCart,console.log("self.targetCart = "+r.toJSON(j.targetCart));for(var m=r.utils.unwrapObservable(j.targetCart),O=m.length,S=0;S<O;S++){var C=s.cloneCartItem(m[S]);console.log("cart_item = "+r.toJSON(C)),j.cart.push(C)}}else l.showBusy(),n.getPriceListMessage(J()).done(function(){var e=F();if(e&&j.beerShipFromOrgID(e[0].ORGANIZATION_ID),A(),j.isOrderDeskAdmin()){var o=P();console.log("initBillToList payload ="+r.toJS(o)),a.getBillToListMessage(o).done(function(e,o){if(null!==e&&200==o.status){var t=e.P_BILL_TO_ADDRESS_TBL_ITEM;if(!Array.isArray(t)){var a=new Array;a.push(t),t=a}j.availableBillToList.push(r.toJS({value:"-1",label:""})),r.utils.arrayMap(t,function(e){j.availableBillToList.push(r.toJS({value:e.BILL_TO_ADDRESS_ID,label:e.BILL_TO_ADDRESS}))})}}).then(function(){var e=t.moduleConfig.params.rootContext.selCustomerProfile;if(p()?j.overrideBillTo(r.utils.unwrapObservable(e.overrideBillToSiteId)):j.overrideBillTo(r.utils.unwrapObservable(e.billToSiteId)),j.isOrderDeskAdmin()){var o=x();console.log("initSalesRepList payload ="+r.toJS(o)),a.getSalesRepListMessage(o).done(function(e,o){if(null!==e&&200==o.status){var t=e.P_SALESREP_TBL_ITEM;if(!Array.isArray(t)){var a=new Array;a.push(t),t=a}j.availableSalesRepList.push(r.toJS({value:"-1",label:""})),r.utils.arrayMap(t,function(e){j.availableSalesRepList.push(r.toJS({value:e.SALESREP_ID,label:e.SALESREP_NAME}))})}}).then(function(){var e=t.moduleConfig.params.rootContext.selCustomerProfile;p()?j.overrideSalesRep(r.utils.unwrapObservable(e.overrideSalesRepId)):j.overrideSalesRep(r.utils.unwrapObservable(e.salesRepId)),b(!1)?_():j.goBack()})}})}else b(!1)?_():j.goBack()})}function b(e){var o=!0,a=t.moduleConfig.params.rootContext.fromPage;if("orderDetail"==a||"newOrder"==a||"newOrderItem"==a||p()){j.targetCart=t.moduleConfig.params.rootContext.originalCart,console.log("self.targetCart = "+r.toJSON(j.targetCart));var s=r.isObservable(j.targetCart);s||(j.targetCart=r.observableArray(j.targetCart));var n=H(j.targetCart);n?0==j.targetCart().length&&(l.hideBusy(),j.cart.removeAll(),t.moduleConfig.params.rootContext.originalCart=r.observableArray([]),l.showMessageBox(j.lng_error_00001),o=!1):0==j.targetCart().length?(j.cart.removeAll(),t.moduleConfig.params.rootContext.originalCart=r.observableArray([]),l.hideBusy(),l.showMessageBox(j.lng_error_00001),o=!1):l.hideBusy()}return o}function _(){console.log("validateSalesOrder started");var e=t.moduleConfig.params.rootContext.userProfile;l.showBusy(),j.targetCart=t.moduleConfig.params.rootContext.originalCart,console.log("self.targetCart = "+r.toJSON(j.targetCart)),console.log("self.cart = "+r.toJSON(j.cart)),console.log("self.targetCart = "+r.toJSON(j.targetCart));var o=I();console.log(">>> payload ="+o);var s=v.getEventLogPayload(e.username,u.EVENT_BEFORE_VALIDATE_ORDER,r.toJS(o),r.toJSON({shipmentDate:j.overrideShipmentDate(),SubInventory:j.overrideSubInventory(),ShipmentMethod:j.overrideShipmentMethod()}));v.log(s);var n=function(e,o){try{console.log("raw data returned = "+r.toJSON(e)),Y(e,o.status)}catch(e){l.hideBusy(),console.error(e),"EBS-ERROR"!=e&&l.showMessageBox(j.lng_error_00011),O(),j.validateOrderFailed(!0)}finally{console.log("cbSuccessFn called"),l.hideBusy()}},i=function(e,r){console.log("cbFailFn failed"),l.showMessageBox(j.lng_error_00011),Y(e,r.status),O(),j.validateOrderFailed(!0)};a.validateSalesOrderMessage(o).then(n,i)}function O(){console.log(">>>>> addBackItem "),j.cart.removeAll();for(var e=r.utils.unwrapObservable(j.targetCart),o=e.length,t=0;t<o;t++){var a=s.cloneCartItem(e[t]);console.log("cart_item = "+r.toJSON(a)),j.cart.push(a)}}function h(){var e=s.getOfflineKey(),o=l.getLocalStorage(e);return"undefined"!=typeof o?(Array.isArray(o)||(o=r.utils.unwrapObservable(o)),0==o.length?0:o.data.length):0}function f(){var e=t.moduleConfig.params.rootContext.selCustomerProfile;if("Y"==t.moduleConfig.params.rootContext.fromShipment)console.log("fillOrder for shipment"),console.log("fromShipment");else if(0!=t.moduleConfig.params.rootContext.isReOrder||"newOrder"!=t.moduleConfig.params.rootContext.fromPage&&"newOrderItem"!=t.moduleConfig.params.rootContext.fromPage&&"topOrderItem"!=t.moduleConfig.params.rootContext.fromPage)if(p()){console.log("fillOrder for dataSync");var o=s.getOrder();j.cust_name(r.utils.unwrapObservable(e.name)),j.purchase_order(r.utils.unwrapObservable(o.purchase_order)),j.real_customer(r.utils.unwrapObservable(o.real_customer)),j.shipping_address(r.utils.unwrapObservable(o.shipping_address)),j.billing_address(r.utils.unwrapObservable(o.billing_address)),j.ship_to_district(r.utils.unwrapObservable(e.shipToDistrict)),j.minShipmentDate(S()),j.delivery_cost(r.utils.unwrapObservable(o.delivery_cost)),j.remarks(r.utils.unwrapObservable(o.remarks)),j.overrideSubInventory(r.utils.unwrapObservable(o.override_sub_inventory)),j.overrideShipmentMethod(r.utils.unwrapObservable(o.override_shipment_method)),j.overrideShipmentDate(r.utils.unwrapObservable(o.override_shipment_date))}else{console.log("fillOrder for re-order / order details");var o=s.getOrder();console.log("order = "+r.toJSON(o)),j.cust_name(r.utils.unwrapObservable(o.cust_name));var a=r.utils.unwrapObservable(o.remarks);j.remarks(new String(a).toString()),j.delivery_cost(0),j.shipping_address(r.utils.unwrapObservable(o.shipping_address)),j.billing_address(r.utils.unwrapObservable(o.billing_address)),j.ship_to_district(r.utils.unwrapObservable(e.shipToDistrict)),j.purchase_order(""),j.real_customer(""),j.minShipmentDate(S())}else console.log("fillOrder for newOrder"),j.cust_name(r.utils.unwrapObservable(e.name)),j.purchase_order(""),j.real_customer(""),j.remarks(""),j.delivery_cost(0),j.shipping_address(r.utils.unwrapObservable(e.shipToAddress)),j.billing_address(r.utils.unwrapObservable(e.billToAddress)),j.ship_to_district(r.utils.unwrapObservable(e.shipToDistrict)),j.minShipmentDate(S()),console.log("from newOrder");j.order_no(""),j.order_date(i.getClientCurrentDate()),j.status("")}function S(){return i.getClientCurrentDate("YYYY-MM-DD")}function C(e){return e==u.ORG_UNIT_ID_WINE?u.SHIP_FROM_ORG_ID_2922:e==u.ORG_UNIT_ID_BEER?r.utils.unwrapObservable(j.beerShipFromOrgID):void 0}function y(e){var o=s.getOrder(),a=t.moduleConfig.params.rootContext.selCustomerProfile,n=t.moduleConfig.params.rootContext.userProfile,l=t.moduleConfig.params.rootContext.outLetId,d=s.cloneOrder(o);if(d.cust_name(r.utils.unwrapObservable(a.name)),d.outlet_name(r.utils.unwrapObservable(a.outletName)),d.real_customer(r.utils.unwrapObservable(a.realCustomer)),d.shipping_address(r.utils.unwrapObservable(a.shipToAddress)),d.billing_address(r.utils.unwrapObservable(a.billToAddress)),d.sold_to_org_id(a.id),Array.isArray(l)&&(l=l[0]),d.ship_to_org_id(r.utils.unwrapObservable(l)),d.invoice_to_org_id(a.billToSiteId),d.price_list_id(a.priceListId),d.pricing_date(i.getClientCurrentDate("YYYY-MM-DDTHH:mm:ssZ")),d.order_date(i.getClientCurrentDate("YYYY/MM/DD")),d.sold_from_org_id(n.orgUnitId),d.ship_from_org_id(C(n.orgUnitId)),n.salesRole==u.SR_SALE_VAN||n.salesRole==u.SR_MOBILE_SALE?d.sales_rep_id(r.utils.unwrapObservable(a.salesRepId)):d.sales_rep_id(r.utils.unwrapObservable(n.erpSalesId)),j.isOrderDeskAdmin()){var c=r.utils.unwrapObservable(j.overrideSalesRep());Array.isArray(c)&&(c=c[0]);var v=r.utils.unwrapObservable(j.overrideBillTo());Array.isArray(v)&&(v=v[0]),console.log("overrideSalesRep="+r.toJSON(c)),console.log("overrideBillTo="+r.toJSON(v)),d.sales_rep_id(c),d.invoice_to_org_id(v)}return d.transactional_curr_code("HKD"),d.payment_term_id(a.paymentTermId),d.remarks(r.utils.unwrapObservable(j.remarks)),d.real_customer(r.utils.unwrapObservable(j.real_customer)),e?(d.delivery_cost(r.utils.unwrapObservable(j.delivery_cost)?r.utils.unwrapObservable(j.delivery_cost):0),d.order_tot_amt(r.utils.unwrapObservable(j.total)?r.utils.unwrapObservable(j.order_no):0),d.purchase_order(r.utils.unwrapObservable(j.purchase_order)?r.utils.unwrapObservable(j.purchase_order):"")):(d.delivery_cost(r.utils.unwrapObservable(j.delivery_cost)),d.order_tot_amt(r.utils.unwrapObservable(j.total)),d.purchase_order(r.utils.unwrapObservable(j.purchase_order))),d}function I(){var e=y(!0);return a.getValidatePayload(e,j.targetCart)}function D(){var e=y(!1),o=t.moduleConfig.params.rootContext.userProfile.orgUnitId,s=r.utils.unwrapObservable(j.overrideShipmentDate),n=r.utils.unwrapObservable(j.overrideSubInventory),l=r.utils.unwrapObservable(j.overrideShipmentMethod);return console.log("overrideShipmentDate = "+s),console.log("overrideSubInventory = "+n),console.log("overrideShipmentMethod = "+l),o==u.ORG_UNIT_ID_WINE?a.getCreateWineOrderPayload(e,j.cart,s,n,l):a.getCreateBeerOrderPayload(e,j.cart,s,n,l)}function w(){var e=t.moduleConfig.params.rootContext.userProfile.salesRole;e===u.SR_SALE_VAN?(j.showMSButton=r.observable(!1),j.showVSPayButton=r.observable(!0),j.showCreditButton=r.observable(!1),console.log("isCreditCustomer="+j.isCreditCustomer()),j.isCreditCustomer()&&(j.showMSButton=r.observable(!1),j.showVSPayButton=r.observable(!1),j.showCreditButton=r.observable(!0))):(j.showMSButton=r.observable(!0),j.showVSPayButton=r.observable(!1),j.showCreditButton=r.observable(!1))}function R(){M()?j.isShowLotNumber(!0):B()||T()?j.isShowLotNumber(!1):j.isShowLotNumber(!0)}function E(){var e=t.moduleConfig.params.rootContext.userProfile.salesRole;e==u.SR_SALE_VAN?j.isHidenForVanSale(!1):j.isHidenForVanSale(!0)}function M(){var e=t.moduleConfig.params.rootContext.userProfile.salesRole;return e===u.SR_ADMIN}function B(){var e=t.moduleConfig.params.rootContext.userProfile.salesRole;return e==u.SR_SALE_VAN}function T(){var e=t.moduleConfig.params.rootContext.userProfile.orgUnitId;return e==u.ORG_UNIT_ID_BEER}function A(){console.log("iniSubInventory");var e=function(e,o){if(console.log("cbSuccessFn"),console.log("initSubInventory raw data = "+r.toJSON(e)),null!==e&&200==o.status){var a={},s=e.P_SUBINV_TBL.P_SUBINV_TBL_ITEM;if(!Array.isArray(s)){var n=new Array;n.push(s),s=n}j.overrideSubInventories.push(r.toJS({value:"-1",label:""})),j.subInventories.push(r.toJS({value:"-1",label:""})),r.utils.arrayMap(s,function(e){var o=e.SUBINV_CODE.substr(0,e.SUBINV_CODE.toString().length-1),t=e.SUBINV_CODE.substr(-1);j.subInventories.push(r.toJS({value:o,label:o})),j.overrideSubInventories.push(r.toJS({value:o,label:o})),"undefined"==typeof a[o]&&(a[o]=t)}),t.moduleConfig.params.rootContext.subInventoryMap=a,console.log("subInventories ="+r.toJSON(j.subInventories)),console.log("overrideSubInventories ="+r.toJSON(j.overrideSubInventories))}},o=function(e,r){console.log("cbFailFn")},s=t.moduleConfig.params.rootContext.userProfile.orgUnitId,n="";n=s==u.ORG_UNIT_ID_WINE?u.IO_ID_2899:r.utils.unwrapObservable(j.beerShipFromOrgID),a.getSubInventoryMessage(n).then(e,o)}function N(){console.log("initShipmentMethod");var e=function(e,o){if(console.log("cbSuccessFn"),null!==e&&200==o.status){var t=e.P_SHIPPING_METHOD_TBL.P_SHIPPING_METHOD_TBL_ITEM;if(!Array.isArray(t)){var a=new Array;a.push(t),t=a}j.shipmentMethods.push(r.toJS({value:"-1",label:""})),r.utils.arrayMap(t,function(e){j.shipmentMethods.push(r.toJS({value:e.SHIPPING_METHOD,label:e.MEANING}))})}},o=function(e,r){console.log("cbFailFn")};a.getShipmentMethodMessage().then(e,o)}function P(){var e,o=t.moduleConfig.params.rootContext.userProfile,a=t.moduleConfig.params.rootContext.selCustomerProfile;return e=JSON.stringify({InputGetBillToAddress:{HeaderInfo:{UserID:o.username,UserRole:o.salesRole,CallerID:""},P_ORG_ID:o.orgUnitId,P_ACCOUNT_NUMBER:r.utils.unwrapObservable(a.accountNumber)}})}function x(){var e,r=t.moduleConfig.params.rootContext.userProfile;return e=JSON.stringify({InputGetSalesERPName:{HeaderInfo:{UserID:r.username,UserRole:r.salesRole,CallerID:""},P_ORG_ID:r.orgUnitId}})}function L(){var e=t.moduleConfig.params.rootContext.userProfile,r=e.licenseNo.split("-");return"DD-"+r[1]}function Y(e,o){if(null!==e&&200==o){var a=e[W].ReturnStatus,n=e[W].ReturnMessage;"S"!=a&&"W"!=a?(n?l.showMessageBox(j.lng_error_00011+" Reason: "+n):l.showMessageBox(j.lng_error_00011),j.validateOrderFailed(!0)):j.validateOrderFailed(!1);var d;e[W].HeaderRecord;try{d="undefined"==typeof e[W].LineRecords?e[W].HeaderRecord.LineRecords.O_LINE_TBL_OUT_ITEM:e[W].LineRecords.O_LINE_TBL_OUT_ITEM}catch(e){throw console.log(e),"EBS-ERROR"}var c=t.moduleConfig.params.rootContext.userProfile,g=v.getEventLogPayload(c.username,u.EVENT_AFTER_VALIDATE_ORDER,r.toJSON(e),r.toJSON({shipmentDate:j.overrideShipmentDate(),SubInventory:j.overrideSubInventory(),ShipmentMethod:j.overrideShipmentMethod()}));v.log(g);var m,b=Array.isArray(d);if(b)m=d;else{var _=new Array;_.push(d),m=_}console.log("respJSON ="+r.toJSON(m)),j.cart.removeAll(),r.utils.arrayMap(m,function(e){console.log("item = "+r.toJSON(e));var o;if(e.LOT_NUMBER_TBL){var t=e.LOT_NUMBER_TBL.LOT_NUMBER_TBL_ITEM;if(Array.isArray(t))o=t;else{var a=new Array;a.push(e.LOT_NUMBER_TBL.LOT_NUMBER_TBL_ITEM),o=a}console.log("lotJSON = "+r.toJSON(o))}var n,l=[];if(r.utils.arrayMap(o,function(e){"-1"!=new String(e.LOT_NUMBER)&&"-2"!=new String(e.LOT_NUMBER)?l.push(r.toJS({value:e.LOT_NUMBER,label:e.LOT_NUMBER})):l.push(r.toJS({value:"-1",label:""}))}),Array.isArray(l)&&l.length>=1?(n=l[0].value,e.LOT_NUMBER=n):e.LOT_NUMBER="",p()){var u=r.utils.arrayFirst(j.targetCart(),function(o){return r.utils.unwrapObservable(o.product().id)==e.INVENTORY_ITEM_ID});console.log("targetCartItem="+r.toJSON(u)),u&&(e.LOT_NUMBER=r.utils.unwrapObservable(u.product().lot),console.log("targetCartItem.lotArray="+r.utils.unwrapObservable(u.product().lot)))}var d;d=i.isValid(e.SCHEDULE_SHIP_DATE)?i.isEBSFormat(e.SCHEDULE_SHIP_DATE)?i.formatStrDateToYYYYMMDD(e.SCHEDULE_SHIP_DATE):e.SCHEDULE_SHIP_DATE:i.getClientNextDate();var c=e.SUBINVENTORY;B()&&(c=L());var v=s.createCartItem(e,e.ORDERED_QUANTITY,!1,d,e.ORIGINAL_LINE,l,c,e.SHIPPING_METHOD);console.log("cart_item = "+r.toJSON(v)),j.cart.push(v)})}l.hideBusy()}function k(){var e,r,o=t.moduleConfig.params.rootContext.userProfile.orgUnitId;return o==u.ORG_UNIT_ID_WINE?(e="createWineOrderService",r="OutputCreateWineOrder"):(e=M()?"createBeerOrderSyncService":"createBeerOrderService",r="OutputCreateBeerOrder"),{reqName:e,resName:r}}function J(){var e=t.moduleConfig.params.rootContext.selCustomerProfile,o=r.utils.unwrapObservable(e.priceListId),a=t.moduleConfig.params.rootContext.userProfile,s=r.utils.unwrapObservable(a.orgUnitId),n=[],l=[];n.push(o);for(var i=0;i<n.length;i++)l.push({PRICE_LIST_ID:n[i]});var u=JSON.stringify({InputGetPriceList:{HeaderInfo:{UserID:a.username,UserRole:a.salesRole,CallerID:""},P_ORG_ID:s,P_PRICE_LIST_ID_TBL:{P_PRICE_LIST_ID_TBL_ITEM:l}}});return console.log("price list payload = "+r.toJS(u)),u}function F(){var e=t.moduleConfig.params.rootContext.selCustomerProfile,o=t.moduleConfig.params.rootContext.userProfile,a=r.utils.unwrapObservable(o.orgUnitId),s=r.utils.unwrapObservable(e.priceListId),n=u.STANDARD_PRICE_LIST_KEY+":"+a+":"+s,i=l.getLocalStorage(n),d=i.P_PRICE_LIST_TBL_ITEM;return d}function H(e){var o=!0,t=[],a=r.isObservable(e);a||(e=r.observableArray(e));var s=F();return console.log("respJSON="+s[0].ORGANIZATION_ID),r.utils.arrayForEach(e(),function(e){var o=!1,a=r.utils.unwrapObservable(e.product().id),n=r.utils.unwrapObservable(e.original),l=r.utils.arrayFirst(s,function(e){return e.INVENTORY_ITEM_ID==a});console.log("foundItem ="+r.toJSON(l)),l&&(o=!0),o&&"N"!=n&&"undefined"!=typeof n||t.push(e),console.log("product id "+a+" found in price list table is "+o)}),console.log(" removeitem = "+r.toJSON(t)),t.length>0&&(e.removeAll(t),console.log("self.targetCart = "+r.toJSON(j.targetCart)),o=!1),o}function U(){console.log("proceedSalesOrder");var e=k(),o=e.reqName,s=e.resName,n=D();console.log("payload = "+r.toJS(n)),l.showBusy();var i=function(e,o){try{console.log("raw data returned = "+r.toJSON(e));var a=e[s].ReturnStatus,n=e[s].ReturnMessage;if("S"==a||"W"==a){l.showMessageBox(j.lng_orderReceived);var i=t.moduleConfig.params.rootContext.custId;if(t.moduleConfig.params.rootContext.requireRefresh=!0,p()){var d=t.moduleConfig.params.rootContext.savedOrder,c=r.toJS({status:"S",data:d.data});t.moduleConfig.params.rootContext.savedOrder=c,t.go("dataSync")}else t.redirect("orderHist",i)}else l.showMessageBox(n)}catch(e){l.hideBusy(),l.showMessageBox(j.lng_error_00008),console.error(e)}finally{var g=t.moduleConfig.params.rootContext.userProfile,m=v.getEventLogPayload(g.username,u.EVENT_PLACE_ORDER,r.toJS(c),r.toJSON({shipmentDate:j.overrideShipmentDate(),SubInventory:j.overrideSubInventory(),ShipmentMethod:j.overrideShipmentMethod()}));v.log(m),l.hideBusy(),console.log("cbSuccessFn called")}},d=function(e,r){console.log("cbFailFn failed"),l.hideBusy(),l.showMessageBox(j.lng_error_00008)};a.createSalesOrderMessage(n,o).then(i,d)}function V(e){var o=d.isMaintenance();if(o)return void l.showMessageBox(j.lng_maintenance);var n=t.moduleConfig.params.rootContext.isOnline;if(n){l.showBusy();var i=j.cart().length;if(i<=0)return l.hideBusy(),void l.showMessageBox(j.lng_error_00009);var u=y(!1);s.setOrder(u);var c=a.getVanOrderPayload(u,j.cart,e);console.log("payload = "+r.toJS(c));var v="OutputCreateVanOrder",g=function(o,a){try{console.log("raw data returned = "+r.toJSON(o)),l.hideBusy();var n=o[v].ReturnStatus,i=o[v].ReturnMessage,u=o[v].HEADER_ID,d=o[v].ORDER_NUMBER,c=o[v].FLOW_STATUS_CODE,g=r.toJS({HEADER_ID:u,ORDER_NUMBER:d,FLOW_STATUS_CODE:c,PAYMENT_TYPE:e});"E"==n?l.showMessageBox(i):"S"==n&&(s.setCart(j.cart),t.moduleConfig.params.rootContext.paymentParameter=g,t.moduleConfig.params.rootContext.isContinuePayment=!1,t.redirect("payment",u))}catch(e){l.hideBusy(),l.showMessageBox(j.lng_error_00008),console.error(e)}finally{console.log("cbSuccessFn called")}},p=function(e,r){console.log("cbFailFn failed"),l.hideBusy(),l.showMessageBox(j.lng_error_00008)};a.createVanOrderMessage(c).then(g,p)}else l.showMessageBox(j.lng_error_00005)}function G(){var r=e.Translations.getTranslatedString;j.lng_checkOut=r("ssa.checkOut.checkOut"),j.lng_onBehalfOf=r("ssa.checkOut.onBehalfOf"),j.lng_billTo=r("ssa.checkOut.billTo"),j.lng_salesRep=r("ssa.checkOut.salesRep"),j.lng_overview=r("ssa.checkOut.overview"),j.lng_purchaseOrder=r("ssa.checkOut.purchaseOrder"),j.lng_orderDate=r("ssa.checkOut.orderDate"),j.lng_totalItems=r("ssa.checkOut.totalItems"),j.lng_total=r("ssa.checkOut.total"),j.lng_overrideDeliverySchedule=r("ssa.checkOut.overrideDeliverySchedule"),j.lng_date=r("ssa.checkOut.date"),j.lng_remarks=r("ssa.checkOut.remarks"),j.lng_itemDetail=r("ssa.checkOut.itemDetail"),j.lng_subInventory=r("ssa.checkOut.subInventory"),j.lng_shipmentDate=r("ssa.checkOut.shipmentDate"),j.lng_shipmentMethod=r("ssa.checkOut.shipmentMethod"),j.lng_lot=r("ssa.checkOut.lot"),j.lng_qty=r("ssa.checkOut.qty"),j.lng_deliveryCost=r("ssa.checkOut.deliveryCost"),j.lng_orderSummary=r("ssa.checkOut.orderSummary"),j.lng_shippingAddress=r("ssa.checkOut.shippingAddress"),j.lng_billingAddress=r("ssa.checkOut.billingAddress"),j.lng_placeOrder=r("ssa.checkOut.placeOrder"),j.lng_payByCash=r("ssa.checkOut.payByCash"),j.lng_confirmPlaceOrder=r("ssa.checkOut.confirmProceed"),j.lng_confirmClear=r("ssa.checkOut.confirmClear"),j.lng_payByCheque=r("ssa.checkOut.payByCheque"),j.lng_payByOthers=r("ssa.checkOut.payByOthers"),j.lng_realCustomer=r("ssa.checkOut.realCustomer"),j.lng_error_00001=r("ssa.msg.error.ERROR_00001"),j.lng_error_00002=r("ssa.msg.error.ERROR_00002"),j.lng_error_00003=r("ssa.msg.error.ERROR_00003"),j.lng_error_00004=r("ssa.msg.error.ERROR_00004"),j.lng_error_00005=r("ssa.msg.error.ERROR_00005"),j.lng_error_00006=r("ssa.msg.error.ERROR_00006"),j.lng_orderReceived=r("ssa.msg.info.orderReceived"),j.lng_error_00008=r("ssa.msg.error.ERROR_00008"),j.lng_error_00009=r("ssa.msg.error.ERROR_00009"),j.lng_error_00010=r("ssa.msg.error.ERROR_00010"),j.lng_error_00011=r("ssa.msg.error.ERROR_00011"),j.lng_error_00012=r("ssa.msg.error.ERROR_00012"),j.lng_error_00022=r("ssa.msg.error.ERROR_00022"),j.lng_error_00023=r("ssa.msg.error.ERROR_00023"),j.lng_orderInfoSaved=r("ssa.msg.info.orderInfoSaved"),j.lng_maintenance=r("ssa.msg.info.maintenance")}var j=this,W="OutputValidateSalesOrder";j.router=t.router,console.log("CheckOutViewModel"),j.cust_name=r.observable(),j.order_no=r.observable(),j.purchase_order=r.observable(),j.order_date=r.observable(),j.real_customer=r.observable(),j.remarks=r.observable(),j.delivery_cost=r.observable(),j.shipping_address=r.observable(),j.billing_address=r.observable(),j.status=r.observable(),j.currOrderId=r.observable(),j.overwriteShipDateObtained=r.observable(!1),j.shipDateObatined=r.observable(!1),j.overrideShipmentDate=r.observable(),j.overrideSubInventory=r.observable(),j.overrideShipmentMethod=r.observable(),j.minShipmentDate=r.observable(),j.ship_to_district=r.observable(),j.isShowLotNumber=r.observable(!0),j.subInventories=r.observableArray(),j.overrideSubInventories=r.observableArray(),j.shipmentMethods=r.observableArray(),j.isHidenForVanSale=r.observable(!0),j.headerTitle=r.observable(""),j.validateOrderFailed=r.observable(!1),j.availableBillToList=r.observableArray(),j.availableSalesRepList=r.observableArray(),j.overrideBillTo=r.observable(),j.overrideSalesRep=r.observable(),j.beerShipFromOrgID=r.observable(),j.cart=r.observableArray(),j.targetCart=r.observableArray(),j.dataFormat=r.observable("yyyy/MM/dd"),j.dateConverter=r.observable(e.Validation.converterFactory(e.ConverterFactory.CONVERTER_TYPE_DATETIME).createConverter({pattern:j.dataFormat()})),j.handleActivated=function(o){var a=o.valueAccessor().params.ojRouter.parentRouter;console.log("checkOut.js parentRouter="+a.currentState().value);var s=a.getChildRouter("checkOut");s||(s=a.createChildRouter("checkOut")),j.router=s.configure(function(r){if(r){var o=new e.RouterState(r,{value:r,enter:function(){j.currOrderId(r),console.log("checkOut.js stateId ="+r)}});return o}});var n=t.moduleConfig.params.rootContext.selCustomerProfile;if("undefined"!=typeof n){var l=r.utils.unwrapObservable(n.outletName);r.utils.unwrapObservable(j.large())||l.length>u.TITLE_LENGTH&&(l=l.substring(0,u.TITLE_LENGTH)+"..."),j.headerTitle(l)}else j.headerTitle("");return G(),m(),e.Router.sync()},j.currOrderId.subscribe(function(e){console.log("newOrderId="+e)}),j.beerShipFromOrgID.subscribe(function(e){console.log("newOrgID="+e)}),j.large=r.computed(function(){var r=e.ResponsiveUtils.getFrameworkQuery(e.ResponsiveUtils.FRAMEWORK_QUERY_KEY.LG_UP);return e.ResponsiveKnockoutUtils.createMediaQueryObservable(r)}),j.subtotal=r.computed(function(){var e=0;return o(j.cart()).each(function(o,t){e+=r.utils.unwrapObservable(t.cost())}),e}),j.totalItems=r.computed(function(){var e=0;return o(j.cart()).each(function(r,o){e++}),e}),j.total=r.computed(function(){var e=0,o=r.utils.unwrapObservable(j.delivery_cost),t=r.utils.unwrapObservable(j.subtotal());return e=new Number(o)+t}),j.converter=e.Validation.converterFactory(e.ConverterFactory.CONVERTER_TYPE_NUMBER).createConverter({maximumFractionDigits:2,minimumFractionDigits:2,minimumIntegerDigits:2,style:"decimal",useGrouping:!0}),j.changeShippment=function(e,r){console.log("clicked changeShippment");var o=t.moduleConfig.params.rootContext.custId;s.setCart(j.cart),t.moduleConfig.params.rootContext.selectedItem=e,t.redirect("shipment",o)},j.optionChangeOverrideSubInventory=function(e,o){if(console.log("optionChangeOverrideSubInventory"),"value"==o.option){var s=t.moduleConfig.params.rootContext.isOnline;if(s&&!p()){l.showBusy();var n=o.value[0];if(n){var u=a.getEarliestShipDatePayload(n);console.log("payload = "+r.toJS(u));var d=function(e,o){try{console.log("raw data returned = "+r.toJSON(e));var t=e.OutputGetEarliestShipDate;if(null==t)return;var a=t.O_SHIP_DATE;i.isDateFormat(a,"YYYY-MM-DDTHH:mm:ss.sssZ")&&(a=i.formatStrDate(a,"YYYY-MM-DDTHH:mm:ss.sssZ","YYYY-MM-DD")),null==a&&(a=i.getClientCurrentDate("YYYY-MM-DD"));var s=t.O_SHIPPING_METHOD;null==s&&(s="-1"),console.log("shipDate = "+a),console.log("shipMethod="+s),j.overrideShipmentMethod(s),j.overrideShipmentDate(a)}catch(e){console.error(e),l.hideBusy()}finally{console.log("cbSuccessFn called"),j.overwriteShipDateObtained(!0),l.hideBusy()}},c=function(e,r){console.log("cbFailFn failed"),l.hideBusy()};a.getEarliestShipDateMessage(u).then(d,c)}}}},j.optionChangeOverrideShipmentMethod=function(e,o){if(console.log("optionChangeOverrideShipmentMethod"),"value"==o.option){var s=t.moduleConfig.params.rootContext.isOnline;if(s){var n=r.utils.unwrapObservable(j.overrideSubInventory);if(Array.isArray(n)&&(n=n[0]),j.overwriteShipDateObtained())return void j.overwriteShipDateObtained(!1);var u=o.value[0];if(u){l.showBusy();var d=a.getEarliestShipDateByCPPayload(n,u);console.log("payload = "+r.toJS(d));var c=function(e,o){try{console.log("raw data returned = "+r.toJSON(e));var t=e.OutputGetEarliestShipDate;if(null==t)return;var a=t.O_SHIP_DATE;i.isDateFormat(a,"YYYY-MM-DDTHH:mm:ss.sssZ")&&(a=i.formatStrDate(a,"YYYY-MM-DDTHH:mm:ss.sssZ","YYYY-MM-DD")),null==a&&(a=i.getClientCurrentDate("YYYY-MM-DD")),console.log("shipDate = "+a),j.overrideShipmentDate(a)}catch(e){console.error(e),l.hideBusy()}finally{console.log("cbSuccessFn called"),l.hideBusy()}},v=function(e,r){console.log("cbFailFn failed"),l.hideBusy()};a.getEarliestShipDateByCPMessage(d).then(c,v)}}}},j.optionChangeShipmentDate=function(e,r,o){"value"==o.option&&e&&i.isValid(o.value)&&e.shipment(i.formatStrDate(o.value,"YYYY-MM-DD","YYYY/MM/DD"))},j.optionChangeShipmentMethod=function(e,o,s){if(console.log("optionChangeShipmentMethod"),"value"==s.option){var n=t.moduleConfig.params.rootContext.isOnline;if(n){var u,d,c=j.cart().indexOf(e);if(r.isObservable(e.subInventory)&&(u=r.utils.unwrapObservable(e.subInventory)),Array.isArray(u)&&(u=u[0]),r.isObservable(e.shipmentMethod)&&(d=r.utils.unwrapObservable(e.shipmentMethod)),Array.isArray(d)&&(d=d[0]),j.shipDateObatined())return void j.shipDateObatined(!1);if(d){l.showBusy();var v=a.getEarliestShipDateByCPPayload(u,d);console.log("payload = "+r.toJS(v));var g=function(r,o){try{var t=r.OutputGetEarliestShipDate;if(null==t)return;var a=t.O_SHIP_DATE;i.isDateFormat(a,"YYYY-MM-DDTHH:mm:ss.sssZ")&&(a=i.formatStrDate(a,"YYYY-MM-DDTHH:mm:ss.sssZ","YYYY/MM/DD")),null==a&&(a=i.getClientCurrentDate()),console.log("shipDate = "+a),e.shipment(a),j.cart.splice(c,1,e)}catch(e){console.error(e),l.hideBusy()}finally{console.log("cbSuccessFn called"),l.hideBusy()}},p=function(e,r){console.log("cbFailFn failed"),l.hideBusy()};a.getEarliestShipDateByCPMessage(v).then(g,p)}}}},j.optionChangeOverrideBillTo=function(e,r){"value"==r.option&&console.log("event.value="+r.value)},j.optionChangeOverrideSalesRep=function(e,r){"value"==r.option&&console.log("event.value="+r.value)},j.optionChangedHandler=function(e,o,s){if(console.log("optionChangedHandler"),"value"==s.option){var n=t.moduleConfig.params.rootContext.isOnline;if(n){l.showBusy();var u,d=j.cart().indexOf(e),c=t.moduleConfig.params.rootContext.userProfile,v=r.utils.unwrapObservable(e.product().id),g=r.utils.unwrapObservable(e.quantity);if(r.isObservable(e.subInventory)&&(u=r.utils.unwrapObservable(e.subInventory)),Array.isArray(u)&&(u=u[0]),u){var p=a.getEarliestShipDatePayload(u,c.orgUnitId,v,g);console.log("payload = "+r.toJS(p));var m=function(o,t){try{var a=o.OutputGetEarliestShipDate;if(null==a)return;var s=a.O_SHIP_DATE;i.isDateFormat(s,"YYYY-MM-DDTHH:mm:ss.sssZ")&&(s=i.formatStrDate(s,"YYYY-MM-DDTHH:mm:ss.sssZ","YYYY/MM/DD")),null==s&&(s=i.getClientCurrentDate());var n=a.O_SHIPPING_METHOD;null==n&&(n="-1"),console.log("shipDate = "+s),console.log("shipMethod="+n),e.shipmentMethod(n),e.shipment(s);try{var u,c,v=a.O_LOT_TBL_OUT;if(v&&(c=v.O_LOT_TBL_OUT_ITEM),Array.isArray(c))u=c;else{var g=new Array;g.push(c),u=g}var p,m=[];r.utils.arrayMap(u,function(e){"-1"!=new String(e.LOT_NUMBER)&&"-2"!=new String(e.LOT_NUMBER)?m.push(r.toJS({value:e.LOT_NUMBER,label:e.LOT_NUMBER})):m.push(r.toJS({value:"-1",label:""}))}),Array.isArray(m)&&m.length>=1?(p=m[0].value,e.product().lot(p)):e.product().lot(""),e.lotArray(m)}catch(r){console.log("error on getting lot Number:"+r),e.product().lot("");var m=[];e.lotArray(m)}console.log("cart = "+r.toJSON(e)),j.cart.splice(d,1,e)}catch(e){console.error(e),l.hideBusy()}finally{console.log("cbSuccessFn called"),j.shipDateObatined(!0),
l.hideBusy()}},b=function(e,r){console.log("cbFailFn failed"),l.hideBusy()};a.getEarliestShipDateMessage(p).then(m,b)}}}},j.placeOrder=function(e,o){console.log("clicked placeOrder");var a=t.moduleConfig.params.rootContext.isOnline;if(a){if(j.isOrderDeskAdmin()){var s=r.utils.unwrapObservable(j.overrideSalesRep());if(console.log("salesRepID="+s),"undefined"==typeof s||"-1"==new String(s).valueOf())return void l.showMessageBox(j.lng_error_00022);var n=r.utils.unwrapObservable(j.overrideBillTo());if(console.log("billToSiteID="+n),"undefined"==typeof n||"-1"==new String(n).valueOf())return void l.showMessageBox(j.lng_error_00023)}var i=j.cart().length;if(i<=0)return void l.showMessageBox(j.lng_error_00006);var u=d.isMaintenance();if(u)return void l.showMessageBox(j.lng_maintenance);confirm(j.lng_confirmPlaceOrder)&&U()}else l.showMessageBox(j.lng_error_00005)},j.payByCash=function(e,r){console.log("payByCash"),V(u.PAY_BY_CASH)},j.payByCheque=function(e,r){console.log("payByCheque"),V(u.PAY_BY_CHEQUE)},j.payByOthers=function(e,r){console.log("payByOthers"),V(u.PAY_BY_OTHERS)},j.createOrder=function(e,r){console.log("createOrder"),V(null)},j.performCal=function(e,r){var o=t.moduleConfig.params.rootContext.isOnline;o&&b(!0)&&_()},j.clearData=function(e,o){if(console.log("clear the offline data of sales order"),p()&&confirm(j.lng_confirmClear)){var a=t.moduleConfig.params.rootContext.savedOrder,s=r.toJS({status:"D",data:a.data});t.moduleConfig.params.rootContext.savedOrder=s,t.go("dataSync")}},j.save=function(e,o){console.log("save the checkout");try{var a=t.moduleConfig.params.rootContext.selCustomerProfile,n=!1,u=0,d=s.getOfflineKey(),c=l.getLocalStorage(d),v=-1,g="",m="",b=0,_="";console.log("storedPayload = "+r.toJSON(c)),r.isObservable(c)&&(c=r.utils.unwrapObservable(c));var O=t.moduleConfig.params.rootContext.savedOrder;if(console.log("savedOrder="+r.toJSON(O)),O&&"undefined"!=O&&(m=O.data.ORDER_NUMBER,console.log("_savedOrderNumber = "+m)),c)try{n=!0,u=c.data.length,console.log("payloadCnt="+u);for(var h=0;h<u;h++){var f=c.data[h].order.ORDER_NUMBER;console.log("_orderNumber = "+f);var b=f.split(".");b=new Number(b[1].trim()),console.log("_maxOrderNumber="+b),f==m&&(v=h,g=f)}v>=0?_=g:(b>0?u=b+1:u++,_="NO. "+u)}catch(e){console.log("exception:"+e),n=!1,u++,_="NO. "+u}else u++,_="NO. "+u;var S=y(!1);S.status("SAVED"),S.order_no(_),S.order_type(""),S.order_tot_amt(r.utils.unwrapObservable(j.total())),S.order_date(i.getClientCurrentDate("YYYY/MM/DD")),S.ship_to_district(r.utils.unwrapObservable(a.shipToDistrict)),S.shipping_address(r.utils.unwrapObservable(a.shipToAddress)),S.billing_address(r.utils.unwrapObservable(a.billToAddress)),S.cust_name(r.utils.unwrapObservable(a.name)),S.sold_to_org_id(r.utils.unwrapObservable(a.id)),S.invoice_to_org_id(r.utils.unwrapObservable(a.billToSiteId)),S.price_list_id(r.utils.unwrapObservable(a.priceListId)),S.payment_term_id(r.utils.unwrapObservable(a.paymentTermId)),S.outlet_name(r.utils.unwrapObservable(a.outletName)),S.walk_in_cust(r.utils.unwrapObservable(a.walkInCust)),S.custAccountId(r.utils.unwrapObservable(a.id)),S.accountNumber(r.utils.unwrapObservable(a.accountNumber)),S.override_billTo(j.overrideBillTo()),S.override_salesPerson(j.overrideSalesRep());var C=r.utils.unwrapObservable(j.overrideSubInventory);Array.isArray(C)&&(C=C[0]),S.override_sub_inventory(C);var I=r.utils.unwrapObservable(j.overrideShipmentMethod);Array.isArray(I)&&(I=I[0]),S.override_shipment_method("-1"==I?null:I),S.override_shipment_date(r.utils.unwrapObservable(j.overrideShipmentDate)),console.log("newOrder = "+r.toJSON(S));var D=s.payload4Order(S);console.log("newOrder="+r.toJSON(D));var w=[];if(r.utils.arrayMap(j.cart(),function(e){var r=s.payload4OrderLine(e);w.push(r)}),console.log("newOrderLines="+r.toJSON(w)),w.length<=0)return void l.showMessageBox(j.lng_error_00010);for(var R=t.moduleConfig.params.rootContext.subInventoryMap,E=[],h=0,M=Object.keys(R),B=M.length;h<B;h++){var e=r.toJS({subInventoryCode:M[h],dBeerFlag:R[M[h]]});E.push(r.toJS(e))}var T=r.toJS({data:[{delivery:"N",order:D,orderdetail:w,draughtBeerFlag:E}]});if(console.log("payload = "+r.toJSON(T)),n?(console.log("foundPayload"),v>=0?c.data.splice(v,1,r.toJS({delivery:"N",order:D,orderdetail:w})):c.data.push(r.toJS({delivery:"N",order:D,orderdetail:w})),l.setLocalStorage(d,c),console.log("storedPayload = "+r.toJSON(c))):l.setLocalStorage(d,T),l.showMessageBox(j.lng_orderInfoSaved),p())t.go("dataSync");else{var A=t.moduleConfig.params.rootContext.custId;t.redirect("orderHist",A)}}catch(e){console.error(e),l.showMessageBox(j.lng_error_00003)}},j.dispose=function(e){j.router.dispose()},j.goBack=function(e,o){console.log("goBack clicked");var a=t.moduleConfig.params.rootContext.fromPage,s=t.moduleConfig.params.rootContext.custId,n=t.moduleConfig.params.rootContext.orderId;if(console.log("checkOut.js fromPage="+a),"newOrder"===a||"newOrderItem"===a||"topOrderItem"===a)t.redirect(a,s);else if("orderDetail"===a)t.redirect(a,n);else if(p())t.go(a);else{var n=r.utils.unwrapObservable(j.currOrderId);t.redirect("orderDetail",n)}}}return r.bindingHandlers.winsize={init:function(e,r,t,a,s){o(window).resize(function(){a.screenWidth(o(window).width()),a.screenHeight(o(window).height())})}},r.bindingHandlers.currency={symbol:r.observable("$"),update:function(e,o,t){return r.bindingHandlers.text.update(e,function(){var e=+(r.utils.unwrapObservable(o())||0),a=r.utils.unwrapObservable(void 0===t().symbol?t().sybmol:"$");return a+e.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")})}},r.bindingHandlers.readOnly={update:function(e,o){var t=r.utils.unwrapObservable(o());t?e.setAttribute("readOnly",!0):e.removeAttribute("readOnly")}},new g});