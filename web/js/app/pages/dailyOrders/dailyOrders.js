define(["ojs/ojcore","knockout","jquery","appController","pages/dailyOrders/dailyOrdersService","pages/common/cartService","util/appui","util/commonhelper","pages/common/constant","util/commonhelper","pages/customer/customerService","ojs/ojknockout","ojs/ojlistview","ojs/ojjsontreedatasource","ojs/ojnavigationlist","promise","ojs/ojtoolbar","ojs/ojpulltorefresh","ojs/ojoffcanvas"],function(e,r,o,t,a,n,s,l,i,u,c){function d(){function d(e){var o=c.getCustomerPayload(e);console.log("prepareCustomerProfile = "+r.toJSON(o));var t=c.createCustomerProfile(o);return console.log("customerProfile = "+r.toJSON(t)),t}function m(){var e=t.moduleConfig.params.rootContext.userProfile,r=u.getClientDays(-2,"YYYY-MM-DDTHH:mm:ssZ"),o=u.getClientCurrentDate("YYYY-MM-DDTHH:mm:ssZ"),a=JSON.stringify({InputParameters:{HeaderInfo:{UserID:e.username,UserRole:e.salesRole,CallerID:""},P_ORG_ID:e.orgUnitId,P_SALESREP_ID:e.erpSalesId,P_FROM_DATE:r,P_TO_DATE:o,P_FROM_ROW:null,P_TO_ROW:null}});return a}function h(){s.showBusy(),C.ready(!1);var e=function(e,r){try{g(e,r.status)}catch(e){console.error(e)}finally{console.log("cbSuccessFn called"),s.hideBusy(),y(),t.moduleConfig.params.rootContext.requireRefresh=!1}},o=function(e,r){console.log("cbFailFn failed"),g(e,r.status),s.hideBusy(),t.moduleConfig.params.rootContext.requireRefresh=!1},n=m();console.log("Daily Summary Payload ="+r.toJS(n)),console.log("refresh = "+t.moduleConfig.params.rootContext.requireRefresh),t.moduleConfig.params.rootContext.requireRefresh?a.refreshOrderListMessage(n).then(e,o):a.getOrderListMessage(n).then(e,o),C.ready(!0)}function p(){var e=function(e,r){try{g(e,r.status)}catch(e){console.error(e)}finally{y(),console.log("cbSuccessFn called")}},r=function(e,r){console.log("cbFailFn failed"),g(e,r.status)},o=m();a.refreshOrderListMessage(o).then(e,r)}function g(e,r){if(e=Array.isArray(e)?e[0]:e,null!==e&&200==r){for(var o=e[T],a=[],s=[],i={},u=0;u<o.length;u++){var c=(o[u].ORDER_NUMBER,o[u].OE_HEADER_ID),d=o[u].OUTLET_NAME,f=o[u].ORDERED_DATE,m=f+":"+d,h=n.createOrder(o[u]);"undefined"==typeof i[c]&&(i[c]=h),l.isValid(f)&&(f=l.formatStrDateToYYYYMMDD(f)),s.indexOf(m)>-1?a[s.indexOf(m)].children.push({attr:{id:c,data:o[u]}}):(s.push(m),a.push({attr:{id:c,orderDate:f,outletName:d},children:[{attr:{id:c,data:o[u]}}]}))}a.sort(function(e,r){return e.attr.orderDate<r.attr.orderDate?1:e.attr.orderDate>r.attr.orderDate?-1:0}),a.forEach(function(e){e.children.sort(function(e,r){return e.attr.ORDERED_DATE<r.attr.ORDERED_DATE?1:e.attr.ORDERED_DATE>r.attr.ORDERED_DATE?-1:void 0})}),C.allOrders(a),t.moduleConfig.params.rootContext.headerIdMap=i}}function y(){var e=t.moduleConfig.params.rootContext.userProfile,r=i.DAILY_ORDER_SUMMARY_KEY+":"+e.orgUnitId+":"+e.erpSalesId,o=s.getLocalStorage(r+":"+i.DAILY_ORDER_SYNC_DATETIME);o&&(C.syncDatetime(o),C.showLastSyncDate(!0))}function v(){var r=e.Translations.getTranslatedString;C.lng_dailyOrderSummary=r("ssa.dailyOrders.dailyOrderSummary"),C.lng_searchPlaceHolder=r("ssa.header.customerSearch"),C.lng_lastSyncDate=r("ssa.header.lastSyncDate"),C.lng_orderType=r("ssa.orderHistory.orderType"),C.lng_price=r("ssa.orderHistory.price"),C.lng_order=r("ssa.orderHistory.order"),C.lng_primaryText=r("ssa.pullToRefreshUtils.primaryText"),C.lng_secondaryText=r("ssa.pullToRefreshUtils.secondaryText")}var C=this;C.router=t.router;var T="P_ORDER_TBL_ITEM";C.handleActivated=function(r){v(),C.searchText(""),C.scrollPos(0);var o=r.valueAccessor().params.ojRouter.parentRouter;console.log("dailyOrders.js parentRouter="+o.currentState().value);var t=o.getChildRouter("dailyOrders");return t||(t=o.createChildRouter("dailyOrders")),C.router=t.configure(function(r){if(r){var o=new e.RouterState(r,{value:r,enter:function(){console.log("dailyOrders.js stateId="+r)}});return o}}),C.headerTitle(C.lng_dailyOrderSummary),h(),e.Router.sync()},C.handleAttached=function(e){},C.handleBindingsApplied=function(e){var r=o("#globalBody").find(".oj-hybrid-applayout-content"),t="oj-hybrid-applayout-scrollable";r.hasClass(t)&&(o("#searchCanvas").on("ojbeforeopen",function(){r.removeClass(t)}),o("#searchCanvas").on("ojbeforeclose",function(){r.addClass(t)})),o("#searchCanvas").on("ojclose",function(){C.clearSearch()})},C.handleDetached=function(e){},C.optionChange=function(e,o){if("selection"===o.option&&o.value[0]){console.log("dailyOrders.js orderId="+o.value);var a=t.moduleConfig.params.rootContext.headerIdMap,s=a[o.value];if(t.moduleConfig.params.rootContext.isReOrder=!1,t.moduleConfig.params.rootContext.isDailyOrderSummary=!0,n.setOrder(s),s){var l=d(s);t.moduleConfig.params.rootContext.selCustomerProfile=l,t.moduleConfig.params.rootContext.custId=r.utils.unwrapObservable(l.id);var u=t.moduleConfig.params.rootContext.userProfile,c=s.status();c==i.ORDER_STATUS_ENTERED&&u.salesRole==i.SR_SALE_VAN?t.moduleConfig.params.rootContext.isContinuePayment=!0:t.moduleConfig.params.rootContext.isContinuePayment=!1}t.redirect("orderDetail",o.value)}},C.dispose=function(e){C.router.dispose()},C.headerTitle=r.observable(),C.outLetId=r.observable(),C.allOrders=r.observableArray(),C.searchText=r.observable(""),C.scrollPos=r.observable(0),C.searchText.extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}});var D=t.moduleConfig.params.rootContext.userProfile;t.populateDefaultNavPath(D),C.navDataSource=t.navDataSource,C.navChangeHandler=t.navChangeHandler,C.navStateId=r.observable(),C.syncDatetime=r.observable(),C.showLastSyncDate=r.observable(!1),C.ready=r.observable(!1),C.large=r.computed(function(){var r=e.ResponsiveUtils.getFrameworkQuery(e.ResponsiveUtils.FRAMEWORK_QUERY_KEY.LG_UP);return e.ResponsiveKnockoutUtils.createMediaQueryObservable(r)}),C.itemOnly=function(e){return e.leaf},C.selectTemplate=function(e,r){return r.$itemContext.leaf?"item_template":"group_template"},C.onPageReady=function(){try{e.PullToRefreshUtils.setupPullToRefresh("#listviewContainer",function(){var e=new Promise(function(e,r){C.onClearSearchText(),p(),setTimeout(function(){e()},3e3)});return e},{primaryText:C.lng_primaryText,secondaryText:C.lng_secondaryText})}catch(e){console.error(e)}},o(document).ready(function(){e.PullToRefreshUtils.setupPullToRefresh("#listviewContainer",function(){var e=new Promise(function(e,r){C.onClearSearchText(),p(),setTimeout(function(){e()},3e3)});return e},{primaryText:C.lng_primaryText,secondaryText:C.lng_secondaryText}),o("#listview").on({ojdestroy:function(){e.PullToRefreshUtils.tearDownPullToRefresh("#listviewContainer")}})}),C.orders=r.computed(function(){if(C.searchText()&&C.allOrders().length>0){var r=[],o=C.searchText().toLowerCase();return C.allOrders().forEach(function(e){e.children.forEach(function(e){(e.attr.data.ORDER_NUMBER.toLowerCase().indexOf(o)>=0||e.attr.data.OUTLET_NAME.toLowerCase().indexOf(o)>=0||e.attr.data.PARENT_NAME.toLowerCase().indexOf(o)>=0||e.attr.data.CUSTOMER_NAME.toLowerCase().indexOf(o)>=0)&&r.push(e)})}),new e.JsonTreeDataSource(r)}return new e.JsonTreeDataSource(C.allOrders())}),C.onClearSearchText=function(){C.clearSearch()},C.clearSearch=function(){var e=o("#searchProduct");e.ojInputText("option","value",""),e.ojInputText("reset"),C.searchText("")},C.toggleSearchCanvas=function(){e.OffcanvasUtils.toggle(f)},C.onSearchTextChange=function(e,r){"rawValue"===r.option&&(r.value.length>=2||0==r.value.length)&&(C.searchText(r.value),C.scrollPos(0))},h()}var f;return f={selector:"#searchCanvas",edge:"top",displayMode:"push",size:"63px",modality:"modeless",autoDismiss:"none"},r.bindingHandlers.searchCanvas={init:function(o,t,a){r.utils.domNodeDisposal.addDisposeCallback(o,function(){o&&e.OffcanvasUtils.close(f)})}},new d});