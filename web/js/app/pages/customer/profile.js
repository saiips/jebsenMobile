define(["ojs/ojcore","knockout","jquery","appController","pages/customer/profileService","util/appui","pages/common/constant","util/commonhelper","pages/common/maintenance","promise","ojs/ojknockout","ojs/ojtabs","ojs/ojgauge","ojs/ojtable","ojs/ojarraytabledatasource"],function(e,r,o,s,n,a,t,l,i){function u(){function o(){var e=s.moduleConfig.params.rootContext.selCustomerProfile;if("undefined"!=typeof e){var o=r.utils.unwrapObservable(e.outletName);r.utils.unwrapObservable(T.large())||o.length>t.TITLE_LENGTH&&(o=o.substring(0,t.TITLE_LENGTH)+"..."),T.headerTitle(o)}else T.headerTitle(T.lng_profile)}function u(e){a.showBusy();var r=function(e,r){try{d(e,r.status)}catch(e){console.error(e)}finally{console.log("cbSuccessFn called"),a.hideBusy()}},o=function(e,r){console.log("cbFailFn failed"),d(e,r.status),a.hideBusy()};n.getProfileMessage(_(e)).then(r,o)}function c(e){a.showBusy();var r=function(e,r){try{f(e,r.status)}catch(e){console.error(e)}finally{console.log("cbSuccessFn called"),a.hideBusy()}},o=function(e,r){console.log("cbFailFn failed"),f(e,r.status),a.hideBusy()};n.getSalesPerformanceMessage(p(e)).then(r,o)}function d(e,o){var n=s.moduleConfig.params.rootContext.selCustomerProfile;T.customerNo(r.utils.unwrapObservable(n.accountNumber)),T.shipAddress(r.utils.unwrapObservable(n.shipToAddress)),T.billAddress(r.utils.unwrapObservable(n.billToAddress));var a=e;if("string"==typeof e&&(a=JSON.parse(e)),a.P_CUSTOMER_AGING_TBL&&a.P_CUSTOMER_AGING_TBL.P_CUSTOMER_AGING_TBL_ITEM){var t=a.P_CUSTOMER_AGING_TBL.P_CUSTOMER_AGING_TBL_ITEM;Array.isArray(t)&&(t=t[0]);var l=Number(t.OUTSTANDING_AMOUNT_EXG)-Number(t.ONE_30_DAYS_PAST_DUE)-Number(t.ONE_60_DAYS_PAST_DUE)-Number(t.MORE_THAN_61_DAYS_PAST_DUE);T.agingTotalAmount(t.OUTSTANDING_AMOUNT_EXG),T.agingAmount1(l),T.agingAmount2(t.ONE_30_DAYS_PAST_DUE),T.agingAmount3(t.ONE_60_DAYS_PAST_DUE),T.agingAmount4(t.MORE_THAN_61_DAYS_PAST_DUE)}}function f(e,r){try{if(null!==e&&200==r){var o,s=Array.isArray(e[v]);if(s)o=e[v];else{var n=new Array;n.push(e[v]),o=n}for(var a=[],t=0,l=0,i=0;i<o.length;i++)o[i].UOM||(o[i].UOM=""),t+=new Number(o[i].LAST_YTD_VOLUME),l+=new Number(o[i].THIS_YTD_VOLUME),a.push(o[i]);T.salePerformanceList(o),T.sumLastYtdVolume(t),T.sumThisYtdVolume(l)}}catch(e){console.error(e)}finally{console.log("cbSuccessFn called")}}function g(e){T.salesTarget(0)}function m(e){a.showBusy();var r=function(e,r){try{d(e,r.status)}catch(e){console.error(e)}finally{console.log("cbProfileSuccessFn called")}},o=function(e,r){console.log("cbProfileFailFn failed"),d(e,r.status)},s=function(e,r){try{f(e,r.status)}catch(e){console.error(e)}finally{console.log("cbPerformanceSuccessFn called")}},t=function(e,r){console.log("cbPerformanceFailFn failed"),f(e,r.status)};n.getProfileMessage(_(e)).then(r,o).then(function(){n.getSalesPerformanceMessage(p(e)).then(s,t).then(function(){T.salesTarget(0),a.hideBusy()})})}function _(e){var o=r.utils.unwrapObservable(s.moduleConfig.params.rootContext.selCustomerProfile.accountNumber),n=r.utils.unwrapObservable(s.moduleConfig.params.rootContext.userProfile.orgUnitId),a=s.moduleConfig.params.rootContext.userProfile,t=JSON.stringify({InputGetCustomerAging:{HeaderInfo:{UserID:a.username,UserRole:a.salesRole,CallerID:""},P_ORG_ID:n,P_ACCOUNT_NUMBER:o,P_SHIP_TO_SITE_USE_ID:e}});return t}function p(e){var r=s.moduleConfig.params.rootContext.userProfile,o=JSON.stringify({InputGetSalesByCustomer:{HeaderInfo:{UserID:r.username,UserRole:r.salesRole,CallerID:""},P_ORG_ID:r.orgUnitId,P_SHIP_TO_ORG_ID:e}});return o}function b(){var r=l.getClientYesterday("DD-MMM-YYYY").toUpperCase(),o=e.Translations.getTranslatedString;T.lng_profile=o("ssa.profile.profile"),T.lng_overview=o("ssa.profile.overview"),T.lng_customerNo=o("ssa.profile.customerNo"),T.lng_shippingAddress=o("ssa.profile.shippingAddress"),T.lng_billingAddress=o("ssa.profile.billingAddress"),T.lng_overdueAging=o("ssa.profile.overdueAging")+" "+r,T.lng_salesPerformance=o("ssa.profile.salesPerformance"),T.lng_target=o("ssa.profile.target"),T.lng_lastYearAndYTDPerformance=o("ssa.profile.lastYearAndYTDPerformance")+" "+r,T.lng_0days=o("ssa.profile.days0"),T.lng_0_30days=o("ssa.profile.days0_30"),T.lng_31_60days=o("ssa.profile.days31_60"),T.lng_over60days=o("ssa.profile.daysOver60"),T.lng_totalOutstanding=o("ssa.profile.totalOutstanding"),T.lng_item=o("ssa.profile.item"),T.lng_lastYear=o("ssa.profile.lastYear"),T.lng_YTD=o("ssa.profile.ytd"),T.lng_uom=o("ssa.profile.uom"),T.lng_maintenance=o("ssa.msg.info.maintenance"),T.lng_volume=o("ssa.profile.volume"),T.lng_net=o("ssa.profile.net")}var v="P_SALES_TBL_ITEM",T=this;T.handleActivated=function(n){console.log("profile handleActivated");var a=n.valueAccessor().params.ojRouter.parentRouter;console.log("profile.js parentRouter="+a.currentState().value);var t=a.getChildRouter("profile");return t||(t=a.createChildRouter("profile")),T.router=t.configure(function(o){if(o){var n=new e.RouterState(o,{value:o,enter:function(){console.log("stateId = "+o);var e=s.moduleConfig.params.rootContext.selCustomerProfile.shipToSiteId;console.log("profile stateId="+r.utils.unwrapObservable(e)),T.currStateId(r.utils.unwrapObservable(e))}});return n}}),b(),o(),T.navStateId(s.moduleConfig.params.rootContext.navStateId),e.Router.sync()},T.handleAttached=function(e){},T.handleBindingsApplied=function(e){},T.handleDetached=function(e){},T.currStateId=r.observable(),T.customerNo=r.observable(),T.shipAddress=r.observable(),T.billAddress=r.observable(),T.agingTotalAmount=r.observable(0),T.salesTarget=r.observable(),T.agingAmount1=r.observable(),T.agingAmount2=r.observable(),T.agingAmount3=r.observable(),T.agingAmount4=r.observable(),T.salePerformanceList=r.observableArray(),T.productPerformance=r.computed(function(){if(T.salePerformanceList().length>0)return new e.ArrayTableDataSource(T.salePerformanceList(),{idAttribute:"PRODUCT"})}),T.sumLastYtdVolume=r.observable(0),T.sumThisYtdVolume=r.observable(0),T.netLastYtdVolume=r.computed(function(){return T.salesTarget()-T.sumLastYtdVolume()}),T.netThisYtdVolume=r.computed(function(){return T.salesTarget()-T.sumThisYtdVolume()}),T.headerTitle=r.observable(),T.navDataSource=s.navDataSource,T.navChangeHandler=s.navChangeHandler,T.navStateId=r.observable(),T.currStateId.subscribe(function(e){console.log("shipToSiteId="+e);var r=i.isMaintenance();return r?void a.showMessageBox(T.lng_maintenance):void m(e)}),T.large=r.computed(function(){var r=e.ResponsiveUtils.getFrameworkQuery(e.ResponsiveUtils.FRAMEWORK_QUERY_KEY.LG_UP);return e.ResponsiveKnockoutUtils.createMediaQueryObservable(r)}),T.decimalNumberConverter=e.Validation.converterFactory("number").createConverter({style:"decimal",pattern:"#,##0"}),T.shortNumberConverter=e.Validation.converterFactory("number").createConverter({style:"decimal",decimalFormat:"short"}),T.dispose=function(e){T.router.dispose()},T.isOrderDeskAdmin=r.computed(function(){var e=s.moduleConfig.params.rootContext.userProfile;return e.salesRole==t.SR_ADMIN}),T.refresh=function(){var e=s.moduleConfig.params.rootContext.selCustomerProfile.shipToSiteId;e=r.utils.unwrapObservable(e);var o=i.isMaintenance();return o?void a.showMessageBox(T.lng_maintenance):(u(e),c(e),void g(e))}}return r.bindingHandlers.currency={symbol:r.observable("$"),update:function(e,o,s){return r.bindingHandlers.text.update(e,function(){var e=+(r.utils.unwrapObservable(o())||0),n=r.utils.unwrapObservable(void 0===s().symbol?s().sybmol:"$");return n+e.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")})}},u});