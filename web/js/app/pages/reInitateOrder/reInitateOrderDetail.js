define(["ojs/ojcore","knockout","jquery","appController","pages/reInitateOrder/reInitateOrderService","pages/common/cartService","util/appui","pages/common/constant","pages/checkOut/checkOutService","pages/common/maintenance","util/commonhelper","ojs/ojrouter","ojs/ojknockout","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojselectcombobox","ojs/ojnavigationlist","promise"],function(e,r,o,a,t,s,n,l,i,d,c){function u(){function o(e,r){m.cart.removeAll(),m.order.removeAll(),g(e)}function u(){console.log("initShipmentMethod");var e=function(e,o){if(console.log("cbSuccessFn"),null!==e&&200==o.status){var a=e.P_SHIPPING_METHOD_TBL.P_SHIPPING_METHOD_TBL_ITEM;if(!Array.isArray(a)){var t=new Array;t.push(a),a=t}r.utils.arrayMap(a,function(e){"-1"==e.SHIPPING_METHOD?m.shipmentMethods[e.SHIPPING_METHOD]="":m.shipmentMethods[e.SHIPPING_METHOD]=e.MEANING})}},o=function(e,r){console.log("cbFailFn")};i.getShipmentMethodMessage().then(e,o)}function g(e){try{var o=a.moduleConfig.params.rootContext.headerIdMap,t=o[e],i=t.JsOrderTxnId,d=t.TxnStatus,u=t.CreatedDate;u=c.formatStrDate(u,"YYYY-MM-DDTHH:mm:ss.SSSZ","YYYY/MM/DD");var g=t.Payload[v],b=g.I_HEADER_REC,p=g.I_LINE_TBL.I_LINE_TBL_ITEM;if(!Array.isArray(p)){var f=new Array;f.push(p),p=f}console.log("respJSON="+r.toJSON(g)),m.refNo(i),b.HEADER_FLOW_STATUS_CODE=d,b.ORDERED_DATE=u,b.ORDER_NUMBER=i;var I=s.createOrder(b);_(I),console.log(">>>>>order detail = "+r.toJSON(p));var D=0,h=0;r.utils.arrayMap(p,function(e){var r=m.shipmentMethods[e.SHIPPING_METHOD];console.log("item.SHIPPING_METHOD ="+e.SHIPPING_METHOD),console.log(">>>> meaning = "+r);var o=e.SCHEDULE_SHIP_DATE,a="";try{a=c.formatStrDate(o,"YYYY-MM-DDTHH:mm:ss.SSSZ","DD-MMM-YYYY")}catch(e){}var a=e.SCHEDULE_SHIP_DATE==l.BLANK_DATE?"":a,t=s.createCartItem(e,e.ORDERED_QUANTITY,!1,a,e.ORIGINAL_LINE,new Array,e.SUBINVENTORY,e.SHIPPING_METHOD,r);m.cart.push(t),D+=t.cost(),h++}),console.log("self.cart = "+r.toJSON(m.cart)),m.totalItems(h),m.subtotal(D)}catch(e){n.hideBusy(),console.error(e)}finally{n.hideBusy(),console.log("cbSuccessFn called")}}function _(e,o){console.log(">>>>> order Info = "+r.toJSON(e)),m.cust_name(r.utils.unwrapObservable(e.cust_name)),m.order_no(r.utils.unwrapObservable(e.order_no)),m.purchase_order(r.utils.unwrapObservable(e.purchase_order)),m.order_date(r.utils.unwrapObservable(e.order_date)),m.remarks(r.utils.unwrapObservable(e.remarks)),m.delivery_cost(r.utils.unwrapObservable(e.delivery_cost)),m.shipping_address(r.utils.unwrapObservable(e.shipping_address)),m.billing_address(r.utils.unwrapObservable(e.billing_address)),m.status(r.utils.unwrapObservable(e.status))}function b(){var r=e.Translations.getTranslatedString;m.lng_overrideDeliverySchedule=r("ssa.checkOut.overrideDeliverySchedule"),m.lng_orderDetail=r("ssa.orderDetail.orderDetail"),m.lng_lastSyncDate=r("ssa.header.lastSyncDate"),m.lng_overview=r("ssa.orderDetail.overview"),m.lng_orderNo=r("ssa.orderDetail.orderNo"),m.lng_purchaseOrder=r("ssa.orderDetail.purchaseOrder"),m.lng_orderDate=r("ssa.orderDetail.orderDate"),m.lng_totalItems=r("ssa.orderDetail.totalItems"),m.lng_total=r("ssa.orderDetail.total"),m.lng_remarks=r("ssa.orderDetail.remarks"),m.lng_itemDetail=r("ssa.orderDetail.itemDetail"),m.lng_deliveryStatus=r("ssa.orderDetail.deliveryStatus"),m.lng_subInventory=r("ssa.orderDetail.subInventory"),m.lng_shipmentDate=r("ssa.orderDetail.shipmentDate"),m.lng_shipmentMethod=r("ssa.orderDetail.shipmentMethod"),m.lng_lot=r("ssa.orderDetail.lot"),m.lng_qty=r("ssa.orderDetail.qty"),m.lng_deliveryCost=r("ssa.orderDetail.deliveryCost"),m.lng_orderSummary=r("ssa.orderDetail.orderSummary"),m.lng_shippingAddress=r("ssa.orderDetail.shippingAddress"),m.lng_billingAddress=r("ssa.orderDetail.billingAddress"),m.lng_reOrder=r("ssa.orderDetail.reOrder"),m.lng_quickCheckOut=r("ssa.orderDetail.quickCheckOut"),m.lng_payByCash=r("ssa.orderDetail.payByCash"),m.lng_payByCheque=r("ssa.orderDetail.payByCheque"),m.lng_error_00016=r("ssa.msg.error.ERROR_00016"),m.lng_primaryText=r("ssa.pullToRefreshUtils.primaryText"),m.lng_secondaryText=r("ssa.pullToRefreshUtils.secondaryText"),m.lng_cancel=r("ssa.reInitateOrderDetail.cancel"),m.lng_reInitate=r("ssa.reInitateOrderDetail.reInitate"),m.lng_confirmCancel=r("ssa.reInitateOrderDetail.confirmCancel"),m.lng_confirmReInitate=r("ssa.reInitateOrderDetail.confirmReInitate"),m.lng_reason=r("ssa.orderHistory.reason"),m.lng_refNo=r("ssa.orderHistory.refNo"),m.lng_cancelSuccess=r("ssa.msg.info.cancelSuccess"),m.lng_error_00029=r("ssa.msg.error.ERROR_00029"),m.lng_reInitateSuccess=r("ssa.msg.info.reInitateSuccess"),m.lng_error_00030=r("ssa.msg.error.ERROR_00030"),m.lng_maintenance=r("ssa.msg.info.maintenance")}var m=this;console.log("reInitateOrderDetailDetailViewModel"),m.router=a.router;var v="InputCreateBeerOrder";m.refNo=r.observable(),m.cust_name=r.observable(),m.order_no=r.observable(),m.purchase_order=r.observable(),m.order_date=r.observable(),m.remarks=r.observable(),m.delivery_cost=r.observable(),m.shipping_address=r.observable(),m.billing_address=r.observable(),m.status=r.observable(),m.currHeaderId=r.observable(),m.syncDatetime=r.observable(),m.showMSButton=r.observable(),m.showVSPayButton=r.observable(),m.shipmentMethods={},m.showButtons=r.computed(function(){return!0}),m.subtotal=r.observable(),m.totalItems=r.observable(),m.showLastSyncDate=r.observable(!1),m.isSavedOrder=r.observable(!1),m.isHidenForVanSale=r.computed(function(){var e=a.moduleConfig.params.rootContext.userProfile.salesRole;return e!=l.SR_SALE_VAN}),m.cart=r.observableArray([]),m.order=r.observableArray([]),m.handleActivated=function(o){var t=o.valueAccessor().params.ojRouter.parentRouter;console.log("reInitateOrderDetail.js parentRouter="+t.currentState().value),console.log(">>>>>> originalCart = "+r.toJSON(a.moduleConfig.params.rootContext.originalCart)),a.moduleConfig.params.rootContext.originalCart&&(m.cart.removeAll(),a.moduleConfig.params.rootContext.originalCart=r.observableArray([]));var s=t.getChildRouter("reInitateOrderDetail");return s||(s=t.createChildRouter("reInitateOrderDetail")),m.router=s.configure(function(r){if(r){var o=new e.RouterState(r,{value:r,enter:function(){m.currHeaderId(r),console.log("reInitateOrderDetail.js stateId="+r)}});return o}}),b(),u(),e.Router.sync()},m.currHeaderId.subscribe(function(e){n.showBusy(),console.log("load order detail with oe header id "+e);var r=d.isMaintenance();console.log("isOnline = "+t),console.log("isMaintenance = "+r);var t=a.moduleConfig.params.rootContext.isOnline;t&&!r?o(e,l.PAGE_REFRESH):o(e,l.PAGE_INITIAL)}),m.total=r.computed(function(){var e=0,o=r.utils.unwrapObservable(m.delivery_cost),a=r.utils.unwrapObservable(m.subtotal());return e=new Number(o)+a}),m.goBack=function(){a.go("reInitateOrder")},m.dispose=function(e){m.router.dispose()},m.cancel=function(){if(console.log("cancel trigger"),confirm(m.lng_confirmCancel)){n.showBusy();var e=a.moduleConfig.params.rootContext.userProfile,o=JSON.stringify({InputCancelFailedOrder:{HeaderInfo:{UserID:e.username,UserRole:e.salesRole,CallerID:""},OrderTxnID:m.refNo()}});console.log("cancel failed order pyalod = "+r.toJS(o));var s=function(e,o){console.log("raw data = "+r.toJSON(e));try{if(null!==e&&200==o.status){var t=e.OutputParameters,s=t.O_RESULT_CODE;"S"!=s?n.showMessageBox(m.lng_error_00029):(n.showMessageBox(m.lng_cancelSuccess),a.moduleConfig.params.rootContext.isReInitateRefresh=!0,a.go("reInitateOrder"))}}catch(e){console.error(e)}finally{console.log("cbSuccessFn called"),n.hideBusy()}},l=function(e,r){console.log("cbFailFn failed"),n.showMessageBox(m.lng_error_00029),n.hideBusy()};t.cancelFailedOrderMessage(o).then(s,l)}},m.reInitiate=function(){console.log("reInitiate trigger");var e=d.isMaintenance();if(e)return void n.showMessageBox(m.lng_maintenance);if(confirm(m.lng_confirmReInitate)){n.showBusy();var o=a.moduleConfig.params.rootContext.userProfile,s=JSON.stringify({InputReinitiateOrder:{HeaderInfo:{UserID:o.username,UserRole:o.salesRole,CallerID:""},OrderTxnID:m.refNo()}});console.log("Re-Initiate failed order pyalod = "+r.toJS(s));var l=function(e,o){console.log("raw data = "+r.toJSON(e));try{if(null!==e&&200==o.status){var t=e.OutputReinitiateOrder,s=t.ReturnStatus;t.ReturnMessage;"S"!=s?n.showMessageBox(m.lng_error_00030):(n.showMessageBox(m.lng_reInitateSuccess),a.moduleConfig.params.rootContext.isReInitateRefresh=!0,a.go("reInitateOrder"))}}catch(e){console.error(e)}finally{console.log("cbSuccessFn called"),n.hideBusy()}},i=function(e,r){console.log("cbFailFn failed"),n.showMessageBox(m.lng_error_00030),n.hideBusy()};t.reInitiateFailedOrderMessage(s).then(l,i)}}}return r.bindingHandlers.winsize={init:function(e,r,a,t,s){o(window).resize(function(){t.screenWidth(o(window).width()),t.screenHeight(o(window).height())})}},r.bindingHandlers.currency={symbol:r.observable("$"),update:function(e,o,a){return r.bindingHandlers.text.update(e,function(){var e=+(r.utils.unwrapObservable(o())||0),t=r.utils.unwrapObservable(void 0===a().symbol?a().sybmol:"$");return t+e.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")})}},r.bindingHandlers.readOnly={update:function(e,o){var a=r.utils.unwrapObservable(o());a?e.setAttribute("readOnly",!0):e.removeAttribute("readOnly")}},u});