define(["ojs/ojcore","knockout","jquery","appController","pages/reInitateOrder/reInitateOrderService","pages/common/cartService","util/appui","util/commonhelper","pages/common/constant","ojs/ojknockout","ojs/ojlistview","ojs/ojjsontreedatasource","ojs/ojnavigationlist","promise","ojs/ojtoolbar","ojs/ojpulltorefresh","ojs/ojoffcanvas"],function(e,r,t,o,a,n,s,l,i){function c(){function n(){var e=o.moduleConfig.params.rootContext.userProfile,r=JSON.stringify({InputGetFailedOrder:{HeaderInfo:{UserID:e.username,UserRole:e.salesRole,CallerID:""}}});return r}function c(){s.showBusy(),E.ready(!1);var e=function(e,r){try{f(e,r.status)}catch(e){console.error(e)}finally{console.log("cbSuccessFn called"),s.hideBusy(),R(),o.moduleConfig.params.rootContext.isReInitateRefresh=!1}},t=function(e,r){console.log("cbFailFn failed"),f(e,r.status),s.hideBusy(),o.moduleConfig.params.rootContext.isReInitateRefresh=!1},l=n();console.log("Payload ="+r.toJS(l));var i=o.moduleConfig.params.rootContext.isReInitateRefresh;i&&"undefined"!=typeof i?a.refreshOrderListMessage(l).then(e,t):a.getOrderListMessage(l).then(e,t),E.ready(!0)}function d(){var e=function(e,r){try{f(e,r.status)}catch(e){console.error(e)}finally{R(),s.hideBusy(),console.log("cbSuccessFn called")}},r=function(e,r){console.log("cbFailFn failed"),f(e,r.status),s.hideBusy()},t=n();a.refreshOrderListMessage(t).then(e,r)}function f(e,t){if(console.log("raw data = "+r.toJSON(e)),e=Array.isArray(e)?e[0]:e,null!==e&&200==t){E.allOrders.removeAll();var a=e[p].TblJsOrderTxn,n=[],s=[],c={},u=Array.isArray(a)?a[0]:a;if(console.log("temp="+r.toJSON(u)),!u&&null==u)return;for(var d=0;d<a.length;d++){var f=a[d].JsOrderTxnId,R=(a[d].OrderType,a[d].ErrorMsg),t=a[d].TxnStatus,h=a[d].Payload.InputCreateBeerOrder,T=h.I_HEADER_REC.ORDER_TYPE_ID;console.log("orderTypeId="+T);var v=h.I_HEADER_REC.OUTLET_NAME,D=a[d].CreatedDate;D=l.formatStrDate(D,"YYYY-MM-DDTHH:mm:ss.SSSZ","YYYY/MM/DD");var g=D+":"+v;h.I_HEADER_REC.ID=f,h.I_HEADER_REC.ERROR_MSG=R,h.I_HEADER_REC.HEADER_FLOW_STATUS_CODE=t,T==i.ORDER_TYPE_ID_BEER?h.I_HEADER_REC.ORDER_TYPE="13-C0 STOCK ORDER":T==i.ORDER_TYPE_ID_WINE?h.I_HEADER_REC.ORDER_TYPE="13-G0 STOCK ORDER":h.I_HEADER_REC.ORDER_TYPE=T,"undefined"==typeof c[f]&&(c[f]=a[d]),s.indexOf(g)>-1?n[s.indexOf(g)].children.push({attr:{id:f,data:a[d]}}):(s.push(g),n.push({attr:{id:f,orderDate:D,outletName:v},children:[{attr:{id:f,data:a[d]}}]}))}n.sort(function(e,r){return e.attr.orderDate>r.attr.orderDate?1:e.attr.orderDate<r.attr.orderDate?-1:0}),n.forEach(function(e){e.children.sort(function(e,r){return e.attr.ORDERED_DATE>r.attr.ORDERED_DATE?1:e.attr.ORDERED_DATE<r.attr.ORDERED_DATE?-1:e.attr.ORDER_NUMBER<r.attr.ORDER_NUMBER?1:e.attr.ORDER_NUMBER>r.attr.ORDER_NUMBER?-1:0})}),E.allOrders(n),o.moduleConfig.params.rootContext.headerIdMap=c}}function R(){var e=i.FAILED_ORDER_LIST_KEY,r=s.getLocalStorage(e+":"+i.RE_INITATE_ORDER_SYNC_DATETIME);r&&(E.syncDatetime(r),E.showLastSyncDate(!0))}function h(){var r=e.Translations.getTranslatedString;E.lng_reInitateOrderList=r("ssa.springboard.reInitiateOrderList"),E.lng_searchPlaceHolder=r("ssa.header.customerSearch"),E.lng_lastSyncDate=r("ssa.header.lastSyncDate"),E.lng_orderType=r("ssa.orderHistory.orderType"),E.lng_price=r("ssa.orderHistory.price"),E.lng_order=r("ssa.orderHistory.order"),E.lng_primaryText=r("ssa.pullToRefreshUtils.primaryText"),E.lng_secondaryText=r("ssa.pullToRefreshUtils.secondaryText"),E.lng_purchaseOrder=r("ssa.checkOut.purchaseOrder"),E.lng_reason=r("ssa.orderHistory.reason"),E.lng_refNo=r("ssa.orderHistory.refNo")}var E=this;E.router=o.router;var p="OutputGetFailedOrder";E.handleActivated=function(t){h(),E.searchText(""),E.scrollPos(0);var a=t.valueAccessor().params.ojRouter.parentRouter;console.log("reInitateOrders.js parentRouter="+a.currentState().value);var n=a.getChildRouter("reInitateOrders");return n||(n=a.createChildRouter("reInitateOrders")),E.router=n.configure(function(r){if(r){var t=new e.RouterState(r,{value:r,enter:function(){console.log("reInitateOrders.js stateId="+r)}});return t}}),E.headerTitle(E.lng_reInitateOrderList),c(),E.isOrderDeskAdmin=r.computed(function(){var e=o.moduleConfig.params.rootContext.userProfile;return e.salesRole==i.SR_ADMIN||!o.moduleConfig.params.rootContext.isCordova}),e.Router.sync()},E.handleAttached=function(e){},E.handleBindingsApplied=function(e){var r=t("#globalBody").find(".oj-hybrid-applayout-content"),o="oj-hybrid-applayout-scrollable";r.hasClass(o)&&(t("#searchCanvas").on("ojbeforeopen",function(){r.removeClass(o)}),t("#searchCanvas").on("ojbeforeclose",function(){r.addClass(o)})),t("#searchCanvas").on("ojclose",function(){E.clearSearch()})},E.handleDetached=function(e){},E.optionChange=function(e,r){"selection"===r.option&&r.value[0]&&(console.log("reInitateOrders.js orderId="+r.value),o.redirect("reInitateOrderDetail",r.value))},E.dispose=function(e){E.router.dispose()},E.headerTitle=r.observable(),E.outLetId=r.observable(),E.allOrders=r.observableArray(),E.searchText=r.observable(""),E.scrollPos=r.observable(0),E.searchText.extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}});var T=o.moduleConfig.params.rootContext.userProfile;o.populateDefaultNavPath(T),E.navDataSource=o.navDataSource,E.navChangeHandler=o.navChangeHandler,E.navStateId=r.observable(),E.syncDatetime=r.observable(),E.showLastSyncDate=r.observable(!1),E.ready=r.observable(!1),E.large=r.computed(function(){var r=e.ResponsiveUtils.getFrameworkQuery(e.ResponsiveUtils.FRAMEWORK_QUERY_KEY.LG_UP);return e.ResponsiveKnockoutUtils.createMediaQueryObservable(r)}),E.itemOnly=function(e){return e.leaf},E.selectTemplate=function(e,r){return r.$itemContext.leaf?"item_template":"group_template"},E.refresh=function(){s.showBusy(),d()},E.onPageReady=function(){try{e.PullToRefreshUtils.setupPullToRefresh("#listviewContainer",function(){var e=new Promise(function(e,r){E.onClearSearchText(),d(),setTimeout(function(){e()},3e3)});return e},{primaryText:E.lng_primaryText,secondaryText:E.lng_secondaryText})}catch(e){console.error(e)}},t(document).ready(function(){e.PullToRefreshUtils.setupPullToRefresh("#listviewContainer",function(){var e=new Promise(function(e,r){E.onClearSearchText(),d(),setTimeout(function(){e()},3e3)});return e},{primaryText:E.lng_primaryText,secondaryText:E.lng_secondaryText}),t("#listview").on({ojdestroy:function(){e.PullToRefreshUtils.tearDownPullToRefresh("#listviewContainer")}})}),E.orders=r.computed(function(){if(E.searchText()&&E.allOrders().length>0){var r=[],t=E.searchText().toLowerCase();return E.allOrders().forEach(function(e){e.children.forEach(function(e){(e.attr.data.ORDER_NUMBER.toLowerCase().indexOf(t)>=0||e.attr.data.OUTLET_NAME.toLowerCase().indexOf(t)>=0||e.attr.data.PARENT_NAME.toLowerCase().indexOf(t)>=0||e.attr.data.CUSTOMER_NAME.toLowerCase().indexOf(t)>=0)&&r.push(e)})}),new e.JsonTreeDataSource(r)}return new e.JsonTreeDataSource(E.allOrders())}),E.onClearSearchText=function(){E.clearSearch()},E.clearSearch=function(){var e=t("#searchProduct");e.ojInputText("option","value",""),e.ojInputText("reset"),E.searchText("")},E.toggleSearchCanvas=function(){e.OffcanvasUtils.toggle(u)},E.onSearchTextChange=function(e,r){"rawValue"===r.option&&(r.value.length>=2||0==r.value.length)&&(E.searchText(r.value),E.scrollPos(0))}}var u;return u={selector:"#searchCanvas",edge:"top",displayMode:"push",size:"63px",modality:"modeless",autoDismiss:"none"},r.bindingHandlers.searchCanvas={init:function(t,o,a){r.utils.domNodeDisposal.addDisposeCallback(t,function(){t&&e.OffcanvasUtils.close(u)})}},new c});