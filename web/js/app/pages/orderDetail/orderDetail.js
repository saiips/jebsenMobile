define(["ojs/ojcore","knockout","jquery","appController","pages/orderDetail/orderDetailService","pages/common/cartService","util/appui","pages/common/constant","pages/checkOut/checkOutService","pages/common/maintenance","ojs/ojrouter","ojs/ojknockout","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojselectcombobox","ojs/ojnavigationlist","promise"],function(e,r,o,t,a,n,s,i,l,d){function u(){function u(e){var r=t.moduleConfig.params.rootContext.userProfile,o=JSON.stringify({InputGetOrderLineList:{HeaderInfo:{UserID:r.username,UserRole:r.salesRole,CallerID:""},P_ORG_ID:_,P_HEADER_ID:e}});return o}function c(e,r){function o(e,r){p(e,r)}function t(e,r){console.log("cbFailFn failed"),s.hideBusy(),s.showMessageBox(C.lng_error_00016)}C.cart.removeAll(),C.order.removeAll(),r===i.PAGE_INITIAL?a.getOrderDetailMessage(u(e)).then(o,t):r===i.PAGE_REFRESH?a.refreshOrderDetailMessage(u(e)).then(o,t):r===i.PAGE_DATASYNC&&a.getDataSyncMessage().then(o,t);var n=i.ORDER_LINES_KEY+":"+_+":"+e+":"+i.ORDER_DETAIL_SYNC_DATETIME,l=s.getLocalStorage(n);l&&(C.syncDatetime(l),C.showLastSyncDate(!0))}function m(){console.log("initShipmentMethod");var e=function(e,o){if(console.log("cbSuccessFn"),null!==e&&200==o.status){var t=e.P_SHIPPING_METHOD_TBL.P_SHIPPING_METHOD_TBL_ITEM;if(!Array.isArray(t)){var a=new Array;a.push(t),t=a}r.utils.arrayMap(t,function(e){"-1"==e.SHIPPING_METHOD?C.shipmentMethods[e.SHIPPING_METHOD]="":C.shipmentMethods[e.SHIPPING_METHOD]=e.MEANING})}},o=function(e,r){console.log("cbFailFn")};l.getShipmentMethodMessage().then(e,o)}function p(e,o){console.log("raw data = "+r.toJSON(e));try{if(null!==e&&200==o.status){var a,l=Array.isArray(e[v]);if(l)a=e[v];else{var d=new Array;d.push(e[v]),a=d}var u=n.getOrder();f(u),g()&&(a=e.data),console.log(">>>>>order detail = "+r.toJSON(a));var c=0,m=0;r.utils.arrayMap(a,function(e){var r=C.shipmentMethods[e.SHIPPING_METHOD];console.log("item.SHIPPING_METHOD ="+e.SHIPPING_METHOD),console.log(">>>> meaning = "+r);var o=e.SCHEDULE_SHIP_DATE==i.BLANK_DATE?"":e.SCHEDULE_SHIP_DATE,t=n.createCartItem(e,e.ORDERED_QUANTITY,!1,o,e.ORIGINAL_LINE,new Array,e.SUBINVENTORY,e.SHIPPING_METHOD,r);C.cart.push(t),c+=t.cost(),m++}),console.log("self.cart = "+r.toJSON(C.cart)),C.totalItems(m),C.subtotal(c),t.moduleConfig.params.rootContext.orderDetail_state="populated"}}catch(e){s.hideBusy(),console.error(e)}finally{s.hideBusy(),console.log("cbSuccessFn called"),C.continuePayment()}}function g(){return t.moduleConfig.params.rootContext.isDataSync}function f(e){console.log(">>>>> order Info = "+r.toJSON(e)),C.cust_name(r.utils.unwrapObservable(e.cust_name)),C.order_no(r.utils.unwrapObservable(e.order_no)),C.purchase_order(r.utils.unwrapObservable(e.purchase_order)),C.order_date(r.utils.unwrapObservable(e.order_date)),C.remarks(r.utils.unwrapObservable(e.remarks)),C.delivery_cost(r.utils.unwrapObservable(e.delivery_cost)),C.shipping_address(r.utils.unwrapObservable(e.shipping_address)),C.billing_address(r.utils.unwrapObservable(e.billing_address)),C.status(r.utils.unwrapObservable(e.status)),C.paymentMethod(r.utils.unwrapObservable(e.payment_method))}function b(){var r=e.Translations.getTranslatedString;C.lng_orderDetail=r("ssa.orderDetail.orderDetail"),C.lng_lastSyncDate=r("ssa.header.lastSyncDate"),C.lng_overview=r("ssa.orderDetail.overview"),C.lng_orderNo=r("ssa.orderDetail.orderNo"),C.lng_purchaseOrder=r("ssa.orderDetail.purchaseOrder"),C.lng_orderDate=r("ssa.orderDetail.orderDate"),C.lng_totalItems=r("ssa.orderDetail.totalItems"),C.lng_total=r("ssa.orderDetail.total"),C.lng_remarks=r("ssa.orderDetail.remarks"),C.lng_itemDetail=r("ssa.orderDetail.itemDetail"),C.lng_deliveryStatus=r("ssa.orderDetail.deliveryStatus"),C.lng_subInventory=r("ssa.orderDetail.subInventory"),C.lng_shipmentDate=r("ssa.orderDetail.shipmentDate"),C.lng_shipmentMethod=r("ssa.orderDetail.shipmentMethod"),C.lng_lot=r("ssa.orderDetail.lot"),C.lng_qty=r("ssa.orderDetail.qty"),C.lng_deliveryCost=r("ssa.orderDetail.deliveryCost"),C.lng_orderSummary=r("ssa.orderDetail.orderSummary"),C.lng_shippingAddress=r("ssa.orderDetail.shippingAddress"),C.lng_billingAddress=r("ssa.orderDetail.billingAddress"),C.lng_reOrder=r("ssa.orderDetail.reOrder"),C.lng_quickCheckOut=r("ssa.orderDetail.quickCheckOut"),C.lng_payByCash=r("ssa.orderDetail.payByCash"),C.lng_payByCheque=r("ssa.orderDetail.payByCheque"),C.lng_error_00016=r("ssa.msg.error.ERROR_00016"),C.lng_primaryText=r("ssa.pullToRefreshUtils.primaryText"),C.lng_secondaryText=r("ssa.pullToRefreshUtils.secondaryText"),C.lng_confirmClear=r("ssa.checkOut.confirmClear")}var C=this;console.log("OrderDetailViewModel"),C.router=t.router;var v="P_ORDER_LINES_TBL_ITEM",_=t.moduleConfig.params.rootContext.userProfile.orgUnitId;C.cust_name=r.observable(),C.order_no=r.observable(),C.purchase_order=r.observable(),C.order_date=r.observable(),C.remarks=r.observable(),C.delivery_cost=r.observable(),C.shipping_address=r.observable(),C.billing_address=r.observable(),C.status=r.observable(),C.currHeaderId=r.observable(),C.syncDatetime=r.observable(),C.showMSButton=r.observable(),C.showVSPayButton=r.observable(),C.shipmentMethods={},C.paymentMethod=r.observable(),C.showButtons=r.computed(function(){return 1!=t.moduleConfig.params.rootContext.isDailyOrderSummary}),C.subtotal=r.observable(),C.totalItems=r.observable(),C.showLastSyncDate=r.observable(!1),C.isSavedOrder=r.observable(!1),C.showDeliveryIcon=r.computed(function(){return!t.moduleConfig.params.rootContext.isDataSync}),C.isHidenForVanSale=r.computed(function(){var e=t.moduleConfig.params.rootContext.userProfile.salesRole;return e!=i.SR_SALE_VAN}),C.cart=r.observableArray([]),C.order=r.observableArray([]),C.handleActivated=function(o){var a=o.valueAccessor().params.ojRouter.parentRouter;console.log("orderDetail.js parentRouter="+a.currentState().value),console.log(">>>>>> originalCart = "+r.toJSON(t.moduleConfig.params.rootContext.originalCart)),t.moduleConfig.params.rootContext.originalCart&&(C.cart.removeAll(),t.moduleConfig.params.rootContext.originalCart=r.observableArray([]));var n=a.getChildRouter("orderDetail");return n||(n=a.createChildRouter("orderDetail")),C.router=n.configure(function(r){if(r){var o=new e.RouterState(r,{value:r,enter:function(){C.currHeaderId(r),console.log("orderDetail.js stateId="+r)}});return o}}),b(),m(),e.Router.sync()},C.currHeaderId.subscribe(function(e){s.showBusy(),console.log("load order detail with oe header id "+e);var r=d.isMaintenance();console.log("isOnline = "+o),console.log("isMaintenance = "+r),console.log("isDataSync = "+g());var o=t.moduleConfig.params.rootContext.isOnline;!o||r||g()?g()?g()&&c(e,i.PAGE_DATASYNC):c(e,i.PAGE_INITIAL):c(e,i.PAGE_REFRESH)}),C.total=r.computed(function(){var e=0,o=r.utils.unwrapObservable(C.delivery_cost),t=r.utils.unwrapObservable(C.subtotal());return e=new Number(o)+t}),o(document).ready(function(){e.PullToRefreshUtils.setupPullToRefresh("#orderDetail",function(){var e=new Promise(function(e,o){C.isSavedOrder()===!1&&c(r.utils.unwrapObservable(C.currHeaderId),i.PAGE_REFRESH),setTimeout(function(){e()},3e3)});return e},{primaryText:C.lng_primaryText,secondaryText:C.lng_secondaryText}),o("#orderDetail").on({ojdestroy:function(){e.PullToRefreshUtils.tearDownPullToRefresh("#orderDetail")}})}),C.removeFromCart=function(e,r){C.cart.remove(e)},C.reOrder=function(e,o){t.moduleConfig.params.rootContext.originalCart=r.observableArray(),r.utils.arrayMap(C.cart(),function(e){"Y"==r.utils.unwrapObservable(e.original)&&(e.shipmentMethod="",e.shipmentMethodDisplay="",e.subInventory="",t.moduleConfig.params.rootContext.originalCart.push(e))}),t.moduleConfig.params.rootContext.isReOrder=!0,t.moduleConfig.params.rootContext.fromPage="orderDetail";var a=r.utils.unwrapObservable(C.currHeaderId);t.moduleConfig.params.rootContext.orderId=a,t.moduleConfig.params.rootContext.newOrderNavStateId="newOrderItem",t.redirect("newOrderItem",a)},C.showEraseButton=r.computed(function(){return g()}),C.clearData=function(e,o){if(console.log("clear the offline data of sales order"),g()&&confirm(C.lng_confirmClear)){var a=t.moduleConfig.params.rootContext.savedOrder,n=r.toJS({status:"D",data:a.data});t.moduleConfig.params.rootContext.savedOrder=n,t.go("dataSync")}},C.continuePayment=function(e,o){if(t.moduleConfig.params.rootContext.isContinuePayment){var a="-1"==C.paymentMethod()?i.PAY_BY_OTHERS:C.paymentMethod(),s=r.toJS({HEADER_ID:C.currHeaderId(),ORDER_NUMBER:C.order_no(),FLOW_STATUS_CODE:C.status(),PAYMENT_TYPE:a});console.log("paymentParams="+r.toJSON(s)),n.setCart(C.cart),t.moduleConfig.params.rootContext.paymentParameter=s,t.redirect("payment",C.currHeaderId())}},C.checkOut=function(e,o){t.moduleConfig.params.rootContext.originalCart=r.observableArray(),r.utils.arrayMap(C.cart(),function(e){"Y"==r.utils.unwrapObservable(e.original)&&(e.shipmentMethod="",e.shipmentMethodDisplay="",e.subInventory="",t.moduleConfig.params.rootContext.originalCart.push(e))}),t.moduleConfig.params.rootContext.isQuickCheckOut=!0,t.moduleConfig.params.rootContext.fromPage="orderDetail",t.moduleConfig.params.rootContext.orderId=r.utils.unwrapObservable(C.currHeaderId),t.redirect("checkOut",t.moduleConfig.params.rootContext.orderId)},C.payByCash=function(e,o){t.moduleConfig.params.rootContext.originalCart=r.observableArray(),r.utils.arrayMap(C.cart(),function(e){t.moduleConfig.params.rootContext.originalCart.push(e)}),t.moduleConfig.params.rootContext.fromPage="orderDetail",t.moduleConfig.params.rootContext.paymentMethod=i.PAY_BY_CASH,t.moduleConfig.params.rootContext.orderId=r.utils.unwrapObservable(C.currHeaderId),t.redirect("payment",t.moduleConfig.params.rootContext.orderId)},C.payByCheque=function(e,o){t.moduleConfig.params.rootContext.originalCart=r.observableArray(),r.utils.arrayMap(C.cart(),function(e){t.moduleConfig.params.rootContext.originalCart.push(e)}),t.moduleConfig.params.rootContext.fromPage="orderDetail",t.moduleConfig.params.rootContext.paymentMethod=i.PAY_BY_CHEQUE,t.moduleConfig.params.rootContext.orderId=r.utils.unwrapObservable(C.currHeaderId),t.redirect("payment",t.moduleConfig.params.rootContext.orderId)},C.deliveryList=function(e,o){t.moduleConfig.params.rootContext.fromPage="orderDetail",t.moduleConfig.params.rootContext.orderId=r.utils.unwrapObservable(C.currHeaderId),t.moduleConfig.params.rootContext.orderNumber=r.utils.unwrapObservable(C.order_no);var a=r.utils.unwrapObservable(C.order_no);t.redirect("delivery",a)},C.updateData=function(e,r){"value"===r.option&&e.target.id&&n.setCart(C.cart)},C.goBack=function(){if(t.moduleConfig.params.rootContext.isDailyOrderSummary)t.go("dailyOrders");else if(console.log("isDataSync()="+g()),g())t.go("dataSync");else{var e=t.moduleConfig.params.rootContext.custId;t.redirect("orderHist",e)}},C.dispose=function(e){C.router.dispose()},C.isOrderDeskAdmin=r.computed(function(){var e=t.moduleConfig.params.rootContext.userProfile;return e.salesRole==i.SR_ADMIN||!t.moduleConfig.params.rootContext.isCordova}),C.refresh=function(){s.showBusy(),c(r.utils.unwrapObservable(C.currHeaderId),i.PAGE_REFRESH)}}return r.bindingHandlers.winsize={init:function(e,r,t,a,n){o(window).resize(function(){a.screenWidth(o(window).width()),a.screenHeight(o(window).height())})}},r.bindingHandlers.currency={symbol:r.observable("$"),update:function(e,o,t){return r.bindingHandlers.text.update(e,function(){var e=+(r.utils.unwrapObservable(o())||0),a=r.utils.unwrapObservable(void 0===t().symbol?t().sybmol:"$");return a+e.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")})}},r.bindingHandlers.readOnly={update:function(e,o){var t=r.utils.unwrapObservable(o());t?e.setAttribute("readOnly",!0):e.removeAttribute("readOnly")}},u});