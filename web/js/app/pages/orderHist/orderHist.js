define(["ojs/ojcore","knockout","jquery","appController","pages/orderHist/orderHistService","pages/common/cartService","util/appui","util/commonhelper","pages/common/constant","ojs/ojknockout","ojs/ojlistview","ojs/ojjsontreedatasource","ojs/ojnavigationlist","promise","ojs/ojtoolbar","ojs/ojpulltorefresh","ojs/ojoffcanvas"],function(e,r,t,o,a,n,s,i,l){function u(){function u(e){var t=o.moduleConfig.params.rootContext.userProfile,a=r.utils.unwrapObservable(e);console.log("shipToSiteId = "+a);var n=JSON.stringify({InputParameters:{HeaderInfo:{UserID:t.username,UserRole:t.salesRole,CallerID:""},P_ORG_ID:v,P_ACCOUNT_NUMBER:C,P_SHIP_TO_ORG_ID:new String(a).toString()}});return n}function c(e){s.showBusy();var r=function(e,r){try{p(e,r.status)}catch(e){console.error(e)}finally{console.log("cbSuccessFn called"),s.hideBusy(),o.moduleConfig.params.rootContext.requireRefresh=!1}},t=function(e,r){console.log("cbFailFn failed"),p(e,r.status),s.hideBusy(),o.moduleConfig.params.rootContext.requireRefresh=!1};o.moduleConfig.params.rootContext.requireRefresh?a.refreshOrderListMessage(u(e)).then(r,t):a.getOrderListMessage(u(e)).then(r,t)}function f(e){var r=function(e,r){try{p(e,r.status)}catch(e){console.error(e)}finally{console.log("cbSuccessFn called"),s.hideBusy()}},t=function(e,r){console.log("cbFailFn failed"),p(e,r.status),s.hideBusy()};a.refreshOrderListMessage(u(e)).then(r,t)}function p(e,t){if(e=Array.isArray(e)?e[0]:e,null!==e&&200==t){for(var a=e[g],u=[],d=[],c={},f=0;f<a.length;f++){var p=(a[f].ORDER_NUMBER,a[f].OE_HEADER_ID),m=n.createOrder(a[f]);"undefined"==typeof c[p]&&(c[p]=m);var R=a[f].ORDERED_DATE;i.isValid(R)&&(R=i.formatStrDateToYYYYMMDD(R)),d.indexOf(R)>-1?u[d.indexOf(R)].children.push({attr:{id:p,data:a[f]}}):(d.push(R),u.push({attr:{id:p,orderDate:R},children:[{attr:{id:p,data:a[f]}}]}))}u.sort(function(e,r){return e.attr.orderDate<r.attr.orderDate?1:e.attr.orderDate>r.attr.orderDate?-1:0}),u.forEach(function(e){e.children.sort(function(e,r){return e.attr.ORDERED_DATE<r.attr.ORDERED_DATE?1:e.attr.ORDERED_DATE>r.attr.ORDERED_DATE?-1:e.attr.ORDER_NUMBER<r.attr.ORDER_NUMBER?1:e.attr.ORDER_NUMBER>r.attr.ORDER_NUMBER?-1:0})}),h.allOrders(u),o.moduleConfig.params.rootContext.headerIdMap=c;var T=r.utils.unwrapObservable(o.moduleConfig.params.rootContext.outLetId),y=l.ORDER_LIST_KEY+":"+v+":"+C+":"+T+":"+l.ORDER_HISTORY_SYNC_DATETIME,e=s.getLocalStorage(y);e&&(h.syncDatetime(e),h.showLastSyncDate(!0))}}function m(){var r=e.Translations.getTranslatedString;h.lng_orderInquiryList=r("ssa.orderHistory.orderInquiryList"),h.lng_searchPlaceHolder=r("ssa.header.search"),h.lng_lastSyncDate=r("ssa.header.lastSyncDate"),h.lng_orderType=r("ssa.orderHistory.orderType"),h.lng_price=r("ssa.orderHistory.price"),h.lng_order=r("ssa.orderHistory.order"),h.lng_primaryText=r("ssa.pullToRefreshUtils.primaryText"),h.lng_secondaryText=r("ssa.pullToRefreshUtils.secondaryText")}var h=this;h.router=o.router,m();var g="P_ORDER_TBL_ITEM",v=o.moduleConfig.params.rootContext.userProfile.orgUnitId,C=o.moduleConfig.params.rootContext.custId;h.handleActivated=function(t){h.searchText("");var a=t.valueAccessor().params.ojRouter.parentRouter;console.log("orderHist.js parentRouter="+a.currentState().value);var n=a.getChildRouter("orderHist");n||(n=a.createChildRouter("orderHist")),h.router=n.configure(function(t){if(t){var a=new e.RouterState(t,{value:t,enter:function(){h.outLetId(r.utils.unwrapObservable(o.moduleConfig.params.rootContext.outLetId)),console.log("orderHist.js outLetId = "+r.utils.unwrapObservable(o.moduleConfig.params.rootContext.outLetId))}});return a}});var s=o.moduleConfig.params.rootContext.selCustomerProfile;if("undefined"!=typeof s){var i=r.utils.unwrapObservable(s.outletName);r.utils.unwrapObservable(h.large())||i.length>l.TITLE_LENGTH&&(i=i.substring(0,l.TITLE_LENGTH)+"..."),h.headerTitle(i)}else h.headerTitle(h.lng_orderInquiryList);return h.navStateId(o.moduleConfig.params.rootContext.navStateId),e.Router.sync()},h.isOrderDeskAdmin=r.computed(function(){var e=o.moduleConfig.params.rootContext.userProfile;return e.salesRole==l.SR_ADMIN||!o.moduleConfig.params.rootContext.isCordova}),h.handleAttached=function(e){},h.handleBindingsApplied=function(e){var r=t("#globalBody").find(".oj-hybrid-applayout-content"),o="oj-hybrid-applayout-scrollable";r.hasClass(o)&&(t("#searchCanvas").on("ojbeforeopen",function(){r.removeClass(o)}),t("#searchCanvas").on("ojbeforeclose",function(){r.addClass(o)})),t("#searchCanvas").on("ojclose",function(){h.clearSearch()})},h.handleDetached=function(e){},h.handleTransitionCompleted=function(e){},h.add=function(e){o.moduleConfig.params.rootContext.originalCart=r.observableArray(),o.moduleConfig.params.rootContext.fromPage="orderHist",o.moduleConfig.params.rootContext.newOrderNavStateId="newOrderItem",o.moduleConfig.params.rootContext.isReOrder=!1,o.redirect("newOrderItem",C)},h.optionChange=function(e,r){if("selection"===r.option&&r.value[0]){console.log("orderHist.js orderId="+r.value);var t=o.moduleConfig.params.rootContext.headerIdMap,a=t[r.value];if(o.moduleConfig.params.rootContext.isReOrder=!1,o.moduleConfig.params.rootContext.isDailyOrderSummary=!1,o.moduleConfig.params.rootContext.isDataSync=!1,n.setOrder(a),a){var s=o.moduleConfig.params.rootContext.userProfile,i=a.status();i==l.ORDER_STATUS_ENTERED&&s.salesRole==l.SR_SALE_VAN?o.moduleConfig.params.rootContext.isContinuePayment=!0:o.moduleConfig.params.rootContext.isContinuePayment=!1}o.redirect("orderDetail",r.value)}},h.dispose=function(e){h.router.dispose()},h.headerTitle=r.observable(),h.outLetId=r.observable(),h.allOrders=r.observableArray(),h.searchText=r.observable(""),h.searchText.extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}});var R=o.moduleConfig.params.rootContext.userProfile;o.populateDefaultNavPath(R),h.navDataSource=o.navDataSource,h.navChangeHandler=o.navChangeHandler,h.navStateId=r.observable(),h.syncDatetime=r.observable(),h.showLastSyncDate=r.observable(!1),h.large=r.computed(function(){var r=e.ResponsiveUtils.getFrameworkQuery(e.ResponsiveUtils.FRAMEWORK_QUERY_KEY.LG_UP);return e.ResponsiveKnockoutUtils.createMediaQueryObservable(r)}),h.itemOnly=function(e){return e.leaf},h.selectTemplate=function(e,r){return r.$itemContext.leaf?"item_template":"group_template"},h.refresh=function(){s.showBusy();var e=new String(r.utils.unwrapObservable(h.outLetId)).toString();f(e)},h.outLetId.subscribe(function(e){c(e)}),h.onPageReady=function(){try{e.PullToRefreshUtils.setupPullToRefresh("#listviewContainer",function(){var e=new Promise(function(e,t){h.onClearSearchText();var o=new String(r.utils.unwrapObservable(h.outLetId)).toString();f(o),setTimeout(function(){e()},3e3)});return e},{primaryText:h.lng_primaryText,secondaryText:h.lng_secondaryText})}catch(e){console.error(e)}},t(document).ready(function(){e.PullToRefreshUtils.setupPullToRefresh("#listviewContainer",function(){var e=new Promise(function(e,t){var o=new String(r.utils.unwrapObservable(h.outLetId)).toString();f(o),setTimeout(function(){e()},3e3)});return e},{primaryText:h.lng_primaryText,secondaryText:h.lng_secondaryText}),t("#listview").on({ojdestroy:function(){e.PullToRefreshUtils.tearDownPullToRefresh("#listviewContainer")}})}),h.orders=r.computed(function(){if(h.searchText()&&h.allOrders().length>0){var r=[],t=h.searchText().toLowerCase();return h.allOrders().forEach(function(e){e.children.forEach(function(e){0===e.attr.data.ORDER_NUMBER.toLowerCase().indexOf(t)&&r.push(e)})}),new e.JsonTreeDataSource(r)}return new e.JsonTreeDataSource(h.allOrders())}),h.onClearSearchText=function(){h.clearSearch()},h.clearSearch=function(){var e=t("#searchProduct");e.ojInputText("option","value",""),e.ojInputText("reset"),h.searchText("")},h.toggleSearchCanvas=function(){e.OffcanvasUtils.toggle(d)},h.onSearchTextChange=function(e,r){"rawValue"===r.option&&h.searchText(r.value)}}var d;return d={selector:"#searchCanvas",edge:"top",displayMode:"push",size:"63px",modality:"modeless",autoDismiss:"none"},r.bindingHandlers.searchCanvas={init:function(t,o,a){r.utils.domNodeDisposal.addDisposeCallback(t,function(){t&&e.OffcanvasUtils.close(d)})}},u});