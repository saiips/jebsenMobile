define(["ojs/ojcore","knockout","jquery","appController","util/appui","pages/schedule/scheduleService","pages/common/constant","util/commonhelper","pages/common/maintenance","ojs/ojrouter","ojs/ojknockout","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojselectcombobox","ojs/ojdatetimepicker","ojs/ojlistview","ojs/ojmodel","ojs/ojpagingcontrol","ojs/ojpagingcontrol-model","ojs/ojdialog","ojs/ojnavigationlist","ojs/ojtable","ojs/ojdatacollection-utils","ojs/ojarraytabledatasource","ojs/ojdatasource-common","promise","ojs/ojrowexpander","ojs/ojflattenedtreedatagriddatasource","ojs/ojjsontreedatasource","ojs/ojvalidation","ojs/ojoffcanvas","ojs/ojpopup"],function(e,r,o,a,t,l,n,s,i){function u(){function u(){console.log("routeEarlierCutoffMaint init(): started"),t.showBusy(),I(),c(),T.allLoaded.removeAll(),T.deleted.removeAll();var e=d();console.log("LOV Service Payload ="+e),l.getLOVMessage(e).then(function(e){try{var o=e.P_SERVICE_PROVIDER.P_SERVICE_PROVIDER_ITEM;o&&(Array.isArray(o)||(o=new Array(o)),T.availableServiceProvider().length<=0&&(T.availableServiceProvider.push(r.toJS({value:"-1",label:""})),r.utils.arrayForEach(o,function(e){T.availableServiceProvider.push(r.toJS({value:e.LOOKUP_VALUE,label:e.LOOKUP_VALUE}))})))}catch(e){}}).done(function(){t.hideBusy(),T.ready(!0)})}function d(){var e=a.moduleConfig.params.rootContext.userProfile,r=JSON.stringify({InputGetLOV:{HeaderInfo:{UserID:e.username,UserRole:e.salesRole,CallerID:""},P_ORG_ID:e.orgUnitId}});return r}function c(){T.serviceProvider("-1")}function E(e){t.showBusy();var o=O(e);console.log("update payload="+o);var a=function(e,o){try{if(console.log("raw data return ="+r.toJSON(e)),null!==e&&200==o.status){var a=e.OutputUpdateRouteEarlyCutoff,l=a.P_RETURN_STATUS;"S"!=l?t.showMessageBox(T.lng_error_00032):(r.utils.arrayMap(T.allLoaded(),function(e){e.ORIGINAL_SERVICE_PROVIDER=r.utils.unwrapObservable(e.SERVICE_PROVIDER),e.ORIGINAL_ROUTE=r.utils.unwrapObservable(e.ROUTE),e.ORIGINAL_EARLY_CUTOFF_DATETIME=r.utils.unwrapObservable(e.EARLY_CUTOFF_DATETIME),e.ACTION=null}),T.allLoaded.valueHasMutated(),T.deleted.removeAll(),t.showMessageBox(T.lng_recordSaved))}else t.showMessageBox(T.lng_error_00032)}catch(e){console.error(e)}finally{t.hideBusy(),console.log("cbSuccessFn called")}},n=function(e,r){console.log("cbFailFn failed"),t.showMessageBox(T.lng_error_00032),t.hideBusy()};l.updateRouteEarlierCutoffMessage(o).then(a,n)}function _(e){var o=!1,a=r.utils.unwrapObservable(e.SERVICE_PROVIDER);Array.isArray(a)&&(a=a[0]),a="-1"==a||"undefined"==typeof a?null:a;var l=r.utils.unwrapObservable(e.EARLY_CUTOFF_DATETIME);return a&&"undefined"!=typeof a&&"-1"!=a&&"null"!=a||(o=!0,t.showMessageBox(T.lng_error_00046)),l&&"undefined"!=typeof l&&"null"!=l||(o=!0,t.showMessageBox(T.lng_error_00054)),o}function R(e,o){if(e=Array.isArray(e)?e[0]:e,null!==e&&200==o){if(!e[A])return;var a=e[A].P_TABLE_ITEM;if(null!=a){Array.isArray(a)||(a=new Array(a));var t=[],l=0;r.utils.arrayMap(a,function(e){l+=1,e.rowCount=l,s.formatStrDate(e.EARLY_CUTOFF_DATETIME);var o=s.formatStrDate(e.EARLY_CUTOFF_DATETIME,"YYYY-MM-DDTHH:mm:ss.sssZ","DD-MMM-YYYY").toUpperCase();o==n.BLANK_DATE?e.EARLY_CUTOFF_DATETIME="":e.EARLY_CUTOFF_DATETIME=s.formatStrDate(e.EARLY_CUTOFF_DATETIME,"YYYY-MM-DDTHH:mm:ss.sssZ","YYYY-MM-DDTHH:mm"),t.push({id:e.ROUTE_EARLY_CUTOFF_ROWID,rowCount:e.rowCount,ROUTE_EARLY_CUTOFF_ROWID:e.ROUTE_EARLY_CUTOFF_ROWID,SERVICE_PROVIDER:r.observable(e.SERVICE_PROVIDER),ROUTE:r.observable("-1"),EARLY_CUTOFF_DATETIME:r.observable(e.EARLY_CUTOFF_DATETIME),ORIGINAL_SERVICE_PROVIDER:e.SERVICE_PROVIDER,ORIGINAL_ROUTE:"-1",ORIGINAL_EARLY_CUTOFF_DATETIME:e.EARLY_CUTOFF_DATETIME,ACTION:null})}),T.allLoaded(t)}}}function v(){t.showBusy();var e=T.serviceProvider();if(Array.isArray(e)&&(e=e[0]),!e||"undefined"==typeof e||"-1"==e)return t.hideBusy(),void t.showMessageBox(T.lng_error_00046);var o=f(e);console.log("Search Route Earlier Cutoff Time Payload ="+r.toJS(o)),T.allLoaded.removeAll(),T.deleted.removeAll();var a=function(e,r){try{R(e,r.status)}catch(e){console.error(e)}finally{t.hideBusy(),console.log("cbSuccessFn called")}},n=function(e,r){console.log("cbFailFn failed"),R(e,r.status),t.hideBusy()};l.searchRouteEarlierCutoffMessage(o).then(a,n)}function f(e){var r=a.moduleConfig.params.rootContext.userProfile;e="-1"==e?null:e?e:null;var o=JSON.stringify({InputSearchRouteEarlyCutoff:{HeaderInfo:{UserID:r.username,UserRole:r.salesRole,CallerID:""},P_ORG_ID:r.orgUnitId,P_SERVICE_PROVIDER:e}});return o}function O(e){var r=a.moduleConfig.params.rootContext.userProfile,o=JSON.stringify({InputUpdateRouteEarlyCutoff:{HeaderInfo:{UserID:r.username,UserRole:r.salesRole,CallerID:""},P_ORG_ID:r.orgUnitId,P_ROUTE_EARLY_CUTOFF_UPDATE:{P_ROUTE_EARLY_CUTOFF_UPDATE_ITEM:e}}});return o}function I(){var r=e.Translations.getTranslatedString;T.lng_title=r("ssa.schedule.earlierCutOff.title"),T.lng_search=r("ssa.schedule.search"),T.lng_reset=r("ssa.schedule.reset"),T.lng_remove=r("ssa.schedule.remove"),T.lng_confirmSave=r("ssa.schedule.confirmSave"),T.lng_serviceProvider=r("ssa.schedule.serviceProvider"),T.lng_route=r("ssa.schedule.route"),T.lng_earlierCutoff=r("ssa.schedule.earlierCutOff.cutoffTime"),T.lng_recordSaved=r("ssa.msg.info.recordSaved"),T.lng_error_00032=r("ssa.msg.error.ERROR_00032"),T.lng_error_00046=r("ssa.msg.error.ERROR_00046"),T.lng_error_00047=r("ssa.msg.error.ERROR_00047"),T.lng_error_00054=r("ssa.msg.error.ERROR_00054")}var T=this;console.log("NonWorkingDateViewModel");var A="P_TABLE";T.router=a.router,T.serviceProvider=r.observable(),T.availableServiceProvider=r.observableArray(),T.availableRouteList=r.observableArray(),T.isFocused=r.observable(!1),T.allLoaded=r.observableArray(),T.deleted=r.observableArray(),T.scrollPos=r.observable(0),T.ready=r.observable(!1),T.dataFormat=r.observable("dd/MM/yyyy");var g=e.Validation.converterFactory("datetime");T.dateConverter=g.createConverter({pattern:T.dataFormat()}),T.handleActivated=function(r){var o=r.valueAccessor().params.ojRouter.parentRouter;console.log("routeEarlierCutoffMaint.js parentRouter="+o.currentState().value),T.scrollPos(0);var a=o.getChildRouter("routeEarlierCutoffMaint");return a||(a=o.createChildRouter("routeEarlierCutoffMaint")),T.router=a.configure(function(r){if(r){var o=new e.RouterState(r,{value:r,enter:function(){console.log("routeEarlierCutoffMaint.js stateId="+r)}});return o}}),u(),e.Router.sync()},T.handleBindingsApplied=function(e){},T.goBack=function(){a.router.go("springboard")},T.dispose=function(e){T.router.dispose()},T.search=function(){console.log("search");var e=i.isMaintenance();return e?void t.showMessageBox(T.lng_maintenance):void v()},T.reset=function(){console.log("reset"),c()},T.add=function(e,o){console.log("add");var a=0;try{a=T.allLoaded().length}catch(e){}var t={id:s.getClientDays(0,"YYYY-MM-DDTHH:mm:ssZ"),rowCount:a+1,ROUTE_EARLY_CUTOFF_ROWID:null,SERVICE_PROVIDER:r.observable(T.serviceProvider()?T.serviceProvider():"-1"),ROUTE:r.observable("-1"),EARLY_CUTOFF_DATETIME:r.observable(null),ORIGINAL_SERVICE_PROVIDER:T.serviceProvider()?T.serviceProvider():"-1",ORIGINAL_ROUTE:"-1",ORIGINAL_EARLY_CUTOFF_DATETIME:null,ACTION:"I"};T.allLoaded.splice(0,0,t)},T.removeLine=function(e){var o=r.utils.arrayFirst(T.allLoaded(),function(r){if(r.id==e.id)return r});T.allLoaded.remove(o),"I"!=e.ACTION&&(e.ACTION="D",console.log("delete line ="+r.toJSON(e)),T.deleted.push(e))},T.save=function(){if(console.log("save"),confirm(T.lng_confirmSave)){var e=[],o=!1;T.allLoaded().push.apply(T.allLoaded(),T.deleted()),r.utils.arrayMap(T.allLoaded(),function(a){var t=r.utils.unwrapObservable(a.SERVICE_PROVIDER);Array.isArray(t)&&(t=t[0]),t="-1"==t||"undefined"==typeof t?null:t;var l=r.utils.unwrapObservable(a.ORIGINAL_SERVICE_PROVIDER);l="-1"==l||"undefined"==typeof l?null:l;var n=r.utils.unwrapObservable(a.EARLY_CUTOFF_DATETIME),i=r.utils.unwrapObservable(a.ORIGINAL_EARLY_CUTOFF_DATETIME),u=r.utils.unwrapObservable(a.ACTION),d=s.formatStrDate(n,"YYYY-MM-DDTHH:mm","YYYY-MM-DDTHH:mm:ss.sssZ");if(t!=l||n!=i||"D"==u){if("D"!=u&&(o=_(a)))return;o||e.push({ROUTE_EARLY_CUTOFF_ROWID:r.utils.unwrapObservable(a.ROUTE_EARLY_CUTOFF_ROWID),SERVICE_PROVIDER:t,ROUTE:null,EARLY_CUTOFF_DATETIME:d,ACTION:"D"==u?u:a.ROUTE_EARLY_CUTOFF_ROWID?"U":"I"}),console.log("P_TABLE_ITEM="+r.toJSON(e)),e.length>0&&E(e)}})}},T.optionChange=function(e,r){"selection"===r.option&&r.value[0]&&console.log("routeEarlierCutoffMaint.js ui.value="+r.value)},T.getRowTemplate=function(e,r){return"editRowTemplate"},T.datasource=r.computed(function(){return new e.ArrayTableDataSource(T.allLoaded(),{idAttribute:"id"})}),o(document).ready(function(){console.log("document ready")})}return r.bindingHandlers.executeOnEnter={init:function(e,r,a,t){var l=r();o(e).keypress(function(e){var r=e.which?e.which:e.keyCode;return 13!==r||(l.call(t),!1)})}},r.bindingHandlers.datePicker={init:function(e,o,a,t){r.utils.registerEventHandler(e,"change",function(){var r=o();r(new Date(e.value))})},update:function(e,r,o,a){var t=r(),l=new moment(t()).format("YYYY-MM-DD");e.value=l}},new u});