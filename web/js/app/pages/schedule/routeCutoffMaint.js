define(["ojs/ojcore","knockout","jquery","appController","util/appui","pages/schedule/scheduleService","pages/common/constant","util/commonhelper","pages/common/maintenance","ojs/ojrouter","ojs/ojknockout","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojselectcombobox","ojs/ojdatetimepicker","ojs/ojlistview","ojs/ojmodel","ojs/ojpagingcontrol","ojs/ojpagingcontrol-model","ojs/ojdialog","ojs/ojnavigationlist","ojs/ojtable","ojs/ojdatacollection-utils","ojs/ojarraytabledatasource","ojs/ojdatasource-common","promise","ojs/ojrowexpander","ojs/ojflattenedtreedatagriddatasource","ojs/ojjsontreedatasource","ojs/ojvalidation","ojs/ojoffcanvas","ojs/ojpopup"],function(e,r,o,a,n,t,l,s,u){function i(){function i(){console.log("routeCutoffMaint init(): started"),n.showBusy(),T(),f(),c(),y.allLoaded.removeAll(),y.deleted.removeAll();var e=d();console.log("LOV Service Payload ="+e),t.getLOVMessage(e).then(function(e){try{var o=e.P_SERVICE_PROVIDER.P_SERVICE_PROVIDER_ITEM;o&&(Array.isArray(o)||(o=new Array(o)),y.availableServiceProvider().length<=0&&(y.availableServiceProvider.push(r.toJS({value:"-1",label:""})),r.utils.arrayForEach(o,function(e){y.availableServiceProvider.push(r.toJS({value:e.LOOKUP_VALUE,label:e.LOOKUP_VALUE}))})))}catch(e){}try{var a=e.P_ROUTE.P_SERVICE_PROVIDER_ITEM;a&&(Array.isArray(a)||(a=new Array(a)),y.availableRouteList().length<=0&&(y.availableRouteList.push(r.toJS({value:"-1",label:""})),r.utils.arrayForEach(a,function(e){y.availableRouteList.push(r.toJS({value:e.LOOKUP_VALUE,label:e.LOOKUP_VALUE}))})))}catch(e){}}).done(function(){n.hideBusy(),y.ready(!0)})}function d(){var e=a.moduleConfig.params.rootContext.userProfile,r=JSON.stringify({InputGetLOV:{HeaderInfo:{UserID:e.username,UserRole:e.salesRole,CallerID:""},P_ORG_ID:e.orgUnitId}});return r}function c(){var e=y.availableCutoffTime().length;e>0||r.utils.arrayForEach(l.CUTOFF_TIME_LIST,function(e){y.availableCutoffTime.push(r.toJS({value:e.value,label:e.label}))})}function f(){y.serviceProvider("-1")}function v(e){n.showBusy();var o=I(e);console.log("update payload="+o);var a=function(e,o){try{if(console.log("raw data return ="+r.toJSON(e)),null!==e&&200==o.status){var a=e.OutputUpdateRouteCutoff,t=a.P_RETURN_STATUS;"S"!=t?n.showMessageBox(y.lng_error_00032):(r.utils.arrayMap(y.allLoaded(),function(e){e.ORIGINAL_SERVICE_PROVIDER=r.utils.unwrapObservable(e.SERVICE_PROVIDER),e.ORIGINAL_ROUTE=r.utils.unwrapObservable(e.ROUTE),e.ORIGINAL_CUTOFF_TIME=r.utils.unwrapObservable(e.CUTOFF_TIME),e.ACTION=null}),y.allLoaded.valueHasMutated(),y.deleted.removeAll(),n.showMessageBox(y.lng_recordSaved))}else n.showMessageBox(y.lng_error_00032)}catch(e){console.error(e)}finally{n.hideBusy(),console.log("cbSuccessFn called")}},l=function(e,r){console.log("cbFailFn failed"),n.showMessageBox(y.lng_error_00032),n.hideBusy()};t.updateRouteCutoffMessage(o).then(a,l)}function R(e){var o=!1,a=r.utils.unwrapObservable(e.SERVICE_PROVIDER);Array.isArray(a)&&(a=a[0]),a="-1"==a||"undefined"==typeof a?null:a;var t=r.utils.unwrapObservable(e.ROUTE);Array.isArray(t)&&(t=t[0]),t="-1"==t||"undefined"==typeof t?null:t;var l=r.utils.unwrapObservable(e.CUTOFF_TIME);return Array.isArray(l)&&(l=l[0]),l="-1"==l||"undefined"==typeof l?null:l,a&&"undefined"!=typeof a&&"-1"!=a&&"null"!=a||(o=!0,n.showMessageBox(y.lng_error_00046)),t&&"undefined"!=typeof t&&"null"!=t&&"-1"!=t||(o=!0,n.showMessageBox(y.lng_error_00047)),l&&"undefined"!=typeof l&&"null"!=l&&"-1"!=l||(o=!0,n.showMessageBox(y.lng_error_00053)),o}function _(e,o){if(e=Array.isArray(e)?e[0]:e,null!==e&&200==o){if(!e[b])return;var a=e[b].P_TABLE_ITEM;if(null!=a){Array.isArray(a)||(a=new Array(a));var n=[],t=0;r.utils.arrayMap(a,function(e){t+=1,e.rowCount=t,n.push({id:e.ROUTE_CUTOFF_ROWID,rowCount:e.rowCount,ROUTE_CUTOFF_ROWID:e.ROUTE_CUTOFF_ROWID,SERVICE_PROVIDER:r.observable(e.SERVICE_PROVIDER),ROUTE:r.observable(e.ROUTE),CUTOFF_TIME:r.observable(e.CUTOFF_TIME),ORIGINAL_SERVICE_PROVIDER:e.SERVICE_PROVIDER,ORIGINAL_ROUTE:e.ROUTE,ORIGINAL_CUTOFF_TIME:e.CUTOFF_TIME,ACTION:null})}),y.allLoaded(n)}}}function O(){n.showBusy();var e=y.serviceProvider();if(Array.isArray(e)&&(e=e[0]),!e||"undefined"==typeof e||"-1"==e)return n.hideBusy(),void n.showMessageBox(y.lng_error_00046);var o=E(e);console.log("Search Route Cutoff Time Payload ="+r.toJS(o)),y.allLoaded.removeAll(),y.deleted.removeAll();var a=function(e,r){try{_(e,r.status)}catch(e){console.error(e)}finally{n.hideBusy(),console.log("cbSuccessFn called")}},l=function(e,r){console.log("cbFailFn failed"),_(e,r.status),n.hideBusy()};t.searchRouteCutoffMessage(o).then(a,l)}function E(e){var r=a.moduleConfig.params.rootContext.userProfile;e="-1"==e?null:e?e:null;var o=JSON.stringify({InputSearchRouteCutoff:{HeaderInfo:{UserID:r.username,UserRole:r.salesRole,CallerID:""},P_ORG_ID:r.orgUnitId,P_SERVICE_PROVIDER:e}});return o}function I(e){var r=a.moduleConfig.params.rootContext.userProfile,o=JSON.stringify({InputUpdateRouteCutoff:{HeaderInfo:{UserID:r.username,UserRole:r.salesRole,CallerID:""},P_ORG_ID:r.orgUnitId,P_ROUTE_CUTOFF_UPDATE:{P_ROUTE_CUTOFF_UPDATE_ITEM:e}}});return o}function g(e){var r=a.moduleConfig.params.rootContext.userProfile,o=JSON.stringify({InputGetRouteLOV:{HeaderInfo:{UserID:r.username,UserRole:r.salesRole,CallerID:""},P_ORG_ID:r.orgUnitId,P_SERVICE_PROVIDER:e}});return o}function T(){var r=e.Translations.getTranslatedString;y.lng_title=r("ssa.schedule.cutoff.title"),y.lng_search=r("ssa.schedule.search"),y.lng_reset=r("ssa.schedule.reset"),y.lng_remove=r("ssa.schedule.remove"),y.lng_confirmSave=r("ssa.schedule.confirmSave"),y.lng_serviceProvider=r("ssa.schedule.serviceProvider"),y.lng_route=r("ssa.schedule.route"),y.lng_cutoffTime=r("ssa.schedule.cutoff.cutoffTime"),y.lng_recordSaved=r("ssa.msg.info.recordSaved"),y.lng_error_00032=r("ssa.msg.error.ERROR_00032"),y.lng_error_00046=r("ssa.msg.error.ERROR_00046"),y.lng_error_00047=r("ssa.msg.error.ERROR_00047"),y.lng_error_00053=r("ssa.msg.error.ERROR_00053")}var y=this;console.log("RouteCutoffTimeViewModel");var b="P_TABLE";y.router=a.router,y.serviceProvider=r.observable(),y.availableServiceProvider=r.observableArray(),y.availableRouteList=r.observableArray(),y.availableCutoffTime=r.observableArray(),y.isFocused=r.observable(!1),y.allLoaded=r.observableArray(),y.deleted=r.observableArray(),y.scrollPos=r.observable(0),y.ready=r.observable(!1),y.dataFormat=r.observable("dd/MM/yyyy");var p=e.Validation.converterFactory("datetime");y.dateConverter=p.createConverter({pattern:y.dataFormat()}),y.handleActivated=function(r){var o=r.valueAccessor().params.ojRouter.parentRouter;console.log("routeCutoffMaint.js parentRouter="+o.currentState().value),y.scrollPos(0);var a=o.getChildRouter("routeCutoffMaint");return a||(a=o.createChildRouter("routeCutoffMaint")),y.router=a.configure(function(r){if(r){var o=new e.RouterState(r,{value:r,enter:function(){console.log("routeCutoffMaint.js stateId="+r)}});return o}}),i(),e.Router.sync()},y.handleBindingsApplied=function(e){},y.goBack=function(){a.router.go("springboard")},y.dispose=function(e){y.router.dispose()},y.search=function(){console.log("search");var e=u.isMaintenance();return e?void n.showMessageBox(y.lng_maintenance):void O()},y.reset=function(){console.log("reset"),f()},y.add=function(){console.log("add");var e=0;try{e=y.allLoaded().length}catch(e){}var o={id:s.getClientDays(0,"YYYY-MM-DDTHH:mm:ssZ"),rowCount:e+1,ROUTE_CUTOFF_ROWID:null,SERVICE_PROVIDER:r.observable(y.serviceProvider()?y.serviceProvider():"-1"),ROUTE:r.observable("-1"),CUTOFF_TIME:r.observable("-1"),ORIGINAL_SERVICE_PROVIDER:y.serviceProvider()?y.serviceProvider():"-1",ORIGINAL_ROUTE:"-1",ORIGINAL_CUTOFF_TIME:"-1",ACTION:"I"};y.allLoaded.splice(0,0,o)},y.removeLine=function(e){var o=r.utils.arrayFirst(y.allLoaded(),function(r){if(r.id==e.id)return r});y.allLoaded.remove(o),"I"!=e.ACTION&&(e.ACTION="D",console.log("delete line ="+r.toJSON(e)),y.deleted.push(e))},y.save=function(){if(console.log("save"),confirm(y.lng_confirmSave)){var o=[],a=!1;y.allLoaded().push.apply(y.allLoaded(),y.deleted()),r.utils.arrayMap(y.allLoaded(),function(l){var s=r.utils.unwrapObservable(l.SERVICE_PROVIDER);Array.isArray(s)&&(s=s[0]),s="-1"==s||"undefined"==typeof s?null:s;var u=r.utils.unwrapObservable(l.ORIGINAL_SERVICE_PROVIDER);u="-1"==u||"undefined"==typeof u?null:u;var i=r.utils.unwrapObservable(l.ROUTE);Array.isArray(i)&&(i=i[0]),i="-1"==i||"undefined"==typeof i?null:i;var d=r.utils.unwrapObservable(l.ORIGINAL_ROUTE);d="-1"==d||"undefined"==typeof d?null:d;var c=r.utils.unwrapObservable(l.CUTOFF_TIME);Array.isArray(c)&&(c=c[0]),c="-1"==c||"undefined"==typeof c?null:c;var f=r.utils.unwrapObservable(l.ORIGINAL_CUTOFF_TIME);Array.isArray(f)&&(f=f[0]),f="-1"==f||"undefined"==typeof f?null:f;var _=r.utils.unwrapObservable(l.ACTION);if(s!=u||i!=d||c!=f||"D"==_){if("D"!=_&&(a=R(l)))return;t.getRouteLOVMessage(g(s)).then(function(o){var t=o.P_ROUTE_BY_SERVICE_PROVIDER.P_ROUTE_BY_SERVICE_PROVIDER_ITEM;if(t&&"D"!=_){var l=r.utils.arrayFirst(t,function(e){if(e.LOOKUP_VALUE==i)return e});if(!l){a=!0;var u={SERVICE_PROVIDER:s,ROUTE:i};lng_error_00055=e.Translations.getTranslatedString("ssa.msg.error.ERROR_00055",u),n.showMessageBox(lng_error_00055)}}}).done(function(){console.log("foundError = "+a),a||o.push({ROUTE_CUTOFF_ROWID:r.utils.unwrapObservable(l.ROUTE_CUTOFF_ROWID),SERVICE_PROVIDER:s,ROUTE:i,CUTOFF_TIME:c,ACTION:"D"==_?_:l.ROUTE_CUTOFF_ROWID?"U":"I"})}).done(function(){console.log("P_TABLE_ITEM="+r.toJSON(o)),o.length>0&&v(o)})}})}},y.optionChange=function(e,r){"selection"===r.option&&r.value[0]&&console.log("routeCutoffMaint.js ui.value="+r.value)},y.getRowTemplate=function(e,r){return"editRowTemplate"},y.datasource=r.computed(function(){return new e.ArrayTableDataSource(y.allLoaded(),{idAttribute:"id"})}),o(document).ready(function(){console.log("document ready")})}return r.bindingHandlers.executeOnEnter={init:function(e,r,a,n){var t=r();o(e).keypress(function(e){var r=e.which?e.which:e.keyCode;return 13!==r||(t.call(n),!1)})}},r.bindingHandlers.datePicker={init:function(e,o,a,n){r.utils.registerEventHandler(e,"change",function(){var r=o();r(new Date(e.value))})},update:function(e,r,o,a){var n=r(),t=new moment(n()).format("YYYY-MM-DD");e.value=t}},new i});