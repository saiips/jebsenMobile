define(["ojs/ojcore","knockout","jquery","appController","util/appui","pages/schedule/scheduleService","pages/common/constant","util/commonhelper","pages/common/maintenance","ojs/ojrouter","ojs/ojknockout","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojselectcombobox","ojs/ojdatetimepicker","ojs/ojlistview","ojs/ojmodel","ojs/ojpagingcontrol","ojs/ojpagingcontrol-model","ojs/ojdialog","ojs/ojnavigationlist","ojs/ojtable","ojs/ojdatacollection-utils","ojs/ojarraytabledatasource","ojs/ojdatasource-common","promise"],function(e,r,a,l,o,s,n,t,i){function u(){function u(){console.log("logisticsSchMaint init(): started"),o.showBusy(),f(),O(),c(),y.allLoaded.removeAll(),y.deleted.removeAll();var e=_();console.log("LOV Service Payload ="+e),s.getLOVMessage(e).then(function(e){try{var a=e.P_SERVICE_PROVIDER.P_SERVICE_PROVIDER_ITEM;a&&(Array.isArray(a)||(a=new Array(a)),y.availableServiceProvider().length<=0&&(y.availableServiceProvider.push(r.toJS({value:"-1",label:""})),r.utils.arrayForEach(a,function(e){y.availableServiceProvider.push(r.toJS({value:e.LOOKUP_VALUE,label:e.LOOKUP_VALUE}))})))}catch(e){}try{var l=e.P_SHIPPING_METHOD.P_SERVICE_PROVIDER_ITEM;l&&(Array.isArray(l)||(l=new Array(l)),y.availableShipMethod().length<=0&&(y.availableShipMethod.push(r.toJS({value:"-1",label:""})),r.utils.arrayForEach(l,function(e){y.availableShipMethod.push(r.toJS({value:e.LOOKUP_VALUE,label:e.LOOKUP_VALUE}))})))}catch(e){}try{var o=e.P_DISTRICT.P_SERVICE_PROVIDER_ITEM;o&&(Array.isArray(o)||(o=new Array(o)),y.availableDistrict().length<=0&&(y.availableDistrict.push(r.toJS({value:null,label:""})),r.utils.arrayForEach(o,function(e){y.availableDistrict.push(r.toJS({value:e.LOOKUP_VALUE,label:e.LOOKUP_VALUE}))})))}catch(e){}try{var s=e.P_SUBINV_CODE.P_SERVICE_PROVIDER_ITEM;s&&(Array.isArray(s)||(s=new Array(s)),y.availabvleSubInvCode().length<=0&&(y.availabvleSubInvCode.push(r.toJS({value:null,label:""})),r.utils.arrayForEach(s,function(e){y.availabvleSubInvCode.push(r.toJS({value:e.LOOKUP_VALUE,label:e.LOOKUP_VALUE}))})))}catch(e){}try{var n=e.P_ROUTE.P_SERVICE_PROVIDER_ITEM;n&&(Array.isArray(n)||(n=new Array(n)),y.availableRouteList().length<=0&&(y.availableRouteList.push(r.toJS({value:"-1",label:""})),r.utils.arrayForEach(n,function(e){y.availableRouteList.push(r.toJS({value:e.LOOKUP_VALUE,label:e.LOOKUP_VALUE}))})),y.availableRouteFullList().length<=0&&(y.availableRouteFullList.push(r.toJS({value:"-1",label:""})),r.utils.arrayForEach(n,function(e){y.availableRouteFullList.push(r.toJS({value:e.LOOKUP_VALUE,label:e.LOOKUP_VALUE}))})))}catch(e){}}).done(function(){o.hideBusy(),y.ready(!0)})}function _(){var e=l.moduleConfig.params.rootContext.userProfile,r=JSON.stringify({InputGetLOV:{HeaderInfo:{UserID:e.username,UserRole:e.salesRole,CallerID:""},P_ORG_ID:e.orgUnitId}});return r}function v(e){var r=l.moduleConfig.params.rootContext.userProfile,a=JSON.stringify({InputGetRouteLOV:{HeaderInfo:{UserID:r.username,UserRole:r.salesRole,CallerID:""},P_ORG_ID:r.orgUnitId,P_SERVICE_PROVIDER:e}});return a}function d(e,r){var a=l.moduleConfig.params.rootContext.userProfile,o=JSON.stringify({InputGetShipMethodLOV:{HeaderInfo:{UserID:a.username,UserRole:a.salesRole,CallerID:""},P_ORG_ID:a.orgUnitId,P_SERVICE_PROVIDER:e,P_ROUTE:r}});return o}function c(){var e=y.availableDOWList().length;e>0||r.utils.arrayForEach(n.DOW_LIST,function(e){y.availableDOWList.push(r.toJS({value:e.value,label:e.label}))})}function O(){y.serviceProvider("-1"),y.route("-1"),y.district(null)}function I(e){o.showBusy();var a=g(e);console.log("update payload="+a);var l=function(e,a){try{if(null!==e&&200==a.status){var l=e.OutputUpdateLogisticSchedule,s=l.P_RETURN_STATUS;"S"!=s?o.showMessageBox(y.lng_error_00032):(r.utils.arrayMap(y.allLoaded(),function(e){e.ORIGINAL_SERVICE_PROVIDER=r.utils.unwrapObservable(e.SERVICE_PROVIDER),e.ORIGINAL_ROUTE=r.utils.unwrapObservable(e.ROUTE),e.ORIGINAL_SCHEDULE_DOW=r.utils.unwrapObservable(e.SCHEDULE_DOW),e.ORIGINAL_STOP_NUM=r.utils.unwrapObservable(e.STOP_NUM),e.ORIGINAL_SHIP_METHOD=r.utils.unwrapObservable(e.SHIP_METHOD),e.ORIGINAL_DISTRICT=r.utils.unwrapObservable(e.DISTRICT),e.ORIGINAL_SUBINV_CODE=r.utils.unwrapObservable(e.SUBINV_CODE),e.ACTION=null}),y.allLoaded.valueHasMutated(),y.deleted.removeAll(),o.showMessageBox(y.lng_recordSaved))}else o.showMessageBox(y.lng_error_00032)}catch(e){console.error(e)}finally{o.hideBusy(),console.log("cbSuccessFn called")}},n=function(e,r){console.log("cbFailFn failed"),o.showMessageBox(y.lng_error_00032),o.hideBusy()};s.updateLogisticScheduleMessage(a).then(l,n)}function R(e){var a=!1,l=r.utils.unwrapObservable(e.SERVICE_PROVIDER);Array.isArray(l)&&(l=l[0]),l="-1"==l||"undefined"==typeof l?null:l;var s=r.utils.unwrapObservable(e.ROUTE);Array.isArray(s)&&(s=s[0]),s="-1"==s||"undefined"==typeof s?null:s;var n=r.utils.unwrapObservable(e.SCHEDULE_DOW);Array.isArray(n)&&(n=n[0]),n="-1"==n||"undefined"==typeof n?null:n;var t=r.utils.unwrapObservable(e.STOP_NUM),i=r.utils.unwrapObservable(e.DISTRICT);Array.isArray(i)&&(i=i[0]),i="-1"==i||"undefined"==typeof i?null:i;var u=r.utils.unwrapObservable(e.SUBINV_CODE);Array.isArray(u)&&(u=u[0]),u="-1"==u||"undefined"==typeof u?null:u;var _=r.utils.unwrapObservable(e.SHIP_METHOD);return Array.isArray(_)&&(_=_[0]),_="-1"==_||"undefined"==typeof _?null:_,l&&"undefined"!=typeof l&&"-1"!=l&&"null"!=l||(a=!0,o.showMessageBox(y.lng_error_00046)),s&&"undefined"!=typeof s&&"null"!=s&&"-1"!=s||(a=!0,o.showMessageBox(y.lng_error_00047)),n&&"undefined"!=typeof n&&"null"!=n||(a=!0,o.showMessageBox(y.lng_error_00048)),t&&"undefined"!=typeof t&&"null"!=t||(a=!0,o.showMessageBox(y.lng_error_00049)),i&&"undefined"!=typeof i&&"null"!=i||(a=!0,o.showMessageBox(y.lng_error_00050)),u&&"undefined"!=typeof u&&"null"!=u||(a=!0,o.showMessageBox(y.lng_error_00051)),a}function E(e,a){if(e=Array.isArray(e)?e[0]:e,null!==e&&200==a){if(!e[h])return;var l=e[h].P_TABLE_ITEM;if(null!=l){Array.isArray(l)||(l=new Array(l));var o=[],s=0;r.utils.arrayMap(l,function(e){s+=1,e.rowCount=s,o.push({id:e.LOGISTIC_SCH_ROWID,rowCount:e.rowCount,LOGISTIC_SCH_ROWID:e.LOGISTIC_SCH_ROWID,SERVICE_PROVIDER:r.observable(e.SERVICE_PROVIDER),ROUTE:r.observable(e.ROUTE),SCHEDULE_DOW:r.observable(e.SCHEDULE_DOW),STOP_NUM:r.observable(e.STOP_NUM),SHIP_METHOD:r.observable(e.SHIP_METHOD),DISTRICT:r.observable(e.DISTRICT),SUBINV_CODE:r.observable(e.SUBINV_CODE),ORIGINAL_SERVICE_PROVIDER:e.SERVICE_PROVIDER,ORIGINAL_ROUTE:e.ROUTE,ORIGINAL_SCHEDULE_DOW:e.SCHEDULE_DOW,ORIGINAL_STOP_NUM:e.STOP_NUM,ORIGINAL_SHIP_METHOD:e.SHIP_METHOD,ORIGINAL_DISTRICT:e.DISTRICT,ORIGINAL_SUBINV_CODE:e.SUBINV_CODE,ACTION:null})}),y.allLoaded(o)}}}function b(){o.showBusy();var e=y.serviceProvider(),a=y.route(),l=y.district();if(Array.isArray(e)&&(e=e[0]),!e||"undefined"==typeof e||"-1"==e||"null"==e)return o.hideBusy(),void o.showMessageBox(y.lng_error_00046);if(Array.isArray(a)&&(a=a[0]),!(a&&"undefined"!=typeof a&&"-1"!=a&&"null"!=a||l))return o.hideBusy(),void o.showMessageBox(y.lng_error_00057);a=a?a.toString().toUpperCase():null,l=l?l.toString().toUpperCase():null;var n=S(e,a,l);console.log("Search Logistic Schedule Payload ="+r.toJS(n)),y.allLoaded.removeAll(),y.deleted.removeAll();var t=function(e,r){try{E(e,r.status)}catch(e){console.error(e)}finally{o.hideBusy(),console.log("cbSuccessFn called")}},i=function(e,r){console.log("cbFailFn failed"),E(e,r.status),o.hideBusy()};s.searchLogisticScheduleMessage(n).then(t,i)}function S(e,r,a){var o=l.moduleConfig.params.rootContext.userProfile;e="-1"==e?null:e?e:null,r="-1"==r?null:r?r:null,a=a?a:null;var s=JSON.stringify({InputSearchLogisticSchedule:{HeaderInfo:{UserID:o.username,UserRole:o.salesRole,CallerID:""},P_ORG_ID:o.orgUnitId,P_SERVICE_PROVIDER:e,P_ROUTE:r,P_DISTRICT:a}});return s}function g(e){var r=l.moduleConfig.params.rootContext.userProfile,a=JSON.stringify({InputUpdateLogisticSchedule:{HeaderInfo:{UserID:r.username,UserRole:r.salesRole,CallerID:""},P_ORG_ID:r.orgUnitId,P_SCHEDULE_MAIN_UPDATE:{P_SCHEDULE_MAIN_UPDATE_ITEM:e}}});return a}function f(){var r=e.Translations.getTranslatedString;y.lng_title=r("ssa.schedule.logistic.title"),y.lng_search=r("ssa.schedule.search"),y.lng_reset=r("ssa.schedule.reset"),y.lng_remove=r("ssa.schedule.remove"),y.lng_confirmSave=r("ssa.schedule.confirmSave"),y.lng_serviceProvider=r("ssa.schedule.serviceProvider"),y.lng_route=r("ssa.schedule.route"),y.lng_district=r("ssa.schedule.district"),y.lng_dow=r("ssa.schedule.logistic.dow"),y.lng_stopNo=r("ssa.schedule.logistic.stopNo"),y.lng_shipMethod=r("ssa.schedule.logistic.shipMethod"),y.lng_subinvCode=r("ssa.schedule.logistic.subinvCode"),y.lng_recordSaved=r("ssa.msg.info.recordSaved"),y.lng_error_00032=r("ssa.msg.error.ERROR_00032"),y.lng_error_00046=r("ssa.msg.error.ERROR_00046"),y.lng_error_00047=r("ssa.msg.error.ERROR_00047"),y.lng_error_00048=r("ssa.msg.error.ERROR_00048"),y.lng_error_00049=r("ssa.msg.error.ERROR_00049"),y.lng_error_00050=r("ssa.msg.error.ERROR_00050"),y.lng_error_00051=r("ssa.msg.error.ERROR_00051"),y.lng_error_00057=r("ssa.msg.error.ERROR_00057")}var y=this;console.log("LogisticsScheduleViewModel");var h="P_TABLE";y.router=l.router,y.serviceProvider=r.observable(),y.availableServiceProvider=r.observableArray(),y.availableRouteList=r.observableArray(),y.availableRouteFullList=r.observableArray(),y.availableDistrict=r.observableArray(),y.availabvleSubInvCode=r.observableArray(),y.availableDOWList=r.observableArray(),y.availableShipMethod=r.observableArray(),y.route=r.observable(),y.district=r.observable(),y.isFocused=r.observable(!1),y.allLoaded=r.observableArray(),y.deleted=r.observableArray(),y.scrollPos=r.observable(0),y.ready=r.observable(!1),y.dataFormat=r.observable("dd/MM/yyyy");var p=e.Validation.converterFactory("datetime");y.dateConverter=p.createConverter({pattern:y.dataFormat()}),y.handleActivated=function(r){var a=r.valueAccessor().params.ojRouter.parentRouter;console.log("logisticsSchMaint.js parentRouter="+a.currentState().value),y.scrollPos(0);var l=a.getChildRouter("logisticsSchMaint");return l||(l=a.createChildRouter("logisticsSchMaint")),y.router=l.configure(function(r){if(r){var a=new e.RouterState(r,{value:r,enter:function(){console.log("logisticsSchMaint.js stateId="+r)}});return a}}),u(),e.Router.sync()},y.handleBindingsApplied=function(e){},y.goBack=function(){l.router.go("springboard")},y.dispose=function(e){y.router.dispose()},y.search=function(){console.log("search");var e=i.isMaintenance();return e?void o.showMessageBox(y.lng_maintenance):void b()},y.reset=function(){console.log("reset"),O()},y.add=function(){console.log("add");var e=0;try{e=y.allLoaded().length}catch(e){}var a={id:t.getClientDays(0,"YYYY-MM-DDTHH:mm:ssZ"),rowCount:e+1,LOGISTIC_SCH_ROWID:null,SERVICE_PROVIDER:r.observable(y.serviceProvider()?y.serviceProvider():"-1"),ROUTE:r.observable("-1"),SCHEDULE_DOW:r.observable("-1"),STOP_NUM:r.observable("1"),SHIP_METHOD:r.observable("-1"),DISTRICT:r.observable(null),SUBINV_CODE:r.observable(null),ORIGINAL_SERVICE_PROVIDER:y.serviceProvider()?y.serviceProvider():"-1",ORIGINAL_ROUTE:"-1",ORIGINAL_SCHEDULE_DOW:"-1",ORIGINAL_STOP_NUM:null,ORIGINAL_SHIP_METHOD:"-1",ORIGINAL_DISTRICT:null,ORIGINAL_SUBINV_CODE:null,ACTION:"I"};y.allLoaded.splice(0,0,a)},y.removeLine=function(e){var a=r.utils.arrayFirst(y.allLoaded(),function(r){if(r.id==e.id)return r});y.allLoaded.remove(a),"I"!=e.ACTION&&(e.ACTION="D",console.log("delete line ="+r.toJSON(e)),y.deleted.push(e))},y.optionChangeServiceProvider=function(e,a){console.log("optionChangeServiceProvider");var l=y.serviceProvider();Array.isArray(l)&&(l=l[0]),l="-1"==l||"undefined"==typeof l?null:l,l?(y.availableRouteList.removeAll(),y.availableRouteList.push(r.toJS({value:"-1",label:""})),s.getRouteLOVMessage(v(l)).then(function(e){var a=e.P_ROUTE_BY_SERVICE_PROVIDER.P_ROUTE_BY_SERVICE_PROVIDER_ITEM;r.utils.arrayForEach(a,function(e){y.availableRouteList.push(r.toJS({value:e.LOOKUP_VALUE,label:e.LOOKUP_VALUE}))})}).fail(function(){console.log("failed"),y.availableRouteList.removeAll(),r.utils.arrayForEach(y.availableRouteFullList(),function(e){y.availableRouteList.push(r.toJS({value:e.value,label:e.label}))})})):(console.log("availableRouteFullList="+r.toJSON(y.availableRouteFullList)),y.availableRouteList.removeAll(),r.utils.arrayForEach(y.availableRouteFullList(),function(e){y.availableRouteList.push(r.toJS({value:e.value,label:e.label}))}))},y.save=function(){if(console.log("save"),confirm(y.lng_confirmSave)){var a=[],l=!1;y.allLoaded().push.apply(y.allLoaded(),y.deleted()),r.utils.arrayMap(y.allLoaded(),function(n){var t=r.utils.unwrapObservable(n.SERVICE_PROVIDER);Array.isArray(t)&&(t=t[0]),t="-1"==t||"undefined"==typeof t?null:t;var i=r.utils.unwrapObservable(n.ORIGINAL_SERVICE_PROVIDER);i="-1"==i||"undefined"==typeof i?null:i;var u=r.utils.unwrapObservable(n.ROUTE);Array.isArray(u)&&(u=u[0]),u="-1"==u||"undefined"==typeof u?null:u;var _=r.utils.unwrapObservable(n.ORIGINAL_ROUTE);_="-1"==_||"undefined"==typeof _?null:_;var c=r.utils.unwrapObservable(n.SCHEDULE_DOW);Array.isArray(c)&&(c=c[0]),c="-1"==c||"undefined"==typeof c?null:c;var O=r.utils.unwrapObservable(n.ORIGINAL_SCHEDULE_DOW);O="-1"==O||"undefined"==typeof O?null:O;var E=r.utils.unwrapObservable(n.STOP_NUM),b=r.utils.unwrapObservable(n.ORIGINAL_STOP_NUM),S=r.utils.unwrapObservable(n.SHIP_METHOD);Array.isArray(S)&&(S=S[0]),S="-1"==S||"undefined"==typeof S?null:S;var g=r.utils.unwrapObservable(n.ORIGINAL_SHIP_METHOD);g="-1"==g||"undefined"==typeof g?null:g;var f=r.utils.unwrapObservable(n.DISTRICT);Array.isArray(f)&&(f=f[0]),f="-1"==f||"undefined"==typeof f?null:f;var y=r.utils.unwrapObservable(n.ORIGINAL_DISTRICT);y="-1"==y||"undefined"==typeof y?null:y;var h=r.utils.unwrapObservable(n.SUBINV_CODE);Array.isArray(h)&&(h=h[0]),h="-1"==h||"undefined"==typeof h?null:h;var p=r.utils.unwrapObservable(n.ORIGINAL_SUBINV_CODE);p="-1"==p||"undefined"==typeof p?null:p;var D=r.utils.unwrapObservable(n.ACTION);if(t!=i||u!=_||c!=O||E!=b||S!=g||f!=y||h!=p||"D"==D){if("D"!=D&&(l=R(n)))return;s.getRouteLOVMessage(v(t)).then(function(a){if("D"!=D)if(a.P_ROUTE_BY_SERVICE_PROVIDER){var s=a.P_ROUTE_BY_SERVICE_PROVIDER.P_ROUTE_BY_SERVICE_PROVIDER_ITEM;if(s){var n=r.utils.arrayFirst(s,function(e){if(e.LOOKUP_VALUE==u)return e});if(!n){l=!0;var i={SERVICE_PROVIDER:t,ROUTE:u};console.log("params="+r.toJSON(i)),lng_error_00055=e.Translations.getTranslatedString("ssa.msg.error.ERROR_00055",i),o.hideBusy(),o.showMessageBox(lng_error_00055)}}}else{l=!0;var i={SERVICE_PROVIDER:t,ROUTE:u};console.log("params="+r.toJSON(i)),lng_error_00055=e.Translations.getTranslatedString("ssa.msg.error.ERROR_00055",i),o.hideBusy(),o.showMessageBox(lng_error_00055)}}).then(function(){!l&&S&&"D"!=D&&s.getShipmentLOVMessage(d(t,u)).then(function(a){if(a.P_SHIPPING_METHOD){var s=a.P_SHIPPING_METHOD.P_SHIPPING_METHOD_ITEM;if(s){var n=r.utils.arrayFirst(s,function(e){if(e.LOOKUP_VALUE==S)return e});if(!n){l=!0;var i={SERVICE_PROVIDER:t,ROUTE:u,SHIP_METHOD:S};lng_error_00056=e.Translations.getTranslatedString("ssa.msg.error.ERROR_00056",i),o.hideBusy(),o.showMessageBox(lng_error_00056)}}}else{l=!0;var i={SERVICE_PROVIDER:t,ROUTE:u,SHIP_METHOD:S};lng_error_00056=e.Translations.getTranslatedString("ssa.msg.error.ERROR_00056",i),o.hideBusy(),o.showMessageBox(lng_error_00056)}})}).done(function(){console.log("foundError = "+l),l||a.push({LOGISTIC_SCH_ROWID:r.utils.unwrapObservable(n.LOGISTIC_SCH_ROWID),SERVICE_PROVIDER:t,ROUTE:u,SCHEDULE_DOW:c,STOP_NUM:E,SHIP_METHOD:S,DISTRICT:f,SUBINV_CODE:h,ACTION:"D"==D?D:n.LOGISTIC_SCH_ROWID?"U":"I"})}).done(function(){console.log("P_TABLE_ITEM="+r.toJSON(a)),a.length>0&&I(a)})}})}},y.optionChange=function(e,r){"selection"===r.option&&r.value[0]&&console.log("logisticsSchMaint.js ui.value="+r.value)},y.getRowTemplate=function(e,r){return"editRowTemplate"},y.datasource=r.computed(function(){return new e.ArrayTableDataSource(y.allLoaded(),{idAttribute:"id"})}),a(document).ready(function(){console.log("document ready")})}return r.bindingHandlers.executeOnEnter={init:function(e,r,l,o){var s=r();a(e).keypress(function(e){var r=e.which?e.which:e.keyCode;return 13!==r||(s.call(o),!1)})}},r.bindingHandlers.datePicker={init:function(e,a,l,o){r.utils.registerEventHandler(e,"change",function(){var r=a();r(new Date(e.value))})},update:function(e,r,a,l){var o=r(),s=new moment(o()).format("YYYY-MM-DD");e.value=s}},new u});