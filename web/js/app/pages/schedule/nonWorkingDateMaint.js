define(["ojs/ojcore","knockout","jquery","appController","util/appui","pages/schedule/scheduleService","pages/common/constant","util/commonhelper","pages/common/maintenance","ojs/ojrouter","ojs/ojknockout","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojselectcombobox","ojs/ojdatetimepicker","ojs/ojlistview","ojs/ojmodel","ojs/ojpagingcontrol","ojs/ojpagingcontrol-model","ojs/ojdialog","ojs/ojnavigationlist","ojs/ojtable","ojs/ojdatacollection-utils","ojs/ojarraytabledatasource","ojs/ojdatasource-common","promise","ojs/ojrowexpander","ojs/ojflattenedtreedatagriddatasource","ojs/ojjsontreedatasource","ojs/ojvalidation","ojs/ojoffcanvas","ojs/ojpopup"],function(e,o,r,n,a,l,t,s,i){function u(){function t(){console.log("nonWorkingDateMaint init(): started"),a.showBusy(),g(),d(),N.allLoaded.removeAll(),N.deleted.removeAll();var e=u();console.log("LOV Service Payload ="+e),l.getLOVMessage(e).then(function(e){try{var r=e.P_SERVICE_PROVIDER.P_SERVICE_PROVIDER_ITEM;r&&(Array.isArray(r)||(r=new Array(r)),N.availableServiceProvider().length<=0&&(N.availableServiceProvider.push(o.toJS({value:"-1",label:""})),o.utils.arrayForEach(r,function(e){N.availableServiceProvider.push(o.toJS({value:e.LOOKUP_VALUE,label:e.LOOKUP_VALUE}))})))}catch(e){}}).done(function(){a.hideBusy(),N.ready(!0)})}function u(){var e=n.moduleConfig.params.rootContext.userProfile,o=JSON.stringify({InputGetLOV:{HeaderInfo:{UserID:e.username,UserRole:e.salesRole,CallerID:""},P_ORG_ID:e.orgUnitId}});return o}function d(){N.serviceProvider("-1")}function c(e){a.showBusy();var r=I(e);console.log("update payload="+r);var n=function(e,r){try{if(null!==e&&200==r.status){var n=e.OutputUpdateNonWorkingDT,l=n.P_RETURN_STATUS;"S"!=l?a.showMessageBox(N.lng_error_00032):(o.utils.arrayMap(N.allLoaded(),function(e){e.ORIGINAL_SERVICE_PROVIDER=o.utils.unwrapObservable(e.SERVICE_PROVIDER),e.ORIGINAL_ROUTE=o.utils.unwrapObservable(e.ROUTE),e.ORIGINAL_NON_WORKING_DATE=o.utils.unwrapObservable(e.NON_WORKING_DATE),e.ACTION=null}),N.allLoaded.valueHasMutated(),N.deleted.removeAll(),a.showMessageBox(N.lng_recordSaved))}else a.showMessageBox(N.lng_error_00032)}catch(e){console.error(e)}finally{a.hideBusy(),console.log("cbSuccessFn called")}},t=function(e,o){console.log("cbFailFn failed"),a.showMessageBox(N.lng_error_00032),a.hideBusy()};l.updateNonWorkingDateMessage(r).then(n,t)}function _(e){var r=!1,n=o.utils.unwrapObservable(e.SERVICE_PROVIDER);Array.isArray(n)&&(n=n[0]),n="-1"==n||"undefined"==typeof n?null:n;var l=o.utils.unwrapObservable(e.NON_WORKING_DATE);return n&&"undefined"!=typeof n&&"-1"!=n&&"null"!=n||(r=!0,a.showMessageBox(N.lng_error_00046)),l&&"undefined"!=typeof l&&"null"!=l||(r=!0,a.showMessageBox(N.lng_error_00052)),r}function v(e,r){if(e=Array.isArray(e)?e[0]:e,null!==e&&200==r){if(!e[f])return;var n=e[f].P_TABLE_ITEM;if(null!=n){Array.isArray(n)||(n=new Array(n));var a=[],l=0;o.utils.arrayMap(n,function(e){l+=1,e.rowCount=l,a.push({id:e.NON_WORKING_DT_ROWID,rowCount:e.rowCount,NON_WORKING_DT_ROWID:e.NON_WORKING_DT_ROWID,SERVICE_PROVIDER:o.observable(e.SERVICE_PROVIDER),ROUTE:o.observable("-1"),NON_WORKING_DATE:o.observable(e.NON_WORKING_DATE),ORIGINAL_SERVICE_PROVIDER:e.SERVICE_PROVIDER,ORIGINAL_ROUTE:"-1",ORIGINAL_NON_WORKING_DATE:e.NON_WORKING_DATE,ACTION:null})}),N.allLoaded(a)}}}function R(){a.showBusy();var e=N.serviceProvider();if(Array.isArray(e)&&(e=e[0]),!e||"undefined"==typeof e||"-1"==e)return a.hideBusy(),void a.showMessageBox(N.lng_error_00046);var r=O(e);console.log("Search Non-Working Date Payload ="+o.toJS(r)),N.allLoaded.removeAll(),N.deleted.removeAll();var n=function(e,o){try{v(e,o.status)}catch(e){console.error(e)}finally{a.hideBusy(),console.log("cbSuccessFn called")}},t=function(e,o){console.log("cbFailFn failed"),v(e,o.status),a.hideBusy()};l.searchNonWorkingDateMessage(r).then(n,t)}function O(e){var o=n.moduleConfig.params.rootContext.userProfile;e="-1"==e?null:e?e:null;var r=JSON.stringify({InputSearchNonWorkingDT:{HeaderInfo:{UserID:o.username,UserRole:o.salesRole,CallerID:""},P_ORG_ID:o.orgUnitId,P_SERVICE_PROVIDER:e}});return r}function I(e){var o=n.moduleConfig.params.rootContext.userProfile,r=JSON.stringify({InputUpdateNonWorkingDT:{HeaderInfo:{UserID:o.username,UserRole:o.salesRole,CallerID:""},P_ORG_ID:o.orgUnitId,P_NON_WORKING_DT_UPDATE:{P_NON_WORKING_DT_UPDATE_ITEM:e}}});return r}function g(){var o=e.Translations.getTranslatedString;N.lng_title=o("ssa.schedule.nonWorkingDate.title"),N.lng_search=o("ssa.schedule.search"),N.lng_reset=o("ssa.schedule.reset"),N.lng_remove=o("ssa.schedule.remove"),N.lng_confirmSave=o("ssa.schedule.confirmSave"),N.lng_serviceProvider=o("ssa.schedule.serviceProvider"),N.lng_route=o("ssa.schedule.route"),N.lng_nonWorkingDate=o("ssa.schedule.nonWorkingDate.nonWorkingDate"),N.lng_recordSaved=o("ssa.msg.info.recordSaved"),N.lng_error_00032=o("ssa.msg.error.ERROR_00032"),N.lng_error_00046=o("ssa.msg.error.ERROR_00046"),N.lng_error_00047=o("ssa.msg.error.ERROR_00047"),N.lng_error_00052=o("ssa.msg.error.ERROR_00052")}var N=this;console.log("NonWorkingDateViewModel");var f="P_TABLE";N.router=n.router,N.serviceProvider=o.observable(),N.availableServiceProvider=o.observableArray(),N.availableRouteList=o.observableArray(),N.isFocused=o.observable(!1),N.allLoaded=o.observableArray(),N.deleted=o.observableArray(),N.scrollPos=o.observable(0),N.ready=o.observable(!1),N.dataFormat=o.observable("dd/MM/yyyy");var E=e.Validation.converterFactory("datetime");N.dateConverter=E.createConverter({pattern:N.dataFormat()}),N.handleActivated=function(o){var r=o.valueAccessor().params.ojRouter.parentRouter;console.log("nonWorkingDateMaint.js parentRouter="+r.currentState().value),N.scrollPos(0);var n=r.getChildRouter("nonWorkingDateMaint");return n||(n=r.createChildRouter("nonWorkingDateMaint")),N.router=n.configure(function(o){if(o){var r=new e.RouterState(o,{value:o,enter:function(){console.log("nonWorkingDateMaint.js stateId="+o)}});return r}}),t(),e.Router.sync()},N.handleBindingsApplied=function(e){},N.goBack=function(){n.router.go("springboard")},N.dispose=function(e){N.router.dispose()},N.search=function(){console.log("search");var e=i.isMaintenance();return e?void a.showMessageBox(N.lng_maintenance):void R()},N.reset=function(){console.log("reset"),d()},N.add=function(){console.log("add");var e=0;try{e=N.allLoaded().length}catch(e){}var r={id:s.getClientDays(0,"YYYY-MM-DDTHH:mm:ssZ"),rowCount:e+1,NON_WORKING_DT_ROWID:null,SERVICE_PROVIDER:o.observable(N.serviceProvider()?N.serviceProvider():"-1"),ROUTE:o.observable("-1"),NON_WORKING_DATE:o.observable(null),ORIGINAL_SERVICE_PROVIDER:N.serviceProvider(),ORIGINAL_ROUTE:"-1",ORIGINAL_NON_WORKING_DATE:null,ACTION:"I"};N.allLoaded.splice(0,0,r)},N.removeLine=function(e){var r=o.utils.arrayFirst(N.allLoaded(),function(o){if(o.id==e.id)return o});N.allLoaded.remove(r),"I"!=e.ACTION&&(e.ACTION="D",console.log("delete line ="+o.toJSON(e)),N.deleted.push(e))},N.save=function(){if(console.log("save"),confirm(N.lng_confirmSave)){var e=[],r=!1;N.allLoaded().push.apply(N.allLoaded(),N.deleted()),o.utils.arrayMap(N.allLoaded(),function(n){var a=o.utils.unwrapObservable(n.SERVICE_PROVIDER);Array.isArray(a)&&(a=a[0]),a="-1"==a||"undefined"==typeof a?null:a;var l=o.utils.unwrapObservable(n.ORIGINAL_SERVICE_PROVIDER);l="-1"==l||"undefined"==typeof l?null:l;var t=o.utils.unwrapObservable(n.NON_WORKING_DATE),s=o.utils.unwrapObservable(n.ORIGINAL_NON_WORKING_DATE),i=o.utils.unwrapObservable(n.ACTION);if(a!=l||t!=s||"D"==i){if("D"!=i&&(r=_(n)))return;r||e.push({NON_WORKING_DT_ROWID:o.utils.unwrapObservable(n.NON_WORKING_DT_ROWID),SERVICE_PROVIDER:a,ROUTE:null,NON_WORKING_DATE:t,ACTION:"D"==i?i:n.NON_WORKING_DT_ROWID?"U":"I"}),console.log("P_TABLE_ITEM="+o.toJSON(e)),e.length>0&&c(e)}})}},N.optionChange=function(e,o){"selection"===o.option&&o.value[0]&&console.log("nonWorkingDateMaint.js ui.value="+o.value)},N.getRowTemplate=function(e,o){return"editRowTemplate"},N.datasource=o.computed(function(){return new e.ArrayTableDataSource(N.allLoaded(),{idAttribute:"id"})}),r(document).ready(function(){console.log("document ready")})}return o.bindingHandlers.executeOnEnter={init:function(e,o,n,a){var l=o();r(e).keypress(function(e){var o=e.which?e.which:e.keyCode;return 13!==o||(l.call(a),!1)})}},o.bindingHandlers.datePicker={init:function(e,r,n,a){o.utils.registerEventHandler(e,"change",function(){var o=r();o(new Date(e.value))})},update:function(e,o,r,n){var a=o(),l=new moment(a()).format("YYYY-MM-DD");e.value=l}},new u});