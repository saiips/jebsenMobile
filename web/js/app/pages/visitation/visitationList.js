define(["ojs/ojcore","knockout","jquery","appController","pages/visitation/visitationService","util/appui","pages/common/constant","util/commonhelper","ojs/ojknockout","ojs/ojlistview","ojs/ojjsontreedatasource","hammerjs","ojs/ojjquery-hammer","ojs/ojswipetoreveal","ojs/ojrouter","ojs/ojtoolbar","ojs/ojinputtext","ojs/ojbutton","ojs/ojinputnumber","ojs/ojdatacollection-common","ojs/ojmenu","ojs/ojmodel","ojs/ojpulltorefresh","ojs/ojvalidation","ojs/ojoffcanvas"],function(e,t,o,n,a,i,s,r){function l(){function l(){var e=n.moduleConfig.params.rootContext.userProfile,t=r.getClientDays(-7,"YYYY-MM-DDTHH:mm:ssZ"),o=r.getClientDays(7,"YYYY-MM-DDTHH:mm:ssZ"),a=JSON.stringify({InputGetVisitation:{HeaderInfo:{UserID:e.username,UserRole:e.salesRole,CallerID:""},P_ORG_ID:e.orgUnitId,P_SALESREP_ID:e.erpSalesId,START_DATE:t,END_DATE:o}});return a}function u(e){var t=n.moduleConfig.params.rootContext.userProfile,o=JSON.stringify({InputUpdateVisitation:{HeaderInfo:{UserID:t.username,UserRole:t.salesRole,CallerID:""},VISITATION_ID:e.VISITATION_ID,DESCRIPTION:e.DESCRIPTION,STATUS:e.STATUS}});return o}function d(){console.log("visitationList.js init() started"),i.showBusy();var e=function(e,t){try{h(e,t.status)}catch(e){console.error(e)}finally{console.log("cbSuccessFn called"),i.hideBusy(),T.ready(!0)}},o=function(e,t){console.log("cbFailFn failed"),h(e,t.status),i.hideBusy(),T.ready(!0)},n=l();console.log("payload = "+t.toJS(n)),a.getVisitationListMessage(n).then(e,o)}function f(){var e=function(e,t){try{h(e,t.status)}catch(e){console.error(e)}finally{console.log("cbSuccessFn called"),i.hideBusy(),T.ready(!0)}},o=function(e,t){console.log("cbFailFn failed"),h(e,t.status),i.hideBusy(),T.ready(!0)},n=l();console.log("payload = "+t.toJS(n)),a.refreshVisitationListMessage(n).then(e,o)}function h(e,o){console.log("raw data = "+t.toJSON(e));var a=n.moduleConfig.params.rootContext.userProfile.orgUnitId,r=n.moduleConfig.params.rootContext.userProfile.erpSalesId;if(e=Array.isArray(e)?e[0]:e,null!==e&&200==o&&e!={}){var l=[],c=[],u=e[m];if(u){var d=u.length;console.log("visitation list ="+d);for(var f=0;f<d;f++){var h=u[f].ACTIVITY_ID;u[f].id=h;var p=moment(u[f].START_DATE).format("YYYY/MM/DD").toUpperCase(),v=moment(u[f].START_DATE).format("YYYYMMDDHHmm").toUpperCase();"NOT_STARTED"==u[f].STATUS?u[f].STATUS_DESC="NOT STARTED":"FOLLOW_UP"==u[f].STATUS?u[f].STATUS_DESC="FOLLOW-UP":u[f].STATUS_DESC=u[f].STATUS,c.indexOf(p)>-1?l[c.indexOf(p)].children.push({attr:{id:h,data:u[f]}}):(c.push(p),l.push({attr:{id:h,startDate:p,startTime:v},children:[{attr:{id:h,data:u[f]}}]}))}l.sort(function(e,t){return t.attr.startDate<e.attr.startDate?1:t.attr.startDate>e.attr.startDate?-1:0}),console.log("formatted="+t.toJSON(l)),T.allVisitations(l)}var S=s.VISITATION_LIST_KEY+":"+a+":"+r+":"+s.VISITATIONS_SYNC_DATETIME,e=i.getLocalStorage(S);e&&(T.syncDatetime(e),T.showLastSyncDate(!0))}}function p(){var t=e.Translations.getTranslatedString;T.lng_searchPlaceHolder=t("ssa.header.customerSearch"),T.lng_lastSyncDate=t("ssa.header.lastSyncDate"),T.lng_visitation=t("ssa.visitationList.visitation"),T.lng_purpose=t("ssa.visitationList.purpose"),T.lng_start=t("ssa.visitationList.start"),T.lng_end=t("ssa.visitationList.end"),T.lng_primaryText=t("ssa.pullToRefreshUtils.primaryText"),T.lng_secondaryText=t("ssa.pullToRefreshUtils.secondaryText")}var T=this,m="outputGetVisitation";T.handleActivated=function(e){T.showBusy(!0),p(),T.scrollPos(0),n.moduleConfig.params.rootContext.isNewVisitation=!1;var t=n.moduleConfig.params.rootContext.isRefreshVisitation;t&&(T.ready(!1),f(),n.moduleConfig.params.rootContext.isRefreshVisitation=!1,T.ready(!0))},T.handleAttached=function(e){},T.handleBindingsApplied=function(e){var t=o("#globalBody").find(".oj-hybrid-applayout-content"),n="oj-hybrid-applayout-scrollable";t.hasClass(n)&&(o("#searchCanvas").on("ojbeforeopen",function(){t.removeClass(n)}),o("#searchCanvas").on("ojbeforeclose",function(){t.addClass(n)})),o("#searchCanvas").on("ojclose",function(){T.clearSearch()})},T.handleDetached=function(e){T.showBusy(!1),T.clearSearch(),T.searchText("")},T.ready=t.observable(!1),T.allVisitations=t.observableArray(),T.showBusy=t.observable(!0),T.scrollPos=t.observable(0),T.large=t.computed(function(){var t=e.ResponsiveUtils.getFrameworkQuery(e.ResponsiveUtils.FRAMEWORK_QUERY_KEY.LG_UP);return e.ResponsiveKnockoutUtils.createMediaQueryObservable(t)}),T.itemOnly=function(e){return e.leaf},T.selectTemplate=function(e,t){return t.$itemContext.leaf?"item_template":"group_template"},T.searchText=t.observable(""),T.searchText.extend({rateLimit:{timeout:1200,method:"notifyWhenChangesStop"}}),T.searchValueComplete=t.observable(""),T.syncDatetime=t.observable(),T.showLastSyncDate=t.observable(!1),T.visitations=t.computed(function(){if(T.searchText()&&T.allVisitations().length>0){var t=T.searchText().toLowerCase(),o=[];return T.allVisitations().forEach(function(e){e.children.forEach(function(e){(e.attr.data.SUBJECT.toLowerCase().indexOf(t)>=0||e.attr.data.PURPOSE.toLowerCase().indexOf(t)>=0||e.attr.data.OUTLET_NAME.toLowerCase().indexOf(t)>=0||e.attr.data.LOCATION.toLowerCase().indexOf(t)>=0||e.attr.data.DESCRIPTION.toLowerCase().indexOf(t)>=0||e.attr.data.STATUS.toLowerCase().indexOf(t)>=0)&&o.push(e)})}),new e.JsonTreeDataSource(o)}return new e.JsonTreeDataSource(T.allVisitations())}),T.onClearSearchText=function(){T.clearSearch()},T.clearSearch=function(){var e=o("#searchProduct");e.ojInputText("option","value",""),e.ojInputText("reset"),T.searchText("")},T.toggleSearchCanvas=function(){e.OffcanvasUtils.toggle(c)},T.onSearchTextChange=function(e,t){"rawValue"===t.option&&(t.value.length>=2||0==t.value.length)&&(T.searchText(t.value),T.scrollPos(0))},T.optionChange=function(e,o){"selection"===o.option&&o.value[0]&&console.log("ui.value[0] ="+t.toJSON(o.value[0]))},T.clickOptionChange=function(e,o,a){console.log("clickOptionChange trigger"),console.log("data = "+t.toJSON(e)),n.moduleConfig.params.rootContext.selVisitation=e.data,n.redirect("visitationDetail",e.id)},T.addVisitation=function(e,t){console.log("add visitation"),n.moduleConfig.params.rootContext.fromPage="visitationList",n.moduleConfig.params.rootContext.isNewVisitation=!0,n.go("customer")},d(),T.handleReady=function(){o("#listview").find(".item-marker").each(function(t){var n=o(this),a=(n.prop("id"),n.find(".oj-offcanvas-start").first()),i=n.find(".oj-offcanvas-end").first();e.SwipeToRevealUtils.setupSwipeActions(a),e.SwipeToRevealUtils.setupSwipeActions(i),i.off("ojdefaultaction"),i.on("ojdefaultaction",function(){T.handleDefaultAction(n)})})},T.handleDestroy=function(){o("#listview").find(".item-marker").each(function(t){var n=o(this).find(".oj-offcanvas-start").first(),a=o(this).find(".oj-offcanvas-end").first();e.SwipeToRevealUtils.tearDownSwipeActions(n),e.SwipeToRevealUtils.tearDownSwipeActions(a)})},T.handleMenuBeforeOpen=function(e,t){var n=e.originalEvent.target,a=o("#listview").ojListView("getContextByNode",n);null!=a?T.currentItem=o("#"+a.key):T.currentItem=null},T.handleMenuItemSelect=function(e,t){var o=t.item.prop("id");console.log("id = "+o),"cancel"==o?T.handleCancel():"complete"==o||"default"==o?T.handleComplete():"delete"==o?T.handleDelete():"follow"==o&&T.handleFollow()},T.closeToolbar=function(t,o){var n="#"+t+"_toolbar_"+o.prop("id"),a={displayMode:"push",selector:n};e.OffcanvasUtils.close(a)},T.handleAction=function(e,n,a){if(null!=a&&(T.currentItem=o(a.target).closest(".item-marker"),"default"!=n&&T.closeToolbar(e,T.currentItem)),null!=T.currentItem){console.log("Handle "+n+" action on: "+T.currentItem.prop("id"));var i={};"cancel"==n?i={VISITATION_ID:T.currentItem.prop("id"),DESCRIPTION:"",STATUS:"CANCEL"}:"follow"==n?i={VISITATION_ID:T.currentItem.prop("id"),DESCRIPTION:"",STATUS:"FOLLOW_UP"}:"complete"!=n&&"default"!=n||(i={VISITATION_ID:T.currentItem.prop("id"),DESCRIPTION:"",STATUS:"COMPLETE"});var s=u(i);console.log("payload = "+t.toJS(s))}},this.handleRead=function(e,t){T.handleAction("first","read",t)},this.handleCancel=function(e,t){T.handleAction("second","cancel",t)},this.handleFollow=function(e,t){T.handleAction("second","follow",t)},this.handleComplete=function(e,t){T.handleAction("second","complete",t)},this.handleDelete=function(e,t){T.handleAction("second","delete",t),T.remove(T.currentItem)},this.handleDefaultAction=function(e){T.currentItem=e,T.handleAction("second","default")},this.remove=function(t){var o=t.find(".oj-offcanvas-start").first(),n=t.find(".oj-offcanvas-end").first();e.SwipeToRevealUtils.tearDownSwipeActions(o),e.SwipeToRevealUtils.tearDownSwipeActions(n),T.allVisitations.remove(function(e){return e.id==t.prop("id")})},T.onPageReady=function(){try{e.PullToRefreshUtils.setupPullToRefresh("#listviewContainer",function(){var e=new Promise(function(e,t){T.onClearSearchText(),f(),setTimeout(function(){e()},3e3)});return e},{primaryText:T.lng_primaryText,secondaryText:T.lng_secondaryText})}catch(e){console.error(e)}},o(document).ready(function(){e.PullToRefreshUtils.setupPullToRefresh("#listviewContainer",function(){var e=new Promise(function(e,t){T.onClearSearchText(),f(),setTimeout(function(){e()},3e3)});return e},{primaryText:T.lng_primaryText,secondaryText:T.lng_secondaryText}),o("#listview").on({ojdestroy:function(){e.PullToRefreshUtils.tearDownPullToRefresh("#listviewContainer")}})})}var c;return c={selector:"#searchCanvas",edge:"top",displayMode:"push",size:"63px",modality:"modeless",autoDismiss:"none"},t.bindingHandlers.searchCanvas={init:function(o,n,a){t.utils.domNodeDisposal.addDisposeCallback(o,function(){o&&e.OffcanvasUtils.close(c)})}},new l});