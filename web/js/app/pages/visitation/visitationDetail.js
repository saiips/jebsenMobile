define(["ojs/ojcore","knockout","jquery","appController","pages/visitation/visitationService","util/appui","pages/common/constant","util/commonhelper","ojs/ojrouter","ojs/ojknockout","ojs/ojinputtext","ojs/ojbutton","ojs/ojdatetimepicker","ojs/ojtimezonedata","ojs/ojinputnumber","ojs/ojselectcombobox","ojs/ojnavigationlist","promise"],function(t,e,o,s,i,a,r,n){function l(){function o(){var o=s.moduleConfig.params.rootContext.selVisitation;console.log("data = "+e.toJSON(o)),c.id(o.ACTIVITY_ID),c.subject(o.SUBJECT),c.person(o.VISIT_PERSON),c.purpose(o.PURPOSE),c.outletName(o.OUTLET_NAME),c.location(o.LOCATION),c.start(o.START_DATE),c.end(o.END_DATE),c.description(o.DESCRIPTION),c.status(o.STATUS),c.minStartDate(o.START_DATE),c.minEndDate(o.END_DATE);var i=t.Translations.getTranslatedString;e.utils.arrayForEach(r.VISITATION_STATUS_LIST,function(t){c.availableStatus.push(e.toJS({value:t.value,label:i(t.label)}))})}function n(){var t=c.outletName();e.utils.unwrapObservable(c.large())||t.length>r.TITLE_LENGTH&&(t=t.substring(0,r.TITLE_LENGTH)+"..."),c.headerTitle(t)}function l(){var t=s.moduleConfig.params.rootContext.userProfile,o=s.moduleConfig.params.rootContext.selCustomerProfile;console.log("customerProfile = "+e.toJSON(o));var i=c.id(),a=c.description(),r=c.status();Array.isArray(r)&&(r=r[0]);var n=JSON.stringify({InputUpdateVisitation:{HeaderInfo:{UserID:t.username,UserRole:t.salesRole,CallerID:""},ACTIVITY_ID:i,DESCRIPTION:a,STATUS:r}});return n}function u(){var e=t.Translations.getTranslatedString;c.lng_overview=e("ssa.visitationList.overview"),c.lng_visitPerson=e("ssa.visitationList.visitPerson"),c.lng_purpose=e("ssa.visitationList.purpose"),c.lng_subject=e("ssa.visitationList.subject"),c.lng_start=e("ssa.visitationList.start"),c.lng_end=e("ssa.visitationList.end"),c.lng_status=e("ssa.visitationList.status"),c.lng_description=e("ssa.visitationList.description"),c.lng_location=e("ssa.visitationList.location"),c.lng_confirm=e("ssa.visitationList.confirmCreate"),c.lng_updateSuccess=e("ssa.msg.info.recordSaved"),c.lng_error_00032=e("ssa.msg.error.ERROR_00032")}var c=this;console.log("VisitationDetailViewModel"),c.router=s.router,c.id=e.observable(),c.subject=e.observable(),c.person=e.observable(),c.purpose=e.observable(),c.start=e.observable(),c.end=e.observable(),c.outletName=e.observable(),c.description=e.observable(),c.location=e.observable(),c.status=e.observable(),c.headerTitle=e.observable(),c.minStartDate=e.observable(),c.minEndDate=e.observable(),c.availableStatus=e.observableArray(),c.statusDesc=e.computed(function(){var t=c.status();return c.status()==r.VISITATION_STATUS_NOT_STARTED?t="NOT STARTED":c.status()==r.VISITATION_STATUS_FOLLOW_UP?t="FOLLOW-UP":c.status()==r.VISITATION_STATUS_IN_PROGRESS?t="IN PROGRESS":c.status()==r.VISITATION_STATUS_ON_HOLD&&(t="ON HOLD"),t}),c.dataFormat=e.observable("yyyy/MM/dd HH:mm"),c.dateConverter=e.observable(t.Validation.converterFactory(t.ConverterFactory.CONVERTER_TYPE_DATETIME).createConverter({pattern:c.dataFormat()})),c.large=e.computed(function(){var e=t.ResponsiveUtils.getFrameworkQuery(t.ResponsiveUtils.FRAMEWORK_QUERY_KEY.LG_UP);return t.ResponsiveKnockoutUtils.createMediaQueryObservable(e)}),c.handleActivated=function(e){var s=e.valueAccessor().params.ojRouter.parentRouter,i=s.getChildRouter("visitationDetail");return i||(i=s.createChildRouter("visitationDetail")),c.router=i.configure(function(e){if(e){var o=new t.RouterState(e,{value:e,enter:function(){console.log("visitationDetail.js stateId="+e)}});return o}}),u(),o(),n(),t.Router.sync()},c.update=function(t,o){if(confirm(c.lng_confirm)){console.log("update the visitation record");var r=l();console.log("payload = "+e.toJS(r)),a.showBusy(),i.updateVisitationMessage(r).done(function(t,o){if(console.log("raw data = "+e.toJSON(t)),a.hideBusy(),t&&200==o.status){var i=t.outputUpdateVisitation,r=i.returnStatus;"S"!=r?a.showMessageBox(c.lng_error_00032):(a.showMessageBox(c.lng_updateSuccess),s.moduleConfig.params.rootContext.isRefreshVisitation=!0,s.router.go("visitation"))}}).fail(function(t,e){console.log("update visitation failed"),a.hideBusy(),a.showMessageBox(c.lng_error_00032)})}},c.goBack=function(){s.go("visitation")},c.dispose=function(t){c.router.dispose()}}return e.bindingHandlers.winsize={init:function(t,e,s,i,a){o(window).resize(function(){i.screenWidth(o(window).width()),i.screenHeight(o(window).height())})}},e.bindingHandlers.currency={symbol:e.observable("$"),update:function(t,o,s){return e.bindingHandlers.text.update(t,function(){var t=+(e.utils.unwrapObservable(o())||0),i=e.utils.unwrapObservable(void 0===s().symbol?s().sybmol:"$");return i+t.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")})}},e.bindingHandlers.readOnly={update:function(t,o){var s=e.utils.unwrapObservable(o());s?t.setAttribute("readOnly",!0):t.removeAttribute("readOnly")}},l});