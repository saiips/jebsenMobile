define(["ojs/ojcore","knockout","jquery","appController","pages/visitation/visitationService","util/appui","pages/common/constant","util/commonhelper","ojs/ojrouter","ojs/ojknockout","ojs/ojinputtext","ojs/ojbutton","ojs/ojdatetimepicker","ojs/ojtimezonedata","ojs/ojinputnumber","ojs/ojselectcombobox","ojs/ojnavigationlist","promise"],function(e,t,s,r,o,a,n,i){function l(){function s(){var s=r.moduleConfig.params.rootContext.selCustomerProfile;v.outletName(t.utils.unwrapObservable(s.outletName)),v.location(t.utils.unwrapObservable(s.billToAddress)),v.status(n.VISITATION_STATUS_DEFAULT),v.minStartDate(i.getClientCurrentDate("YYYY-MM-DD")),v.minEndDate(i.getClientCurrentDate("YYYY-MM-DD")),v.start(i.getClientCurrentDate("YYYY-MM-DDTHH:mm:ss"));var o=moment(v.start(),"YYYY-MM-DDTHH:mm:ss").add(1,"hours").format("YYYY-MM-DDTHH:mm:ss");v.end(o),v.start.subscribe(function(e){var t=v.end(),s=(moment(t,"YYYY-MM-DDTHH:mm:ss").format("YYYY-MM-DD"),moment(t,"YYYY-MM-DDTHH:mm:ss").format("HH:mm:ss")),r=moment(e,"YYYY-MM-DDTHH:mm:ss").format("YYYY-MM-DD"),o=moment(e,"YYYY-MM-DDTHH:mm:ss").format("HH:mm:ss");o>s?v.end(r+"T"+o):v.end(r+"T"+s)}),v.end.subscribe(function(e){var t=moment(e,"YYYY-MM-DDTHH:mm:ss").format("YYYY-MM-DD"),s=moment(e,"YYYY-MM-DDTHH:mm:ss").format("HH:mm:ss"),r=v.start(),o=(moment(r,"YYYY-MM-DDTHH:mm:ss").format("YYYY-MM-DD"),moment(r,"YYYY-MM-DDTHH:mm:ss").format("HH:mm:ss"));o>s?v.start(t+"T"+s):v.start(t+"T"+o)});var a=e.Translations.getTranslatedString;t.utils.arrayForEach(n.VISITATION_STATUS_LIST,function(e){v.availableStatus.push(t.toJS({value:e.value,label:a(e.label)}))})}function l(){var e=t.utils.unwrapObservable(v.outletName);t.utils.unwrapObservable(v.large())||e.length>n.TITLE_LENGTH&&(e=e.substring(0,n.TITLE_LENGTH)+"..."),v.headerTitle(e)}function u(){var e=r.moduleConfig.params.rootContext.userProfile,s=r.moduleConfig.params.rootContext.selCustomerProfile;console.log("customerProfile = "+t.toJSON(s));var o=null,a=null;v.start()&&(o=i.formatStrDateToISO(v.start(),"YYYY-MM-DDTHH:mm:ss","YYYY-MM-DDTHH:mm:ssZ")),v.end()&&(a=i.formatStrDateToISO(v.end(),"YYYY-MM-DDTHH:mm:ss","YYYY-MM-DDTHH:mm:ssZ"));var n=v.subject(),l=v.purpose();Array.isArray(l)&&(l=l[0]);var u=v.description();u||(u="");var m=v.person(),c=v.status();Array.isArray(c)&&(c=c[0]);var d=JSON.stringify({InputCreateVisitation:{HeaderInfo:{UserID:e.username,UserRole:e.salesRole,CallerID:""},P_ORG_ID:e.orgUnitId,P_SALESREP_ID:e.erpSalesId,ACCOUNT_NUMBER:t.utils.unwrapObservable(s.accountNumber),SHIP_TO_SITE_ID:t.utils.unwrapObservable(s.shipToSiteId),SUBJECT:n,PURPOSE:l,START_DATE:o,END_DATE:a,DESCRIPTION:u,STATUS:c,VISIT_PERSON:m}});return d}function m(){var t=e.Translations.getTranslatedString;v.lng_overview=t("ssa.visitationList.overview"),v.lng_visitPerson=t("ssa.visitationList.visitPerson"),v.lng_purpose=t("ssa.visitationList.purpose"),v.lng_subject=t("ssa.visitationList.subject"),v.lng_start=t("ssa.visitationList.start"),v.lng_end=t("ssa.visitationList.end"),v.lng_description=t("ssa.visitationList.description"),v.lng_location=t("ssa.visitationList.location"),v.lng_confirm=t("ssa.visitationList.confirmCreate"),v.lng_createSuccess=t("ssa.msg.info.visitationCreated"),v.lng_error_00033=t("ssa.msg.error.ERROR_00033"),v.lng_error_00034=t("ssa.msg.error.ERROR_00034"),v.lng_error_00035=t("ssa.msg.error.ERROR_00035"),v.lng_error_00036=t("ssa.msg.error.ERROR_00036")}var v=this;console.log("NewVisitationViewModel"),v.router=r.router;var c=r.moduleConfig.params.rootContext.userProfile;r.populateDefaultNavPath(c),v.navDataSource=r.navDataSource,v.navChangeHandler=r.navChangeHandler,v.navStateId=t.observable(),v.subject=t.observable(),v.person=t.observable(),v.purpose=t.observable(),v.availablePurpose=t.observableArray(n.VISITATION_PURPOSE_LIST),v.start=t.observable(),v.end=t.observable(),v.outletName=t.observable(),v.description=t.observable(),v.location=t.observable(),v.status=t.observable(),v.headerTitle=t.observable(),v.minStartDate=t.observable(),v.minEndDate=t.observable(),v.availableStatus=t.observableArray(),v.statusDesc=t.computed(function(){var e=v.status();return v.status()==n.VISITATION_STATUS_NOT_STARTED?e="NOT STARTED":v.status()==n.VISITATION_STATUS_FOLLOW_UP?e="FOLLOW-UP":v.status()==n.VISITATION_STATUS_IN_PROGRESS?e="IN PROGRESS":v.status()==n.VISITATION_STATUS_ON_HOLD&&(e="ON HOLD"),e}),v.dataFormat=t.observable("yyyy/MM/dd HH:mm"),v.dateConverter=t.observable(e.Validation.converterFactory(e.ConverterFactory.CONVERTER_TYPE_DATETIME).createConverter({pattern:v.dataFormat()})),v.large=t.computed(function(){var t=e.ResponsiveUtils.getFrameworkQuery(e.ResponsiveUtils.FRAMEWORK_QUERY_KEY.LG_UP);return e.ResponsiveKnockoutUtils.createMediaQueryObservable(t)}),v.handleActivated=function(t){var o=t.valueAccessor().params.ojRouter.parentRouter,a=o.getChildRouter("visitationDetail");return a||(a=o.createChildRouter("visitationDetail")),v.router=a.configure(function(t){if(t){var s=new e.RouterState(t,{value:t,enter:function(){console.log("visitationDetail.js stateId="+t)}});return s}}),m(),s(),l(),v.navStateId(r.moduleConfig.params.rootContext.navStateId),e.Router.sync()},v.update=function(e,s){if(confirm(v.lng_confirm)){if(!v.subject())return void a.showMessageBox(v.lng_error_00034);if(!v.person())return void a.showMessageBox(v.lng_error_00035);if(!v.purpose())return void a.showMessageBox(v.lng_error_00036);console.log("create a new visitation record");var n=u();console.log("payload = "+t.toJS(n)),a.showBusy(),o.createVisitationMessage(n).done(function(e,s){if(console.log("raw data = "+t.toJSON(e)),a.hideBusy(),e&&200==s.status){var o=e.outputCreateVisitation,n=o.returnStatus;"S"!=n?a.showMessageBox(v.lng_error_00033):(a.showMessageBox(v.lng_createSuccess),r.moduleConfig.params.rootContext.isRefreshVisitation=!0,r.router.go("visitation"))}}).fail(function(e,t){console.log("create visitation failed"),a.hideBusy(),a.showMessageBox(v.lng_error_00033)})}},v.goBack=function(){r.go("visitation")},v.dispose=function(e){v.router.dispose()}}return t.bindingHandlers.winsize={init:function(e,t,r,o,a){s(window).resize(function(){o.screenWidth(s(window).width()),o.screenHeight(s(window).height())})}},t.bindingHandlers.currency={symbol:t.observable("$"),update:function(e,s,r){return t.bindingHandlers.text.update(e,function(){var e=+(t.utils.unwrapObservable(s())||0),o=t.utils.unwrapObservable(void 0===r().symbol?r().sybmol:"$");return o+e.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")})}},t.bindingHandlers.readOnly={update:function(e,s){var r=t.utils.unwrapObservable(s());r?e.setAttribute("readOnly",!0):e.removeAttribute("readOnly")}},l});